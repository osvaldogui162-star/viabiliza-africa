<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Viabiliza+África</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#667eea',
                        secondary: '#764ba2'
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Verificar se o Tailwind carregou corretamente após um pequeno delay
        setTimeout(function() {
            if (typeof tailwind === 'undefined') {
                console.warn('Tailwind CSS pode não ter carregado corretamente');
            }
        }, 100);
    </script>
    <script> window.FontAwesomeConfig = { autoReplaceSvg: 'nest'};</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* Fallback CSS para garantir que a página funcione mesmo se o Tailwind não carregar */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            overflow-x: hidden;
            background-color: #f9fafb;
            color: #111827;
            line-height: 1.5;
        }
        
        ::-webkit-scrollbar { 
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .gradient-card { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .gradient-purple { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .gradient-orange { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }
        .gradient-blue { background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); }
        .gradient-green { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); }
        .dark-gradient { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); }
        .submenu { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .submenu.active { max-height: 2000px; }
        .splash-screen { animation: fadeOut 2.5s forwards; }
        @keyframes fadeOut { 
            0% { opacity: 1; } 
            90% { opacity: 1; } 
            100% { opacity: 0; visibility: hidden; } 
        }
        @keyframes slideIn { 
            0% { transform: translateY(30px); opacity: 0; } 
            100% { transform: translateY(0); opacity: 1; } 
        }
        @keyframes fadeIn { 
            0% { opacity: 0; } 
            100% { opacity: 1; } 
        }
        @keyframes slideRight { 
            0% { transform: translateX(-20px); opacity: 0; } 
            100% { transform: translateX(0); opacity: 1; } 
        }
        .slide-in { animation: slideIn 0.5s ease forwards; }
        .fade-in { animation: fadeIn 0.6s ease forwards; }
        .slide-right { animation: slideRight 0.4s ease forwards; }
        .menu-item.active .menu-btn {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            transform: scale(1.02);
        }
        .menu-item.active .submenu {
            max-height: 2000px;
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button {
            position: relative;
            transition: all 0.3s ease;
        }
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
        }
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }
        .sidebar-item {
            transition: all 0.3s ease;
        }
        .sidebar-item:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateX(4px);
        }
        .notification-badge {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .search-focus:focus {
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        .spreadsheet-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .spreadsheet-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .spreadsheet-header h2,
        .spreadsheet-header p {
            color: white;
        }
        .spreadsheet-header .text-gray-700,
        .spreadsheet-header .text-gray-300 {
            color: white !important;
        }
        .spreadsheet-header button i,
        .spreadsheet-header .fas,
        .spreadsheet-header .fa {
            color: white !important;
        }
        .spreadsheet-header #btn-export-excel,
        .spreadsheet-header #btn-print,
        .spreadsheet-header #btn-help {
            color: white !important;
        }
        .spreadsheet-header #btn-export-excel i,
        .spreadsheet-header #btn-print i,
        .spreadsheet-header #btn-help i {
            color: white !important;
        }
        .spreadsheet-toolbar {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 8px 16px;
            display: flex !important;
            gap: 8px;
            flex-wrap: wrap;
            visibility: visible !important;
        }
        .spreadsheet-toolbar button {
            display: inline-flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        .spreadsheet-toolbar button i {
            color: inherit !important;
        }
        .spreadsheet-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .spreadsheet-table th {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .spreadsheet-table td {
            border: 1px solid #dee2e6;
            padding: 6px 10px;
            min-width: 120px;
        }
        .spreadsheet-table td:first-child {
            background: #f8f9fa;
            font-weight: 500;
            min-width: 300px;
            position: sticky;
            left: 0;
            z-index: 5;
        }
        .spreadsheet-table td.editable {
            cursor: cell;
            background: white;
        }
        .spreadsheet-table td.editable:hover {
            background: #e7f3ff;
        }
        .spreadsheet-table td.editing {
            background: #fff3cd;
            outline: 2px solid #ffc107;
        }
        .spreadsheet-table td.calculated {
            background: #f0f0f0;
            color: #666;
            font-style: italic;
            cursor: not-allowed;
        }
        .spreadsheet-table td.calculated:hover {
            background: #e0e0e0;
        }
        .dark .spreadsheet-table td.calculated {
            background: #2d3748;
            color: #a0aec0;
        }
        .dark .spreadsheet-table td.calculated:hover {
            background: #374151;
        }
        .spreadsheet-table input {
            width: 100%;
            border: none;
            background: transparent;
            padding: 4px;
            font-size: 13px;
        }
        .spreadsheet-table input:focus {
            outline: none;
        }
        .dark .spreadsheet-container {
            background: #1f2937;
        }
        .dark .spreadsheet-toolbar {
            background: #374151;
            border-color: #4b5563;
        }
        .dark .spreadsheet-table th {
            background: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }
        .dark .spreadsheet-table td {
            border-color: #4b5563;
            color: #f9fafb;
        }
        .dark .spreadsheet-table td:first-child {
            background: #374151;
        }
        .dark .spreadsheet-table td.editable:hover {
            background: #1e3a5f;
        }
        .dark .spreadsheet-table td.editing {
            background: #78350f;
        }
        .spreadsheet-content {
            overflow-x: auto;
            overflow-y: auto;
            max-height: calc(100vh - 300px);
        }
        
        /* Equipment row styles */
        .equipment-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .equipment-row:hover:not(.empty-row) {
            background-color: #F5F5F5 !important;
        }
        
        .equipment-row.selected {
            background-color: #E3F2FD !important;
        }
        
        .equipment-name-cell {
            background-color: #E3F2FD !important;
            font-weight: 500;
        }
        
        .equipment-value-cell:focus {
            outline: 2px solid #2196F3;
            outline-offset: -2px;
            background-color: #FFF !important;
        }
        
        .equipment-row.empty-row {
            cursor: default;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">

<!-- Splash Screen -->
<div id="splash-screen" class="splash-screen fixed inset-0 z-50 flex items-center justify-center gradient-bg">
    <div class="text-center text-white">
        <div class="mb-8">
            <i class="fas fa-chart-line text-6xl mb-4 animate-bounce"></i>
            <h1 class="text-4xl font-bold mb-2">Viabiliza+África</h1>
            <p class="text-xl opacity-90">O melhor Sistema de Negócio de África</p>
        </div>
        <div class="w-16 h-1 bg-white/30 rounded-full mx-auto overflow-hidden">
            <div class="h-full bg-white rounded-full animate-pulse" style="animation: loading 3s ease-in-out;"></div>
        </div>
    </div>
</div>

<!-- Main Dashboard -->
<div id="dashboard" class="opacity-0 transition-opacity duration-1000">
    <!-- Header -->
    <header id="header" class="bg-white dark:bg-gray-800 shadow-md border-b border-gray-200 dark:border-gray-700 sticky top-0 z-40">
        <div class="flex items-center justify-between px-6 py-4">
            <div class="flex items-center space-x-6">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 gradient-bg rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-chart-line text-white text-xl"></i>
                    </div>
                    <div>
                    <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Viabiliza+África</h1>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Sistema de Gestão Estratégica</p>
                </div>
            </div>
            
                <!-- Search Bar -->
                <div class="hidden md:flex items-center relative">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Buscar projetos, relatórios..." 
                               class="w-80 pl-10 pr-4 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 border-0 text-sm focus:outline-none focus:ring-2 focus:ring-primary search-focus transition-all">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center space-x-3">
                <!-- Search Icon for Mobile -->
                <button id="mobileSearchBtn" class="md:hidden p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    <i class="fas fa-search text-gray-600 dark:text-gray-300"></i>
                </button>

                <!-- Notifications -->
                <div class="relative">
                    <button id="notifBtn" class="relative p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                        <i class="fas fa-bell text-gray-600 dark:text-gray-300"></i>
                        <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full notification-badge"></span>
                    </button>
                    <div id="notifMenu" class="absolute right-0 mt-2 w-80 bg-white dark:bg-gray-800 rounded-xl shadow-2xl border dark:border-gray-700 hidden overflow-hidden">
                        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="font-semibold text-gray-800 dark:text-white">Notificações</h3>
                        </div>
                        <div class="max-h-96 overflow-y-auto">
                            <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-700 border-b border-gray-100 dark:border-gray-700 cursor-pointer">
                                <p class="text-sm font-medium text-gray-800 dark:text-white">Novo projeto criado</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Há 5 minutos</p>
                            </div>
                            <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-700 border-b border-gray-100 dark:border-gray-700 cursor-pointer">
                                <p class="text-sm font-medium text-gray-800 dark:text-white">Relatório financeiro atualizado</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Há 1 hora</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Language Selector -->
                <div class="relative">
                    <button id="langBtn" class="flex items-center space-x-2 px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                        <img src="https://flagcdn.com/w20/pt.png" alt="PT" class="w-5 h-3 rounded">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300 hidden sm:inline">PT</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <div id="langMenu" class="absolute right-0 mt-2 w-40 bg-white dark:bg-gray-800 rounded-xl shadow-xl border dark:border-gray-700 hidden overflow-hidden">
                        <a href="#" class="flex items-center space-x-3 px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            <img src="https://flagcdn.com/w20/pt.png" alt="PT" class="w-5 h-3 rounded">
                            <span class="text-sm font-medium">Português</span>
                        </a>
                        <a href="#" class="flex items-center space-x-3 px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            <img src="https://flagcdn.com/w20/us.png" alt="EN" class="w-5 h-3 rounded">
                            <span class="text-sm font-medium">English</span>
                        </a>
                        <a href="#" class="flex items-center space-x-3 px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            <img src="https://flagcdn.com/w20/fr.png" alt="FR" class="w-5 h-3 rounded">
                            <span class="text-sm font-medium">Français</span>
                        </a>
                    </div>
                </div>

                <!-- Theme Toggle -->
                <button id="themeToggle" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    <i class="fas fa-sun text-yellow-500 dark:hidden"></i>
                    <i class="fas fa-moon text-blue-400 hidden dark:block"></i>
                </button>

                <!-- Profile -->
                <div class="flex items-center space-x-3 pl-3 border-l border-gray-200 dark:border-gray-700">
                    <div class="text-right hidden sm:block">
                        <p class="text-sm font-semibold text-gray-700 dark:text-gray-300">Admin User</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">admin@viabiliza.com</p>
                    </div>
                    <div class="relative">
                        <img src="https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-1.jpg" alt="Profile" 
                             class="w-10 h-10 rounded-full border-2 border-primary cursor-pointer hover:ring-2 ring-primary transition-all">
                        <div id="profileMenu" class="absolute right-0 mt-2 w-56 bg-white dark:bg-gray-800 rounded-xl shadow-xl border dark:border-gray-700 hidden overflow-hidden">
                            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                                <p class="font-semibold text-gray-800 dark:text-white">Admin User</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">admin@viabiliza.com</p>
                            </div>
                            <a href="#" class="flex items-center space-x-3 px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                <i class="fas fa-user text-gray-600 dark:text-gray-400"></i>
                                <span class="text-sm">Meu Perfil</span>
                            </a>
                            <a href="#" class="flex items-center space-x-3 px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                <i class="fas fa-cog text-gray-600 dark:text-gray-400"></i>
                                <span class="text-sm">Configurações</span>
                            </a>
                            <a href="#" class="flex items-center space-x-3 px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-red-600">
                                <i class="fas fa-sign-out-alt"></i>
                                <span class="text-sm">Sair</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="flex h-[calc(100vh-80px)]">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-80 bg-white dark:bg-gray-800 shadow-xl border-r border-gray-200 dark:border-gray-700 overflow-y-auto overflow-x-hidden">
            <div class="p-5">
                <!-- Quick Actions -->
                <div class="mb-6 p-4 bg-gradient-to-br from-primary/10 to-secondary/10 dark:from-primary/20 dark:to-secondary/20 rounded-xl border border-primary/20" style="display: block !important;">
                    <h3 class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider mb-3">Ações Rápidas</h3>
                    <div class="flex flex-col space-y-2">
                        <button id="btn-novo-projeto" class="w-full flex items-center justify-center space-x-2 px-4 py-2.5 text-white rounded-lg hover:opacity-90 transition-all hover:scale-[1.02] shadow-md font-medium" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; display: flex !important; visibility: visible !important;">
                            <i class="fas fa-plus text-sm" style="color: white !important;"></i>
                            <span class="text-sm font-medium" style="color: white !important;">Criar Novo Projeto</span>
                        </button>
                        <button class="w-full flex items-center space-x-2 px-3 py-2 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-all">
                            <i class="fas fa-file-export text-sm"></i>
                            <span class="text-sm font-medium">Exportar</span>
                        </button>
                    </div>
                </div>

                <nav class="space-y-3">
                    <!-- Plano Financeiro -->
                    <div class="menu-item">
                        <button class="menu-btn w-full flex items-center justify-between p-4 rounded-xl gradient-orange text-white hover:opacity-90 transition-all shadow-lg hover:shadow-xl">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-chart-pie text-sm"></i>
                            </div>
                                <span class="font-semibold">Plano Financeiro</span>
                            </div>
                            <i class="fas fa-chevron-down transition-transform duration-300 text-sm"></i>
                        </button>
                        <div class="submenu mt-2 ml-2 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-4">
                            <a href="#" data-tab="pressupostos" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Pressupostos do Projeto
                            </a>
                            <!-- Mapa de Investimentos (com submenus) -->
                            <div class="menu-item">
                                <button class="menu-btn w-full flex items-center justify-between p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-chevron-right text-xs transition-transform duration-300"></i>
                                        <span>Mapa de Investimentos</span>
                                    </div>
                                </button>
                                <div class="submenu ml-4 mt-1 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-3 hidden">
                                    <!-- 1. Resumo dos Investimentos -->
                                    <a href="#" data-tab="investimento-resumo" class="sidebar-item block p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                        <i class="fas fa-file-alt text-xs mr-2"></i>1. Resumo dos Investimentos
                                    </a>
                                    
                                    <!-- 2. Ativos Tangíveis (submenu) -->
                                    <div class="menu-item">
                                        <button class="menu-btn w-full flex items-center justify-between p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                            <div class="flex items-center space-x-2">
                                                <i class="fas fa-chevron-right text-xs transition-transform duration-300"></i>
                                                <span>2. Ativos Tangíveis</span>
                                            </div>
                                        </button>
                                        <div class="submenu ml-4 mt-1 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-3 hidden">
                                            <a href="#" data-tab="ativos-tangiveis-terrenos" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Terrenos e recursos naturais
                                            </a>
                                            <a href="#" data-tab="ativos-tangiveis-edificios" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Edifícios e outras construções
                                            </a>
                                            <a href="#" data-tab="ativos-tangiveis-equipamento-basico" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Equipamento Básico
                                            </a>
                                            <a href="#" data-tab="ativos-tangiveis-equipamento-transporte" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Equipamento Transporte
                                            </a>
                                            <a href="#" data-tab="ativos-tangiveis-equipamento-administrativo" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Equipamento Administrativo
                                            </a>
                                            <a href="#" data-tab="ativos-tangiveis-equipamentos-biologicos" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Equipamentos Biológicos
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <!-- 3. IVA (submenu) -->
                                    <div class="menu-item">
                                        <button class="menu-btn w-full flex items-center justify-between p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                            <div class="flex items-center space-x-2">
                                                <i class="fas fa-chevron-right text-xs transition-transform duration-300"></i>
                                                <span>3. IVA</span>
                                            </div>
                                        </button>
                                        <div class="submenu ml-4 mt-1 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-3 hidden">
                                            <a href="#" data-tab="iva-edificios" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Edifícios e outras construções
                                            </a>
                                            <a href="#" data-tab="iva-equipamento-basico" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Equipamento Básico
                                            </a>
                                            <a href="#" data-tab="iva-equipamento-transporte" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Equipamento Transporte
                                            </a>
                                            <a href="#" data-tab="iva-equipamento-administrativo" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Equipamento Administrativo
                                            </a>
                                            <a href="#" data-tab="iva-equipamentos-biologicos" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Equipamentos Biológicos
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <!-- 4. Ativos Intangíveis (submenu) -->
                                    <div class="menu-item">
                                        <button class="menu-btn w-full flex items-center justify-between p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                            <div class="flex items-center space-x-2">
                                                <i class="fas fa-chevron-right text-xs transition-transform duration-300"></i>
                                                <span>4. Ativos Intangíveis</span>
                                            </div>
                                        </button>
                                        <div class="submenu ml-4 mt-1 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-3 hidden">
                                            <a href="#" data-tab="ativos-intangiveis-goodwill" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Goodwill
                                            </a>
                                            <a href="#" data-tab="ativos-intangiveis-projetos-desenvolvimento" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Projetos de desenvolvimento
                                            </a>
                                            <a href="#" data-tab="ativos-intangiveis-programas-computador" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Programas de computador
                                            </a>
                                            <a href="#" data-tab="ativos-intangiveis-propriedade-industrial" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Propriedade industrial
                                            </a>
                                            <a href="#" data-tab="ativos-intangiveis-outros" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Outros ativos fixos intangíveis
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Depreciações e Amortizações do Investimento (com submenus) -->
                            <div class="menu-item">
                                <button class="menu-btn w-full flex items-center justify-between p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-chevron-right text-xs transition-transform duration-300"></i>
                                        <span>Depreciações e Amortizações do Investimento</span>
                                    </div>
                                </button>
                                <div class="submenu ml-4 mt-1 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-3 hidden">
                                    <!-- 1. Resumo das Depreciações e Amortizações -->
                                    <a href="#" data-tab="depreciacoes-resumo" class="sidebar-item block p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                        <i class="fas fa-file-alt text-xs mr-2"></i>1. Resumo das Depreciações e Amortizações
                                    </a>
                                    
                                    <!-- 2. Ativos Fixos Tangíveis (submenu) -->
                                    <div class="menu-item">
                                        <button class="menu-btn w-full flex items-center justify-between p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                            <div class="flex items-center space-x-2">
                                                <i class="fas fa-chevron-right text-xs transition-transform duration-300"></i>
                                                <span>2. Ativos Fixos Tangíveis</span>
                                            </div>
                                        </button>
                                        <div class="submenu ml-4 mt-1 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-3 hidden">
                                            <a href="#" data-tab="depreciacoes-edificios" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Edifícios e outras construções
                                            </a>
                                            <a href="#" data-tab="depreciacoes-equipamento-basico" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Equipamento Básico
                                            </a>
                                            <a href="#" data-tab="depreciacoes-equipamento-transporte" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Equipamento Transporte
                                            </a>
                                            <a href="#" data-tab="depreciacoes-equipamento-administrativo" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Equipamento Administrativo
                                            </a>
                                            <a href="#" data-tab="depreciacoes-equipamentos-biologicos" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Equipamentos Biológicos
                                            </a>
                                            <a href="#" data-tab="depreciacoes-outros-tangiveis" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Outros ativos fixos tangíveis
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <!-- 3. Ativos Intangíveis (submenu) -->
                                    <div class="menu-item">
                                        <button class="menu-btn w-full flex items-center justify-between p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                            <div class="flex items-center space-x-2">
                                                <i class="fas fa-chevron-right text-xs transition-transform duration-300"></i>
                                                <span>3. Ativos Intangíveis</span>
                                            </div>
                                        </button>
                                        <div class="submenu ml-4 mt-1 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-3 hidden">
                                            <a href="#" data-tab="depreciacoes-goodwill" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Goodwill
                                            </a>
                                            <a href="#" data-tab="depreciacoes-projetos-desenvolvimento" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Projetos de desenvolvimento
                                            </a>
                                            <a href="#" data-tab="depreciacoes-programas-computador" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Programas de computador
                                            </a>
                                            <a href="#" data-tab="depreciacoes-propriedade-industrial" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Propriedade industrial
                                            </a>
                                            <a href="#" data-tab="depreciacoes-outros-intangiveis" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Outros ativos fixos intangíveis
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Rendimentos de Exploração (com submenus) -->
                            <div class="menu-item">
                                <button class="menu-btn w-full flex items-center justify-between p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-chevron-right text-xs transition-transform duration-300"></i>
                                        <span>Rendimentos de Exploração</span>
                                    </div>
                                </button>
                                <div class="submenu ml-4 mt-1 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-3 hidden">
                                    <!-- 1. Resumo da exploração -->
                                    <a href="#" data-tab="rendimentos-resumo" class="sidebar-item block p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                        <i class="fas fa-file-alt text-xs mr-2"></i>1. Resumo da exploração
                                    </a>
                                    
                                    <!-- 2. Resumo da exploração por Mercados -->
                                    <a href="#" data-tab="rendimentos-resumo-mercados" class="sidebar-item block p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                        <i class="fas fa-file-alt text-xs mr-2"></i>2. Resumo da exploração por Mercados
                                    </a>
                                    
                                    <!-- 3. Projeção de Vendas de Produtos (submenu) -->
                                    <div class="menu-item">
                                        <button class="menu-btn w-full flex items-center justify-between p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                            <div class="flex items-center space-x-2">
                                                <i class="fas fa-chevron-right text-xs transition-transform duration-300"></i>
                                                <span>3. Projeção de Vendas de Produtos</span>
                                            </div>
                                        </button>
                                        <div class="submenu ml-4 mt-1 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-3 hidden">
                                            <a href="#" data-tab="vendas-produtos-mercado-1" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Mercado 1
                                            </a>
                                            <a href="#" data-tab="vendas-produtos-mercado-2" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Mercado 2
                                            </a>
                                            <a href="#" data-tab="vendas-produtos-mercado-3" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Mercado 3
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <!-- 4. Projeção de Prestação de Serviços (submenu) -->
                                    <div class="menu-item">
                                        <button class="menu-btn w-full flex items-center justify-between p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                            <div class="flex items-center space-x-2">
                                                <i class="fas fa-chevron-right text-xs transition-transform duration-300"></i>
                                                <span>4. Projeção de Prestação de Serviços</span>
                                            </div>
                                        </button>
                                        <div class="submenu ml-4 mt-1 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-3 hidden">
                                            <a href="#" data-tab="prestacao-servicos-mercado-1" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Mercado 1
                                            </a>
                                            <a href="#" data-tab="prestacao-servicos-mercado-2" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Mercado 2
                                            </a>
                                            <a href="#" data-tab="prestacao-servicos-mercado-3" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Mercado 3
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <!-- 5. Projeção de Vendas de Mercados (submenu) -->
                                    <div class="menu-item">
                                        <button class="menu-btn w-full flex items-center justify-between p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                            <div class="flex items-center space-x-2">
                                                <i class="fas fa-chevron-right text-xs transition-transform duration-300"></i>
                                                <span>5. Projeção de Vendas de Mercados</span>
                                            </div>
                                        </button>
                                        <div class="submenu ml-4 mt-1 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-3 hidden">
                                            <a href="#" data-tab="vendas-mercados-mercado-1" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Mercado 1
                                            </a>
                                            <a href="#" data-tab="vendas-mercados-mercado-2" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Mercado 2
                                            </a>
                                            <a href="#" data-tab="vendas-mercados-mercado-3" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Mercado 3
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <!-- 6. Outros Rendimentos -->
                                    <a href="#" data-tab="outros-rendimentos" class="sidebar-item block p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                        <i class="fas fa-circle text-xs mr-2 opacity-30"></i>6. Outros Rendimentos
                                    </a>
                                    
                                    <!-- 7. IVA (submenu) -->
                                    <div class="menu-item">
                                        <button class="menu-btn w-full flex items-center justify-between p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                            <div class="flex items-center space-x-2">
                                                <i class="fas fa-chevron-right text-xs transition-transform duration-300"></i>
                                                <span>7. IVA</span>
                                            </div>
                                        </button>
                                        <div class="submenu ml-4 mt-1 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-3 hidden">
                                            <!-- IVA venda de Produtos (submenu) -->
                                            <div class="menu-item">
                                                <button class="menu-btn w-full flex items-center justify-between p-2 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                    <div class="flex items-center space-x-2">
                                                        <i class="fas fa-chevron-right text-xs transition-transform duration-300"></i>
                                                        <span>IVA venda de Produtos</span>
                                                    </div>
                                                </button>
                                                <div class="submenu ml-4 mt-1 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-3 hidden">
                                                    <a href="#" data-tab="iva-venda-produtos-mercado-1" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                        <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Mercado 1
                                                    </a>
                                                    <a href="#" data-tab="iva-venda-produtos-mercado-2" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                        <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Mercado 2
                                                    </a>
                                                    <a href="#" data-tab="iva-venda-produtos-mercado-3" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                        <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Mercado 3
                                                    </a>
                                                </div>
                                            </div>
                                            
                                            <!-- IVA Prestação de Serviços (submenu) -->
                                            <div class="menu-item">
                                                <button class="menu-btn w-full flex items-center justify-between p-2 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                    <div class="flex items-center space-x-2">
                                                        <i class="fas fa-chevron-right text-xs transition-transform duration-300"></i>
                                                        <span>IVA Prestação de Serviços</span>
                                                    </div>
                                                </button>
                                                <div class="submenu ml-4 mt-1 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-3 hidden">
                                                    <a href="#" data-tab="iva-prestacao-servicos-mercado-1" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                        <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Mercado 1
                                                    </a>
                                                    <a href="#" data-tab="iva-prestacao-servicos-mercado-2" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                        <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Mercado 2
                                                    </a>
                                                    <a href="#" data-tab="iva-prestacao-servicos-mercado-3" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                        <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Mercado 3
                                                    </a>
                                                </div>
                                            </div>
                                            
                                            <!-- IVA Venda de Mercados (submenu) -->
                                            <div class="menu-item">
                                                <button class="menu-btn w-full flex items-center justify-between p-2 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                    <div class="flex items-center space-x-2">
                                                        <i class="fas fa-chevron-right text-xs transition-transform duration-300"></i>
                                                        <span>IVA Venda de Mercados</span>
                                                    </div>
                                                </button>
                                                <div class="submenu ml-4 mt-1 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-3 hidden">
                                                    <a href="#" data-tab="iva-venda-mercados-mercado-1" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                        <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Mercado 1
                                                    </a>
                                                    <a href="#" data-tab="iva-venda-mercados-mercado-2" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                        <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Mercado 2
                                                    </a>
                                                    <a href="#" data-tab="iva-venda-mercados-mercado-3" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                        <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Mercado 3
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Gastos de Exploração (com submenus) -->
                            <div class="menu-item">
                                <button class="menu-btn w-full flex items-center justify-between p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-chevron-right text-xs transition-transform duration-300"></i>
                                        <span>Gastos de Exploração</span>
                                    </div>
                                </button>
                                <div class="submenu ml-4 mt-1 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-3 hidden">
                                    <!-- 1. Resumo -->
                                    <a href="#" data-tab="gastos-resumo" class="sidebar-item block p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                        <i class="fas fa-file-alt text-xs mr-2"></i>1. Resumo
                                    </a>
                                    
                                    <!-- 2. CMVMC (submenu) -->
                                    <div class="menu-item">
                                        <button class="menu-btn w-full flex items-center justify-between p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                            <div class="flex items-center space-x-2">
                                                <i class="fas fa-chevron-right text-xs transition-transform duration-300"></i>
                                                <span>2. CMVMC</span>
                                            </div>
                                        </button>
                                        <div class="submenu ml-4 mt-1 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-3 hidden">
                                            <!-- Custo de Mercadorias (submenu) -->
                                            <div class="menu-item">
                                                <button class="menu-btn w-full flex items-center justify-between p-2 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                    <div class="flex items-center space-x-2">
                                                        <i class="fas fa-chevron-right text-xs transition-transform duration-300"></i>
                                                        <span>Custo de Mercadorias</span>
                                                    </div>
                                                </button>
                                                <div class="submenu ml-4 mt-1 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-3 hidden">
                                                    <a href="#" data-tab="custo-mercadorias-mercado-1" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                        <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Mercado 1
                                                    </a>
                                                    <a href="#" data-tab="custo-mercadorias-mercado-2" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                        <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Mercado 2
                                                    </a>
                                                    <a href="#" data-tab="custo-mercadorias-mercado-3" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                        <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Mercado 3
                                                    </a>
                                                </div>
                                            </div>
                                            
                                            <!-- Consumo de Matérias Primas -->
                                            <a href="#" data-tab="consumo-materias-primas" class="sidebar-item block p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                                <i class="fas fa-file-alt text-xs mr-2"></i>Consumo de Matérias Primas
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <!-- 3. IVA (submenu) -->
                                    <div class="menu-item">
                                        <button class="menu-btn w-full flex items-center justify-between p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                            <div class="flex items-center space-x-2">
                                                <i class="fas fa-chevron-right text-xs transition-transform duration-300"></i>
                                                <span>3. IVA</span>
                                            </div>
                                        </button>
                                        <div class="submenu ml-4 mt-1 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-3 hidden">
                                            <!-- IVA Compras de Mercadorias (submenu) -->
                                            <div class="menu-item">
                                                <button class="menu-btn w-full flex items-center justify-between p-2 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                    <div class="flex items-center space-x-2">
                                                        <i class="fas fa-chevron-right text-xs transition-transform duration-300"></i>
                                                        <span>IVA Compras de Mercadorias</span>
                                                    </div>
                                                </button>
                                                <div class="submenu ml-4 mt-1 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-3 hidden">
                                                    <a href="#" data-tab="iva-compras-mercadorias-mercado-1" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                        <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Mercado 1
                                                    </a>
                                                    <a href="#" data-tab="iva-compras-mercadorias-mercado-2" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                        <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Mercado 2
                                                    </a>
                                                    <a href="#" data-tab="iva-compras-mercadorias-mercado-3" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                        <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Mercado 3
                                                    </a>
                                                </div>
                                            </div>
                                            
                                            <!-- IVA Compras de Matérias Primas -->
                                            <a href="#" data-tab="iva-compras-materias-primas" class="sidebar-item block p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                                <i class="fas fa-file-alt text-xs mr-2"></i>IVA Compras de Matérias Primas
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Fundo de Maneio (com submenus) -->
                            <div class="menu-item">
                                <button class="menu-btn w-full flex items-center justify-between p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-chevron-right text-xs transition-transform duration-300"></i>
                                        <span>Fundo de Maneio</span>
                                    </div>
                                </button>
                                <div class="submenu ml-4 mt-1 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-3 hidden">
                                    <a href="#" data-tab="variacao-fundo-maneio" class="sidebar-item block p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                        <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Variação de Fundo Maneio
                                    </a>
                                    <a href="#" data-tab="credito-clientes" class="sidebar-item block p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                        <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Crédito concebido a Clientes
                                    </a>
                                    <a href="#" data-tab="necessidades-inventario" class="sidebar-item block p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                        <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Necessidades de Inventário
                                    </a>
                                    <a href="#" data-tab="credito-fornecedores" class="sidebar-item block p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                        <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Crédito obtido de Fornecedores de Mercadorias e FSE
                                    </a>
                                    <a href="#" data-tab="credito-eoep" class="sidebar-item block p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                        <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Crédito concebido/obtido de EOEP
                                    </a>
                                    <a href="#" data-tab="calculo-iva" class="sidebar-item block p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                        <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Cálculo do IVA a pagar ou a receber
                                    </a>
                                </div>
                            </div>
                            <!-- Financiamento do Projeto (com submenus) -->
                            <div class="menu-item">
                                <button class="menu-btn w-full flex items-center justify-between p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-chevron-right text-xs transition-transform duration-300"></i>
                                        <span>Financiamento do Projeto</span>
                                    </div>
                                </button>
                                <div class="submenu ml-4 mt-1 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-3 hidden">
                                    <!-- 1. Origem do financiamento -->
                                    <a href="#" data-tab="origem-financiamento" class="sidebar-item block p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                        <i class="fas fa-file-alt text-xs mr-2"></i>1. Origem do financiamento
                                    </a>
                                    
                                    <!-- 2. Resumo da Dívida (submenu) -->
                                    <div class="menu-item">
                                        <button class="menu-btn w-full flex items-center justify-between p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                            <div class="flex items-center space-x-2">
                                                <i class="fas fa-chevron-right text-xs transition-transform duration-300"></i>
                                                <span>2. Resumo da Dívida</span>
                                            </div>
                                        </button>
                                        <div class="submenu ml-4 mt-1 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-3 hidden">
                                            <a href="#" data-tab="divida-total" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Dívida Total
                                            </a>
                                            <a href="#" data-tab="divida-projeto-historica" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Dívida do Projeto vs Dívida Histórica
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <!-- 3. Planos de Financiamento (submenu) -->
                                    <div class="menu-item">
                                        <button class="menu-btn w-full flex items-center justify-between p-2 text-xs text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                            <div class="flex items-center space-x-2">
                                                <i class="fas fa-chevron-right text-xs transition-transform duration-300"></i>
                                                <span>3. Planos de Financiamento</span>
                                            </div>
                                        </button>
                                        <div class="submenu ml-4 mt-1 space-y-1 border-l-2 border-orange-200 dark:border-orange-800 pl-3 hidden">
                                            <a href="#" data-tab="financiamentos-projeto" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Financiamentos do Projeto
                                            </a>
                                            <a href="#" data-tab="amortizacoes-financiamentos-historicos" class="sidebar-item block p-1.5 text-xs text-gray-500 dark:text-gray-500 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded transition-all">
                                                <i class="fas fa-circle text-xs mr-2 opacity-30"></i>Amortizações de Financiamentos Históricos
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <a href="#" data-tab="tesouraria" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Orçamento de Tesouraria
                            </a>
        <a href="#" data-tab="orcamento-financeiro" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
            <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Orçamento Financeiro
        </a>
                            <a href="#" data-tab="balanco" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Balanço
                            </a>
                            <a href="#" data-tab="resultados" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Demonstração dos Resultados
                            </a>
                            <a href="#" data-tab="cashflow" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Cash-Flows Previsionais
                            </a>
                            <a href="#" data-tab="wacc" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Avaliação WACC
                            </a>
                            <a href="#" data-tab="capm" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Avaliação CAPM
                            </a>
                            <a href="#" data-tab="viabilidade" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Indicadores de Viabilidade
                            </a>
                            <a href="#" data-tab="sensibilidade" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Análise de Sensibilidade
                            </a>
                            <a href="#" data-tab="sintese" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Síntese e Conclusões
        </a>
    </div>
</div>                    <!-- Plano Estratégico -->
                    <div class="menu-item">
                        <button class="menu-btn w-full flex items-center justify-between p-4 rounded-xl gradient-blue text-white hover:opacity-90 transition-all shadow-lg hover:shadow-xl">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-chess-king text-sm"></i>
                            </div>
                                <span class="font-semibold">Plano Estratégico</span>
                            </div>
                            <i class="fas fa-chevron-down transition-transform duration-300 text-sm"></i>
                        </button>
                        <div class="submenu mt-2 ml-2 space-y-1 border-l-2 border-blue-200 dark:border-blue-800 pl-4">
                            <a href="#" data-tab="estrategico" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Enquadramento Estratégico
                            </a>
                            <a href="#" data-tab="stakeholders" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Análise de Stakeholders
                            </a>
                            <a href="#" data-tab="pest" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Análise PEST
                            </a>
                            <a href="#" data-tab="porter" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Forças de Porter
                            </a>
                            <a href="#" data-tab="fatores" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Fatores Críticos de Sucesso
                            </a>
                            <a href="#" data-tab="swot" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>SWOT Estratégica + Matriz Cruzada
                            </a>
                            <a href="#" data-tab="conclusoes" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Conclusões de Diagnóstico
                            </a>
                            <a href="#" data-tab="missao" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Missão (Visão e Valores)
                            </a>
                            <a href="#" data-tab="objetivos" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Objetivos Estratégicos SMART
                            </a>
                            <a href="#" data-tab="opcoes" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Opções Estratégicas (Porter/Ansoff)
                            </a>
                            <a href="#" data-tab="projetos" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Projetos Estratégicos
                            </a>
                            <a href="#" data-tab="scorecard" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Balanced Scorecard
                            </a>
                        </div>
                    </div>


                    <!-- Plano de Negócio -->
                    <div class="menu-item">
                        <button class="menu-btn w-full flex items-center justify-between p-4 rounded-xl gradient-card text-white hover:opacity-90 transition-all shadow-lg hover:shadow-xl">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-briefcase text-sm"></i>
                            </div>
                                <span class="font-semibold">Plano de Negócio</span>
                            </div>
                            <i class="fas fa-chevron-down transition-transform duration-300 text-sm"></i>
                        </button>
                        <div class="submenu mt-2 ml-2 space-y-1 border-l-2 border-pink-200 dark:border-pink-800 pl-4">
                            <a href="#" data-tab="sumario" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-pink-600 dark:hover:text-pink-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Sumário Executivo
                            </a>
                            <a href="#" data-tab="mercado" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-pink-600 dark:hover:text-pink-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Análise de Mercado
                            </a>
                            <a href="#" data-tab="operacional" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-pink-600 dark:hover:text-pink-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Plano Operacional
                            </a>
                            <a href="#" data-tab="implementacao" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-pink-600 dark:hover:text-pink-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Plano de Implementação
                            </a>
                            <a href="#" data-tab="canvas" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-pink-600 dark:hover:text-pink-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Modelo Canvas
                            </a>
                            <a href="#" data-tab="apresentacao" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-pink-600 dark:hover:text-pink-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Apresentação do Negócio
                            </a>
                            <a href="#" data-tab="porter-negocio" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-pink-600 dark:hover:text-pink-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Forças de Porter
                            </a>
                            <a href="#" data-tab="organizacao" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-pink-600 dark:hover:text-pink-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Organização e RH
                            </a>
                            <a href="#" data-tab="projecoes" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-pink-600 dark:hover:text-pink-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Projecções Financeiros
                            </a>
                            <a href="#" data-tab="legais" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-pink-600 dark:hover:text-pink-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Aspectos Legais
                            </a>
                            <a href="#" data-tab="produtos" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-pink-600 dark:hover:text-pink-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Produtos e Serviços
                            </a>
                            <a href="#" data-tab="marketing" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-pink-600 dark:hover:text-pink-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Estratégia de Marketing
                            </a>
                            <a href="#" data-tab="swot-negocio" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-pink-600 dark:hover:text-pink-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Análise SWOT
                            </a>
                            <a href="#" data-tab="viabilidade-negocio" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-pink-600 dark:hover:text-pink-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Análise de Viabilidade
                            </a>
                            <a href="#" data-tab="riscos" class="sidebar-item block p-2.5 text-sm text-gray-700 dark:text-gray-300 hover:text-pink-600 dark:hover:text-pink-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-all">
                                <i class="fas fa-circle text-xs mr-2 opacity-50"></i>Gestão de Riscos
                            </a>
                        </div>
                    </div>
                </nav>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 overflow-y-auto bg-gray-50 dark:bg-gray-900">
            <!-- Breadcrumb -->
            <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-8 py-4">
                <nav class="flex items-center space-x-2 text-sm">
                    <a href="#" class="text-gray-500 dark:text-gray-400 hover:text-primary transition-colors">
                        <i class="fas fa-home"></i>
                    </a>
                    <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                    <span id="breadcrumb-current" class="text-gray-700 dark:text-gray-300 font-medium">Dashboard</span>
                </nav>
            </div>

            <div class="p-8">
                <!-- Tabs Navigation -->
                <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex space-x-1 overflow-x-auto">
                        <button class="tab-button active px-6 py-3 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-blue-400 transition-colors whitespace-nowrap" data-tab="dashboard">
                            <i class="fas fa-home mr-2"></i>Dashboard
                        </button>
                        <button class="tab-button px-6 py-3 text-sm font-semibold text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-blue-400 transition-colors whitespace-nowrap" data-tab="projetos">
                            <i class="fas fa-folder mr-2"></i>Meus Projetos
                        </button>
                        <button class="tab-button px-6 py-3 text-sm font-semibold text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-blue-400 transition-colors whitespace-nowrap" data-tab="relatorios">
                            <i class="fas fa-file-alt mr-2"></i>Relatórios
                        </button>
                        <button class="tab-button px-6 py-3 text-sm font-semibold text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-blue-400 transition-colors whitespace-nowrap" data-tab="analytics">
                            <i class="fas fa-chart-bar mr-2"></i>Analytics
                        </button>
                        <button class="tab-button px-6 py-3 text-sm font-semibold text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-blue-400 transition-colors whitespace-nowrap" data-tab="configuracoes">
                            <i class="fas fa-cog mr-2"></i>Configurações
                        </button>
                    </div>
                </div>

                <!-- Spreadsheet Content Area (shown when menu item is clicked) -->
                <div id="spreadsheet-area" class="hidden">
                    <div class="spreadsheet-container">
                        <div class="spreadsheet-header">
                            <div>
                                <h2 id="spreadsheet-title" class="text-xl font-bold">Plano Financeiro</h2>
                                <p id="spreadsheet-subtitle" class="text-sm opacity-90">1. - Pressupostos do Projeto</p>
                            </div>
                            <div class="flex items-center space-x-4">
                                <!-- Action Buttons (for equipment management) -->
                                <div id="equipment-actions" class="hidden flex items-center space-x-2">
                                    <button id="btn-add-equipment" class="p-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors shadow-md" title="Adicionar Equipamento">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <button id="btn-edit-equipment" class="p-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-md" title="Editar Equipamento" disabled>
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button id="btn-delete-equipment" class="p-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-md" title="Excluir Equipamento" disabled>
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <button id="btn-import-excel" class="p-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors shadow-md ml-2" title="Importar Excel">
                                        <i class="fas fa-file-excel mr-1"></i> Importar
                                    </button>
                                </div>
                                <!-- Chart Toggle (only for investimento) -->
                                <div id="chart-toggle-container" class="hidden flex items-center space-x-2 bg-white/20 px-3 py-1.5 rounded-lg border border-white/30">
                                    <input type="checkbox" id="chart-toggle" checked class="w-4 h-4 text-primary bg-white rounded focus:ring-primary">
                                    <label for="chart-toggle" class="text-sm font-medium cursor-pointer text-white">Gráfico</label>
                                </div>
                                <button id="btn-export-excel" class="p-2 bg-white/20 hover:bg-white/30 text-white rounded-lg transition-colors border border-white/30" title="Exportar para Excel">
                                    <i class="fas fa-file-excel"></i>
                                </button>
                                <button id="btn-print" class="p-2 bg-white/20 hover:bg-white/30 text-white rounded-lg transition-colors border border-white/30" title="Imprimir">
                                    <i class="fas fa-print"></i>
                                </button>
                                <button id="btn-help" class="p-2 bg-white/20 hover:bg-white/30 text-white rounded-lg transition-colors border border-white/30" title="Ajuda">
                                    <i class="fas fa-question-circle"></i>
                                </button>
                            </div>
                        </div>
                        <div class="spreadsheet-toolbar" style="display: flex !important; visibility: visible !important;">
                            <button id="btn-guardar" class="px-3 py-1.5 bg-green-500 hover:bg-green-600 text-white rounded text-sm transition-colors font-medium shadow-md" style="display: inline-flex !important; visibility: visible !important; opacity: 1 !important; background-color: #10b981 !important;">
                                <i class="fas fa-save mr-1" style="color: white !important;"></i>Guardar
                            </button>
                            <button class="px-3 py-1.5 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors text-gray-700 dark:text-gray-300">
                                <i class="fas fa-undo mr-1"></i>Desfazer
                            </button>
                            <button class="px-3 py-1.5 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors text-gray-700 dark:text-gray-300">
                                <i class="fas fa-redo mr-1"></i>Refazer
                            </button>
                            <div class="border-l border-gray-300 dark:border-gray-600 mx-2"></div>
                            <button class="px-3 py-1.5 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors text-gray-700 dark:text-gray-300">
                                <i class="fas fa-copy mr-1"></i>Copiar
                            </button>
                            <button class="px-3 py-1.5 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors text-gray-700 dark:text-gray-300">
                                <i class="fas fa-paste mr-1"></i>Colar
                            </button>
                            <div class="border-l border-gray-300 dark:border-gray-600 mx-2"></div>
                            <button class="px-3 py-1.5 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors text-gray-700 dark:text-gray-300">
                                <i class="fas fa-search mr-1"></i>Buscar
                            </button>
                        </div>
                        <div class="flex flex-col lg:flex-row gap-4 p-4">
                            <!-- Spreadsheet Content -->
                            <div class="flex-1">
                        <div class="spreadsheet-content" id="spreadsheet-content">
                            <!-- Spreadsheet table will be inserted here -->
                        </div>
                            </div>
                            
                            <!-- Chart Container (only for investimento) -->
                            <div id="chart-container" class="hidden lg:w-96 flex-shrink-0 bg-white dark:bg-gray-800 rounded-lg p-4 shadow-lg border border-gray-200 dark:border-gray-700">
                                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4 text-center">
                                    Distribuição dos Investimentos
                                </h3>
                                <div class="relative" style="height: 400px;">
                                    <canvas id="investment-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal: Adicionar/Editar Equipamento -->
                <div id="modal-equipment" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-2xl w-full transform transition-all">
                        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                            <div class="flex items-center justify-between">
                                <h3 class="text-xl font-bold text-gray-800 dark:text-white">
                                    <i class="fas fa-cog mr-2 text-primary"></i>
                                    <span id="modal-equipment-title">Adicionar Equipamento</span>
                                </h3>
                                <button id="btn-close-equipment-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                        </div>
                        <form id="form-equipment" class="p-6 space-y-4">
                            <div>
                                <label for="equipment-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Identificação do Equipamento <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="equipment-name" name="equipment-name" required
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white"
                                    placeholder="Ex: Máquina de Produção A">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="equipment-ano0" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Ano 0 <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="equipment-ano0" name="equipment-ano0" required
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white"
                                        placeholder="0,00" value="0,00">
                                </div>
                            </div>
                            
                            <div id="equipment-years-container" class="grid grid-cols-5 gap-4">
                                <!-- Years will be dynamically added here -->
                            </div>
                            
                            <div class="flex space-x-3 pt-4">
                                <button type="button" id="btn-cancel-equipment" 
                                    class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                                    Cancelar
                                </button>
                                <button type="submit" 
                                    class="flex-1 px-4 py-2 text-white rounded-lg hover:opacity-90 transition-colors font-medium shadow-md" style="background-color: #10b981 !important;">
                                    <i class="fas fa-check mr-2"></i>Guardar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Modal: Importar Excel -->
                <div id="modal-import" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full transform transition-all">
                        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                            <div class="flex items-center justify-between">
                                <h3 class="text-xl font-bold text-gray-800 dark:text-white">
                                    <i class="fas fa-file-import mr-2 text-primary"></i>Importar Dados
                                </h3>
                                <button id="btn-close-import-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                        </div>
                        <div class="p-6 space-y-4">
                            <div class="text-center p-6 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg hover:border-primary dark:hover:border-primary transition-colors cursor-pointer" id="drop-zone">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                                <p class="text-gray-600 dark:text-gray-300 mb-1">Arraste o arquivo Excel aqui</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">ou clique para selecionar</p>
                                <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls">
                            </div>
                            <div id="file-info" class="hidden p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg flex items-center justify-between">
                                <div class="flex items-center space-x-2 overflow-hidden">
                                    <i class="fas fa-file-excel text-green-600"></i>
                                    <span id="file-name" class="text-sm font-medium text-gray-700 dark:text-gray-300 truncate">arquivo.xlsx</span>
                                </div>
                                <button id="btn-remove-file" class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <div class="flex justify-between items-center pt-2">
                                <a href="/api/import/template" class="text-sm text-primary hover:underline flex items-center">
                                    <i class="fas fa-download mr-1"></i> Baixar modelo
                                </a>
                            </div>
                            
                            <div id="import-preview" class="hidden space-y-2">
                                <h4 class="font-medium text-sm text-gray-700 dark:text-gray-300">Prévia da importação:</h4>
                                <div class="bg-gray-50 dark:bg-gray-700/50 rounded p-2 text-xs max-h-32 overflow-y-auto" id="preview-content">
                                    <!-- Preview items -->
                                </div>
                            </div>

                            <div class="flex space-x-3 pt-4">
                                <button type="button" id="btn-cancel-import" 
                                    class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                                    Cancelar
                                </button>
                                <button type="button" id="btn-confirm-import" disabled
                                    class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fas fa-file-import mr-2"></i>Importar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal: Novo Projeto -->
                <div id="modal-novo-projeto" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full transform transition-all">
                        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                            <div class="flex items-center justify-between">
                                <h3 class="text-xl font-bold text-gray-800 dark:text-white">
                                    <i class="fas fa-folder-plus mr-2 text-primary"></i>Criar Novo Projeto
                                </h3>
                                <button id="btn-fechar-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                        </div>
                        <form id="form-novo-projeto" class="p-6 space-y-4">
                            <div>
                                <label for="nome-projeto" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Nome do Projeto <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="nome-projeto" name="nome-projeto" required
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white"
                                    placeholder="Ex: Projeto de Expansão 2024">
                            </div>
                            
                            <div>
                                <label for="primeiro-ano" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Primeiro Ano de Projeção <span class="text-red-500">*</span>
                                </label>
                                <input type="number" id="primeiro-ano" name="primeiro-ano" required min="2000" max="2100"
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white"
                                    placeholder="Ex: 2022" value="2022">
                            </div>
                            
                            <div>
                                <label for="num-anos" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Nº Anos de Projeção <span class="text-red-500">*</span>
                                </label>
                                <input type="number" id="num-anos" name="num-anos" required min="1" max="20"
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white"
                                    placeholder="Ex: 5" value="5">
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                    O primeiro ano será o "Ano 0" (inicial), seguido pelos anos de projeção
                                </p>
                            </div>
                            
                            <div>
                                <label for="unidade-monetaria" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Unidade Monetária <span class="text-red-500">*</span>
                                </label>
                                <select id="unidade-monetaria" name="unidade-monetaria" required
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white">
                                    <option value="EUR">EUR (Euro)</option>
                                    <option value="USD">USD (Dólar Americano)</option>
                                    <option value="KZ">KZ (Kwanza)</option>
                                    <option value="AOA">AOA (Kwanza Angolano)</option>
                                    <option value="BRL">BRL (Real Brasileiro)</option>
                                    <option value="MZN">MZN (Metical)</option>
                                    <option value="ZAR">ZAR (Rand Sul-Africano)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="pin-projeto" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    PIN de 4 dígitos <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="pin-projeto" name="pin-projeto" required maxlength="4" pattern="[0-9]{4}"
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white text-center text-2xl tracking-widest font-mono"
                                    placeholder="0000" autocomplete="off">
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                    <i class="fas fa-info-circle mr-1"></i>Digite um PIN de 4 dígitos para proteger seu projeto
                                </p>
                            </div>
                            
                            <div class="flex space-x-3 pt-4">
                                <button type="button" id="btn-cancelar-projeto" 
                                    class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                                    Cancelar
                                </button>
                                <button type="submit" 
                                    class="flex-1 px-4 py-2 text-white rounded-lg hover:opacity-90 transition-colors font-medium shadow-md" style="background-color: #10b981 !important;">
                                    <i class="fas fa-check mr-2"></i>Criar Projeto
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Modal: Solicitar PIN -->
                <div id="modal-pin" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full transform transition-all">
                        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                            <div class="flex items-center justify-between">
                                <h3 class="text-xl font-bold text-gray-800 dark:text-white">
                                    <i class="fas fa-lock mr-2 text-primary"></i>PIN do Projeto
                                </h3>
                                <button id="btn-fechar-modal-pin" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <p class="text-gray-600 dark:text-gray-400 mb-4">
                                Digite o PIN de 4 dígitos para acessar o projeto <strong id="pin-project-name" class="text-gray-800 dark:text-white"></strong>
                            </p>
                            <form id="form-pin" class="space-y-4">
                                <div>
                                    <label for="pin-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        PIN <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="pin-input" name="pin-input" required maxlength="4" pattern="[0-9]{4}"
                                        class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white text-center text-3xl tracking-widest font-mono"
                                        placeholder="0000" autocomplete="off">
                                </div>
                                <div id="pin-error" class="hidden text-red-500 text-sm mt-2">
                                    <i class="fas fa-exclamation-circle mr-1"></i><span id="pin-error-text"></span>
                                </div>
                                <div class="flex space-x-3 pt-4">
                                    <button type="button" id="btn-cancelar-pin" 
                                        class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                                        Cancelar
                                    </button>
                                    <button type="submit" 
                                        class="flex-1 px-4 py-2 text-white rounded-lg hover:opacity-90 transition-colors font-medium shadow-md" style="background-color: #10b981 !important;">
                                        <i class="fas fa-unlock mr-2"></i>Verificar PIN
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Dashboard -->
                <div id="tab-dashboard" class="tab-content active">
                <!-- Welcome Section -->
                <div id="welcome-section" class="mb-8 slide-in">
                        <div class="gradient-bg rounded-2xl p-8 text-white shadow-2xl relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -mr-32 -mt-32"></div>
                            <div class="absolute bottom-0 left-0 w-48 h-48 bg-white/10 rounded-full -ml-24 -mb-24"></div>
                            <div class="relative z-10">
                                <h2 class="text-4xl font-bold mb-4">Bem-vindo ao Viabiliza+África</h2>
                                <p class="text-lg opacity-90 mb-6 max-w-2xl">O sistema mais completo para desenvolvimento de planos estratégicos, financeiros e de negócio em África.</p>
                                <div class="flex flex-wrap gap-4">
                                    <button class="bg-white text-primary px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-all hover:scale-105 shadow-lg">
                                        <i class="fas fa-plus mr-2"></i>Começar Projeto
                                    </button>
                                    <button class="border-2 border-white/50 px-6 py-3 rounded-lg font-semibold hover:bg-white/10 transition-all hover:scale-105">
                                        <i class="fas fa-play-circle mr-2"></i>Ver Tutorial
                                    </button>
                                    <button class="border-2 border-white/50 px-6 py-3 rounded-lg font-semibold hover:bg-white/10 transition-all hover:scale-105">
                                        <i class="fas fa-download mr-2"></i>Baixar Guia
                                    </button>
                                </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                    <div id="stats-section" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg card-hover border border-gray-100 dark:border-gray-700">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-14 h-14 gradient-blue rounded-xl flex items-center justify-center shadow-md">
                                    <i class="fas fa-project-diagram text-white text-xl"></i>
                                </div>
                                <span class="text-xs px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded-full font-medium">+12%</span>
                            </div>
                            <div>
                                <p class="text-gray-500 dark:text-gray-400 text-sm mb-1">Projetos Ativos</p>
                                <p class="text-3xl font-bold text-gray-800 dark:text-white">12</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">3 novos este mês</p>
                            </div>
                            </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg card-hover border border-gray-100 dark:border-gray-700">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-14 h-14 gradient-orange rounded-xl flex items-center justify-center shadow-md">
                                    <i class="fas fa-chart-line text-white text-xl"></i>
                        </div>
                                <span class="text-xs px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 rounded-full font-medium">+5%</span>
                    </div>
                            <div>
                                <p class="text-gray-500 dark:text-gray-400 text-sm mb-1">Taxa de Sucesso</p>
                                <p class="text-3xl font-bold text-gray-800 dark:text-white">94%</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Acima da média</p>
                            </div>
                            </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg card-hover border border-gray-100 dark:border-gray-700">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-14 h-14 gradient-card rounded-xl flex items-center justify-center shadow-md">
                                    <i class="fas fa-euro-sign text-white text-xl"></i>
                        </div>
                                <span class="text-xs px-2 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 rounded-full font-medium">+8%</span>
                    </div>
                            <div>
                                <p class="text-gray-500 dark:text-gray-400 text-sm mb-1">Investimento Total</p>
                                <p class="text-3xl font-bold text-gray-800 dark:text-white">€2.5M</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">€200K este mês</p>
                            </div>
                            </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg card-hover border border-gray-100 dark:border-gray-700">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-14 h-14 gradient-green rounded-xl flex items-center justify-center shadow-md">
                                    <i class="fas fa-users text-white text-xl"></i>
                        </div>
                                <span class="text-xs px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded-full font-medium">+3</span>
                            </div>
                            <div>
                                <p class="text-gray-500 dark:text-gray-400 text-sm mb-1">Colaboradores</p>
                                <p class="text-3xl font-bold text-gray-800 dark:text-white">24</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">3 novos membros</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Projects -->
                    <div id="projects-section" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700">
                        <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                            <h3 class="text-xl font-semibold text-gray-800 dark:text-white">
                                <i class="fas fa-folder-open mr-2 text-primary"></i>Projetos Recentes
                            </h3>
                            <button onclick="document.querySelector('[data-tab=&quot;projetos&quot;]').click()" class="text-sm text-primary hover:underline font-medium">
                                Ver todos <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                    </div>
                    <div class="p-6">
                        <div id="recent-projects-list" class="space-y-4">
                            <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Carregando projetos...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Projetos -->
                <div id="tab-projetos" class="tab-content">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 border border-gray-100 dark:border-gray-700">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">
                                    <i class="fas fa-folder-open mr-2 text-primary"></i>Meus Projetos
                                </h3>
                                <p class="text-gray-600 dark:text-gray-400">Gerencie todos os seus projetos em um só lugar.</p>
                            </div>
                            <button id="btn-novo-projeto-list" class="px-4 py-2 bg-primary text-white rounded-lg hover:opacity-90 transition-colors font-medium shadow-md">
                                <i class="fas fa-plus mr-2"></i>Novo Projeto
                            </button>
                        </div>
                        <div id="projects-list-container" class="space-y-4">
                            <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Carregando projetos...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Relatórios -->
                <div id="tab-relatorios" class="tab-content">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 border border-gray-100 dark:border-gray-700">
                        <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">
                            <i class="fas fa-file-alt mr-2 text-primary"></i>Relatórios
                        </h3>
                        <p class="text-gray-600 dark:text-gray-400">Acesse e gere relatórios detalhados dos seus projetos.</p>
                    </div>
                </div>

                <!-- Tab Content: Analytics -->
                <div id="tab-analytics" class="tab-content">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 border border-gray-100 dark:border-gray-700">
                        <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">
                            <i class="fas fa-chart-bar mr-2 text-primary"></i>Analytics
                        </h3>
                        <p class="text-gray-600 dark:text-gray-400">Visualize métricas e análises dos seus projetos.</p>
                    </div>
                </div>

                <!-- Tab Content: Configurações -->
                <div id="tab-configuracoes" class="tab-content">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 border border-gray-100 dark:border-gray-700">
                        <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">
                            <i class="fas fa-cog mr-2 text-primary"></i>Configurações
                        </h3>
                        <p class="text-gray-600 dark:text-gray-400">Personalize as configurações do sistema.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
// Splash Screen
setTimeout(() => {
    document.getElementById('dashboard').classList.remove('opacity-0');
    document.getElementById('dashboard').classList.add('opacity-100');
}, 2500);

// Theme toggle
document.getElementById('themeToggle').addEventListener('click', () => {
    document.documentElement.classList.toggle('dark');
    localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
});

// Load saved theme
if (localStorage.getItem('theme') === 'dark') {
    document.documentElement.classList.add('dark');
}

// Language menu toggle
document.getElementById('langBtn').addEventListener('click', (e) => {
    e.stopPropagation();
    document.getElementById('langMenu').classList.toggle('hidden');
});

// Notifications menu toggle
document.getElementById('notifBtn').addEventListener('click', (e) => {
    e.stopPropagation();
    document.getElementById('notifMenu').classList.toggle('hidden');
});

// Profile menu toggle
const profileImg = document.querySelector('img[alt="Profile"]');
if (profileImg) {
    profileImg.addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('profileMenu').classList.toggle('hidden');
    });
}

// Menu toggle functionality with smooth animations (handles nested submenus)
document.querySelectorAll('.menu-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const menuItem = btn.closest('.menu-item');
        const submenu = menuItem.querySelector('.submenu');
        const chevron = btn.querySelector('.fa-chevron-right, .fa-chevron-down');
        
        if (!submenu) return;
        
        // Toggle current menu item
        const isActive = submenu.classList.contains('active');
        
        if (isActive) {
            submenu.classList.remove('active');
            submenu.classList.add('hidden');
            if (chevron) {
                chevron.style.transform = 'rotate(0deg)';
                chevron.classList.remove('fa-chevron-down');
                chevron.classList.add('fa-chevron-right');
            }
        } else {
            submenu.classList.remove('hidden');
            submenu.classList.add('active');
            if (chevron) {
                chevron.style.transform = 'rotate(90deg)';
                chevron.classList.remove('fa-chevron-right');
                chevron.classList.add('fa-chevron-down');
            }
        }
    });
});

// Tab system
document.querySelectorAll('.tab-button').forEach(btn => {
    btn.addEventListener('click', () => {
        const tabName = btn.getAttribute('data-tab');
        
        // Hide spreadsheet area
        document.getElementById('spreadsheet-area').classList.add('hidden');
        
        // Show tabs navigation
        document.querySelector('.mb-6.border-b').style.display = 'block';
        
        // Remove active class from all tabs
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Add active class to clicked tab
        btn.classList.add('active');
        const tabContent = document.getElementById(`tab-${tabName}`);
        if (tabContent) {
            tabContent.classList.add('active');
            // Load projects if Projects tab is activated
            if (tabName === 'projetos') {
                loadAllProjects();
            }
        }
        
        // Update breadcrumb
        const breadcrumbText = btn.textContent.trim();
        document.getElementById('breadcrumb-current').textContent = breadcrumbText;
        
        // Remove active state from sidebar items
        document.querySelectorAll('.sidebar-item').forEach(si => {
            si.classList.remove('bg-primary/10', 'text-primary', 'dark:bg-primary/20');
        });
    });
});

// Function to generate year headers
// Ano 0 (Inicial) = 2022, Ano 1 = 2023, Ano 2 = 2024, etc.
// Project configuration (stored in localStorage)
let projectConfig = {
    nome: '',
    primeiroAno: 2022,
    numAnos: 5,
    unidadeMonetaria: 'EUR'
};

// Load project config from localStorage or API
async function loadProjectConfig() {
    // Try to load from API first
    try {
        const response = await fetch('/api/projects/current');
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.project) {
                projectConfig = {
                    id: result.project.id,
                    nome: result.project.nome,
                    primeiroAno: result.project.primeiroAno,
                    numAnos: result.project.numAnos,
                    unidadeMonetaria: result.project.unidadeMonetaria
                };
                // Save to localStorage for offline access
                localStorage.setItem('projectConfig', JSON.stringify(projectConfig));
                return projectConfig;
            }
        }
    } catch (error) {
        console.log('API not available, loading from localStorage:', error);
    }
    
    // Fallback to localStorage
    const saved = localStorage.getItem('projectConfig');
    if (saved) {
        try {
            projectConfig = JSON.parse(saved);
        } catch (e) {
            console.error('Error loading project config:', e);
        }
    }
    return projectConfig;
}

// Save project config to localStorage (API save is handled separately)
function saveProjectConfig(config) {
    projectConfig = config;
    localStorage.setItem('projectConfig', JSON.stringify(config));
    updateAllSpreadsheets();
}

// Update all spreadsheets with new project config
function updateAllSpreadsheets() {
    // Reload the page to regenerate all spreadsheets with new config
    // This ensures all headers are updated with the new project settings
    location.reload();
}

function generateYearHeaders(startYear = null, includeInitial = true, numYears = null) {
    // Use current projectConfig (synchronous access)
    const firstYear = startYear || projectConfig.primeiroAno || 2022;
    const years = numYears || projectConfig.numAnos || 5;
    
    const headers = [];
    if (includeInitial) {
        headers.push(`${firstYear} (Inicial)`);
    }
    for (let i = 1; i <= years; i++) {
        headers.push(`${firstYear + i}`);
    }
    return headers;
}

// Spreadsheet data for different menu items
const spreadsheetData = {
    'pressupostos': {
        title: 'Plano Financeiro',
        subtitle: '1. - Pressupostos do Projeto',
        headers: ['Parâmetro', ...generateYearHeaders()],
        rows: [
            ['Taxa de Inflação', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%'],
            ['Índice de Inflação', '1', '1,0000', '1,0000', '1,0000', '1,0000', '1,0000'],
            ['Taxa de Aplicações Financeiras de Curto Prazo', '3,00%', '3,00%', '3,00%', '3,00%', '3,00%', '3,00%'],
            ['Taxa de Rendibilidade de um Ativo sem Risco', '5,00%', '5,00%', '5,00%', '5,00%', '5,00%', '5,00%'],
            ['BU (Beta Unlevered)', '1,00', '1,00', '1,00', '1,00', '1,00', '1,00'],
            ['Prémio de Risco do Projeto', '2,00%', '2,00%', '2,00%', '2,00%', '2,00%', '2,00%'],
            ['Taxa de IVA para Outros Rendimentos', '23%', '23,00%', '23,00%', '23,00%', '23,00%', '23,00%'],
            ['Taxa de IRC', '21,00%', '21,00%', '21,00%', '21,00%', '21,00%', '21,00%'],
            ['Derrama', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%'],
            ['Reservas Legais', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%'],
            ['Taxa de Distribuição de Dividendos', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%'],
            ['Nº Meses de Remunerações', '14', '14', '14', '14', '14', '14'],
            ['Taxa Média Retenções na Fonte IRS', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%'],
            ['Segurança Social (Entididade Empregadora - Órgãos Sociais)', '23,75%', '23,75%', '23,75%', '23,75%', '23,75%', '23,75%'],
            ['Segurança Social (Entididade Empregadora - Pessoal)', '23,75%', '23,75%', '23,75%', '23,75%', '23,75%', '23,75%'],
            ['Segurança Social (Trabalhadores - Órgãos Sociais)', '11,00%', '11,00%', '11,00%', '11,00%', '11,00%', '11,00%'],
            ['Segurança Social (Trabalhadores - Pessoal)', '11,00%', '11,00%', '11,00%', '11,00%', '11,00%', '11,00%'],
            ['Seguros e Outros Custos', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%'],
            ['Prazo Médio Recebimento Vendas de Produtos', '60', '60', '60', '60', '60', '60'],
            ['Prazo Médio Recebimento Vendas de Mercadorias', '30', '30', '30', '30', '30', '30'],
            ['Prazo Médio Recebimento Serviços Prestados', '30', '30', '30', '30', '30', '30'],
            ['Prazo Médio Pagamento Fornecedores Mercadorias', '60', '60', '60', '60', '60', '60'],
            ['Prazo Médio Pagamento Fornecimentos Serviços Externos (FSE)', '30', '30', '30', '30', '30', '30'],
            ['Duração Média das Matérias-Primas', '60', '60', '60', '60', '60', '60'],
            ['Reservas de Segurança de Tesouraria (RST)', '0,0%', '0,0%', '0,0%', '0,0%', '0,0%', '0,0%'],
            ['Prazo Médio Pagamento IVA', '40', '40', '40', '40', '40', '40'],
            ['Prazo Médio Pagamento Segurança Social', '30', '30', '30', '30', '30', '30'],
            ['Prazo Médio Pagamento IRS', '30', '30', '30', '30', '30', '30'],
            ['Prazo Médio Recebimento IVA', '90', '90', '90', '90', '90', '90']
        ]
    },
    'investimento': {
        title: 'Plano Financeiro',
        subtitle: '2.1. - Resumo dos Investimentos',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [
            // ACTIVOS FIXOS TANGÍVEIS
            ['ACTIVOS FIXOS TANGÍVEIS', '', '', '', '', '', '', ''],
            ['Terrenos e recursos naturais', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Edifícios e outras construções', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Equipamento básico', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Equipamento transporte', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Equipamento administrativo', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Equipamentos biológicos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Outros ativos fixos tangíveis', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['SUBTOTAL ACTIVOS FIXOS TANGÍVEIS', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            // ACTIVOS INTANGÍVEIS
            ['ACTIVOS INTANGÍVEIS', '', '', '', '', '', '', ''],
            ['Goodwill', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Projetos de desenvolvimento', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Programas de computador', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Propriedade industrial', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Outros ativos intangíveis', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['SUBTOTAL ACTIVOS INTANGÍVEIS', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            // INVESTIMENTOS FINANCEIROS
            ['INVESTIMENTOS FINANCEIROS', '', '', '', '', '', '', ''],
            ['Propriedades de investimento', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Outros investimentos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Investimento em Fundo de Maneio', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            // TOTAL
            ['TOTAL', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ],
        // Row types: 'header' = section header, 'subtotal' = calculated subtotal, 'total' = calculated total
        rowTypes: {
            'ACTIVOS FIXOS TANGÍVEIS': 'header',
            'SUBTOTAL ACTIVOS FIXOS TANGÍVEIS': 'subtotal',
            'ACTIVOS INTANGÍVEIS': 'header',
            'SUBTOTAL ACTIVOS INTANGÍVEIS': 'subtotal',
            'INVESTIMENTOS FINANCEIROS': 'header',
            'TOTAL': 'total'
        },
        // Define which rows belong to each subtotal
        subtotalGroups: {
            'SUBTOTAL ACTIVOS FIXOS TANGÍVEIS': {
                start: 'Terrenos e recursos naturais',
                end: 'Outros ativos fixos tangíveis'
            },
            'SUBTOTAL ACTIVOS INTANGÍVEIS': {
                start: 'Goodwill',
                end: 'Outros ativos intangíveis'
            },
            'TOTAL': {
                includes: ['SUBTOTAL ACTIVOS FIXOS TANGÍVEIS', 'SUBTOTAL ACTIVOS INTANGÍVEIS', 'Propriedades de investimento', 'Outros investimentos', 'Investimento em Fundo de Maneio']
            }
        }
    },
    // Ativos Tangíveis - Submenus
    'ativos-tangiveis-terrenos': {
        title: 'Plano Financeiro',
        subtitle: '2.2.1. - Ativos Tangíveis - Terrenos e recursos naturais',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'Terrenos e recursos naturais'
    },
    'ativos-tangiveis-edificios': {
        title: 'Plano Financeiro',
        subtitle: '2.2.2. - Ativos Tangíveis - Edifícios e outras construções',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'Edifícios e outras construções'
    },
    'ativos-tangiveis-equipamento-basico': {
        title: 'Plano Financeiro',
        subtitle: '2.2.3. - Ativos Tangíveis - Equipamento Básico',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'Equipamento Básico'
    },
    'ativos-tangiveis-equipamento-transporte': {
        title: 'Plano Financeiro',
        subtitle: '2.2.4. - Ativos Tangíveis - Equipamento Transporte',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'Equipamento Transporte'
    },
    'ativos-tangiveis-equipamento-administrativo': {
        title: 'Plano Financeiro',
        subtitle: '2.2.5. - Ativos Tangíveis - Equipamento Administrativo',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'Equipamento Administrativo'
    },
    'ativos-tangiveis-equipamentos-biologicos': {
        title: 'Plano Financeiro',
        subtitle: '2.2.6. - Ativos Tangíveis - Equipamentos Biológicos',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'Equipamentos Biológicos'
    },
    // IVA - Submenus
    'iva-edificios': {
        title: 'Plano Financeiro',
        subtitle: '2.3.1. - IVA - Edifícios e outras construções',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'IVA - Edifícios e outras construções'
    },
    'iva-equipamento-basico': {
        title: 'Plano Financeiro',
        subtitle: '2.3.2. - IVA - Equipamento Básico',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'IVA - Equipamento Básico'
    },
    'iva-equipamento-transporte': {
        title: 'Plano Financeiro',
        subtitle: '2.3.3. - IVA - Equipamento Transporte',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'IVA - Equipamento Transporte'
    },
    'iva-equipamento-administrativo': {
        title: 'Plano Financeiro',
        subtitle: '2.3.4. - IVA - Equipamento Administrativo',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'IVA - Equipamento Administrativo'
    },
    'iva-equipamentos-biologicos': {
        title: 'Plano Financeiro',
        subtitle: '2.3.5. - IVA - Equipamentos Biológicos',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'IVA - Equipamentos Biológicos'
    },
    // Ativos Intangíveis - Submenus
    'ativos-intangiveis-goodwill': {
        title: 'Plano Financeiro',
        subtitle: '2.4.1. - Ativos Intangíveis - Goodwill',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'Goodwill'
    },
    'ativos-intangiveis-projetos-desenvolvimento': {
        title: 'Plano Financeiro',
        subtitle: '2.4.2. - Ativos Intangíveis - Projetos de desenvolvimento',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'Projetos de desenvolvimento'
    },
    'ativos-intangiveis-programas-computador': {
        title: 'Plano Financeiro',
        subtitle: '2.4.3. - Ativos Intangíveis - Programas de computador',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'Programas de computador'
    },
    'ativos-intangiveis-propriedade-industrial': {
        title: 'Plano Financeiro',
        subtitle: '2.4.4. - Ativos Intangíveis - Propriedade industrial',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'Propriedade industrial'
    },
    'ativos-intangiveis-outros': {
        title: 'Plano Financeiro',
        subtitle: '2.4.5. - Ativos Intangíveis - Outros ativos fixos intangíveis',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'Outros ativos fixos intangíveis'
    },
    'depreciacoes': {
        title: 'Plano Financeiro',
        subtitle: '3.1. - Resumo das Depreciações e Amortizações',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [
            // ACTIVOS FIXOS TANGÍVEIS
            ['ACTIVOS FIXOS TANGÍVEIS', '', '', '', '', '', '', ''],
            ['Edifícios e outras construções', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Equipamento básico', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Equipamento transporte', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Equipamento administrativo', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Equipamentos biológicos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Outros ativos fixos tangíveis', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['SUBTOTAL ACTIVOS FIXOS TANGÍVEIS', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            // ACTIVOS INTANGÍVEIS
            ['ACTIVOS INTANGÍVEIS', '', '', '', '', '', '', ''],
            ['Goodwill', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Projetos de desenvolvimento', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Programas de computador', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Propriedade industrial', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Outros ativos intangíveis', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['SUBTOTAL ACTIVOS INTANGÍVEIS', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            // TOTAL
            ['TOTAL', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ],
        // Row types: 'header' = section header, 'subtotal' = calculated subtotal, 'total' = calculated total
        rowTypes: {
            'ACTIVOS FIXOS TANGÍVEIS': 'header',
            'SUBTOTAL ACTIVOS FIXOS TANGÍVEIS': 'subtotal',
            'ACTIVOS INTANGÍVEIS': 'header',
            'SUBTOTAL ACTIVOS INTANGÍVEIS': 'subtotal',
            'TOTAL': 'total'
        },
        // Define which rows belong to each subtotal
        subtotalGroups: {
            'SUBTOTAL ACTIVOS FIXOS TANGÍVEIS': {
                start: 'Edifícios e outras construções',
                end: 'Outros ativos fixos tangíveis'
            },
            'SUBTOTAL ACTIVOS INTANGÍVEIS': {
                start: 'Goodwill',
                end: 'Outros ativos intangíveis'
            },
            'TOTAL': {
                includes: ['SUBTOTAL ACTIVOS FIXOS TANGÍVEIS', 'SUBTOTAL ACTIVOS INTANGÍVEIS']
            }
        }
    },
    'depreciacoes-resumo': {
        title: 'Plano Financeiro',
        subtitle: '3.1. - Resumo das Depreciações e Amortizações',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [
            // ACTIVOS FIXOS TANGÍVEIS
            ['ACTIVOS FIXOS TANGÍVEIS', '', '', '', '', '', '', ''],
            ['Edifícios e outras construções', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Equipamento básico', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Equipamento transporte', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Equipamento administrativo', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Equipamentos biológicos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Outros ativos fixos tangíveis', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['SUBTOTAL ACTIVOS FIXOS TANGÍVEIS', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            // ACTIVOS INTANGÍVEIS
            ['ACTIVOS INTANGÍVEIS', '', '', '', '', '', '', ''],
            ['Goodwill', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Projetos de desenvolvimento', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Programas de computador', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Propriedade industrial', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Outros ativos intangíveis', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['SUBTOTAL ACTIVOS INTANGÍVEIS', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            // TOTAL
            ['TOTAL', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ],
        // Row types: 'header' = section header, 'subtotal' = calculated subtotal, 'total' = calculated total
        rowTypes: {
            'ACTIVOS FIXOS TANGÍVEIS': 'header',
            'SUBTOTAL ACTIVOS FIXOS TANGÍVEIS': 'subtotal',
            'ACTIVOS INTANGÍVEIS': 'header',
            'SUBTOTAL ACTIVOS INTANGÍVEIS': 'subtotal',
            'TOTAL': 'total'
        },
        // Define which rows belong to each subtotal
        subtotalGroups: {
            'SUBTOTAL ACTIVOS FIXOS TANGÍVEIS': {
                start: 'Edifícios e outras construções',
                end: 'Outros ativos fixos tangíveis'
            },
            'SUBTOTAL ACTIVOS INTANGÍVEIS': {
                start: 'Goodwill',
                end: 'Outros ativos intangíveis'
            },
            'TOTAL': {
                includes: ['SUBTOTAL ACTIVOS FIXOS TANGÍVEIS', 'SUBTOTAL ACTIVOS INTANGÍVEIS']
            }
        }
    },
    // Depreciações - Ativos Fixos Tangíveis
    'depreciacoes-edificios': {
        title: 'Plano Financeiro',
        subtitle: '3.2.1. - Depreciações - Edifícios e outras construções',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'Edifícios e outras construções'
    },
    'depreciacoes-equipamento-basico': {
        title: 'Plano Financeiro',
        subtitle: '3.2.2. - Depreciações - Equipamento Básico',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'Equipamento Básico'
    },
    'depreciacoes-equipamento-transporte': {
        title: 'Plano Financeiro',
        subtitle: '3.2.3. - Depreciações - Equipamento Transporte',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'Equipamento Transporte'
    },
    'depreciacoes-equipamento-administrativo': {
        title: 'Plano Financeiro',
        subtitle: '3.2.4. - Depreciações - Equipamento Administrativo',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'Equipamento Administrativo'
    },
    'depreciacoes-equipamentos-biologicos': {
        title: 'Plano Financeiro',
        subtitle: '3.2.5. - Depreciações - Equipamentos Biológicos',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'Equipamentos Biológicos'
    },
    'depreciacoes-outros-tangiveis': {
        title: 'Plano Financeiro',
        subtitle: '3.2.6. - Depreciações - Outros ativos fixos tangíveis',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'Outros ativos fixos tangíveis'
    },
    // Depreciações - Ativos Intangíveis
    'depreciacoes-goodwill': {
        title: 'Plano Financeiro',
        subtitle: '3.3.1. - Amortizações - Goodwill',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'Goodwill'
    },
    'depreciacoes-projetos-desenvolvimento': {
        title: 'Plano Financeiro',
        subtitle: '3.3.2. - Amortizações - Projetos de desenvolvimento',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'Projetos de desenvolvimento'
    },
    'depreciacoes-programas-computador': {
        title: 'Plano Financeiro',
        subtitle: '3.3.3. - Amortizações - Programas de computador',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'Programas de computador'
    },
    'depreciacoes-propriedade-industrial': {
        title: 'Plano Financeiro',
        subtitle: '3.3.4. - Amortizações - Propriedade industrial',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'Propriedade industrial'
    },
    'depreciacoes-outros-intangiveis': {
        title: 'Plano Financeiro',
        subtitle: '3.3.5. - Amortizações - Outros ativos fixos intangíveis',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [],
        isEquipment: true,
        equipmentType: 'Outros ativos fixos intangíveis'
    },
    'rendimentos': {
        title: 'Plano Financeiro',
        subtitle: '4.1. - Resumo da Exploração',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Vendas de Produtos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Vendas de Mercadorias', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Serviços Prestados', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Outros Rendimentos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['TOTAL', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'rendimentos-resumo': {
        title: 'Plano Financeiro',
        subtitle: '4.1. - Resumo da Exploração',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Vendas de Produtos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Vendas de Mercadorias', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Serviços Prestados', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Outros Rendimentos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['TOTAL', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'rendimentos-resumo-mercados': {
        title: 'Plano Financeiro',
        subtitle: '4.2. - Resumo da Exploração por Mercados',
        headers: ['Mercado', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Mercado 1', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Mercado 2', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Mercado 3', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['TOTAL', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    // Projeção de Vendas de Produtos
    'vendas-produtos-mercado-1': {
        title: 'Plano Financeiro',
        subtitle: '4.3.1. - Projeção de Vendas de Produtos - Mercado 1',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Quantidade', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Preço Unitário', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Valor Total', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'vendas-produtos-mercado-2': {
        title: 'Plano Financeiro',
        subtitle: '4.3.2. - Projeção de Vendas de Produtos - Mercado 2',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Quantidade', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Preço Unitário', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Valor Total', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'vendas-produtos-mercado-3': {
        title: 'Plano Financeiro',
        subtitle: '4.3.3. - Projeção de Vendas de Produtos - Mercado 3',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Quantidade', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Preço Unitário', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Valor Total', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    // Projeção de Prestação de Serviços
    'prestacao-servicos-mercado-1': {
        title: 'Plano Financeiro',
        subtitle: '4.4.1. - Projeção de Prestação de Serviços - Mercado 1',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Quantidade', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Preço Unitário', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Valor Total', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'prestacao-servicos-mercado-2': {
        title: 'Plano Financeiro',
        subtitle: '4.4.2. - Projeção de Prestação de Serviços - Mercado 2',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Quantidade', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Preço Unitário', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Valor Total', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'prestacao-servicos-mercado-3': {
        title: 'Plano Financeiro',
        subtitle: '4.4.3. - Projeção de Prestação de Serviços - Mercado 3',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Quantidade', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Preço Unitário', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Valor Total', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    // Projeção de Vendas de Mercados
    'vendas-mercados-mercado-1': {
        title: 'Plano Financeiro',
        subtitle: '4.5.1. - Projeção de Vendas de Mercados - Mercado 1',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Quantidade', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Preço Unitário', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Valor Total', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'vendas-mercados-mercado-2': {
        title: 'Plano Financeiro',
        subtitle: '4.5.2. - Projeção de Vendas de Mercados - Mercado 2',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Quantidade', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Preço Unitário', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Valor Total', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'vendas-mercados-mercado-3': {
        title: 'Plano Financeiro',
        subtitle: '4.5.3. - Projeção de Vendas de Mercados - Mercado 3',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Quantidade', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Preço Unitário', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Valor Total', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    // Outros Rendimentos
    'outros-rendimentos': {
        title: 'Plano Financeiro',
        subtitle: '4.6. - Outros Rendimentos',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Outros Rendimentos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    // IVA - Venda de Produtos
    'iva-venda-produtos-mercado-1': {
        title: 'Plano Financeiro',
        subtitle: '4.7.1.1. - IVA Venda de Produtos - Mercado 1',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Base Tributável', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Taxa IVA', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%'],
            ['Valor IVA', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'iva-venda-produtos-mercado-2': {
        title: 'Plano Financeiro',
        subtitle: '4.7.1.2. - IVA Venda de Produtos - Mercado 2',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Base Tributável', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Taxa IVA', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%'],
            ['Valor IVA', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'iva-venda-produtos-mercado-3': {
        title: 'Plano Financeiro',
        subtitle: '4.7.1.3. - IVA Venda de Produtos - Mercado 3',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Base Tributável', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Taxa IVA', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%'],
            ['Valor IVA', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    // IVA - Prestação de Serviços
    'iva-prestacao-servicos-mercado-1': {
        title: 'Plano Financeiro',
        subtitle: '4.7.2.1. - IVA Prestação de Serviços - Mercado 1',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Base Tributável', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Taxa IVA', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%'],
            ['Valor IVA', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'iva-prestacao-servicos-mercado-2': {
        title: 'Plano Financeiro',
        subtitle: '4.7.2.2. - IVA Prestação de Serviços - Mercado 2',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Base Tributável', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Taxa IVA', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%'],
            ['Valor IVA', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'iva-prestacao-servicos-mercado-3': {
        title: 'Plano Financeiro',
        subtitle: '4.7.2.3. - IVA Prestação de Serviços - Mercado 3',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Base Tributável', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Taxa IVA', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%'],
            ['Valor IVA', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    // IVA - Venda de Mercados
    'iva-venda-mercados-mercado-1': {
        title: 'Plano Financeiro',
        subtitle: '4.7.3.1. - IVA Venda de Mercados - Mercado 1',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Base Tributável', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Taxa IVA', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%'],
            ['Valor IVA', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'iva-venda-mercados-mercado-2': {
        title: 'Plano Financeiro',
        subtitle: '4.7.3.2. - IVA Venda de Mercados - Mercado 2',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Base Tributável', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Taxa IVA', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%'],
            ['Valor IVA', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'iva-venda-mercados-mercado-3': {
        title: 'Plano Financeiro',
        subtitle: '4.7.3.3. - IVA Venda de Mercados - Mercado 3',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Base Tributável', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Taxa IVA', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%'],
            ['Valor IVA', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'custos': {
        title: 'Plano Financeiro',
        subtitle: '5.1. - Resumo dos Gastos de Exploração',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Custo das Mercadorias Vendidas', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Consumo de Matérias Primas', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Fornecimentos e Serviços Externos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Pessoal', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['TOTAL', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'gastos-resumo': {
        title: 'Plano Financeiro',
        subtitle: '5.1. - Resumo dos Gastos de Exploração',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Custo das Mercadorias Vendidas', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Consumo de Matérias Primas', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Fornecimentos e Serviços Externos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Pessoal', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['TOTAL', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    // CMVMC - Custo de Mercadorias
    'custo-mercadorias-mercado-1': {
        title: 'Plano Financeiro',
        subtitle: '5.2.1.1. - Custo de Mercadorias - Mercado 1',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Quantidade', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Preço Unitário', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Valor Total', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'custo-mercadorias-mercado-2': {
        title: 'Plano Financeiro',
        subtitle: '5.2.1.2. - Custo de Mercadorias - Mercado 2',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Quantidade', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Preço Unitário', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Valor Total', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'custo-mercadorias-mercado-3': {
        title: 'Plano Financeiro',
        subtitle: '5.2.1.3. - Custo de Mercadorias - Mercado 3',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Quantidade', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Preço Unitário', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Valor Total', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    // Consumo de Matérias Primas
    'consumo-materias-primas': {
        title: 'Plano Financeiro',
        subtitle: '5.2.2. - Consumo de Matérias Primas',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Quantidade', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Preço Unitário', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Valor Total', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    // IVA - Compras de Mercadorias
    'iva-compras-mercadorias-mercado-1': {
        title: 'Plano Financeiro',
        subtitle: '5.3.1.1. - IVA Compras de Mercadorias - Mercado 1',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Base Tributável', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Taxa IVA', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%'],
            ['Valor IVA', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'iva-compras-mercadorias-mercado-2': {
        title: 'Plano Financeiro',
        subtitle: '5.3.1.2. - IVA Compras de Mercadorias - Mercado 2',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Base Tributável', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Taxa IVA', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%'],
            ['Valor IVA', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'iva-compras-mercadorias-mercado-3': {
        title: 'Plano Financeiro',
        subtitle: '5.3.1.3. - IVA Compras de Mercadorias - Mercado 3',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Base Tributável', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Taxa IVA', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%'],
            ['Valor IVA', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    // IVA - Compras de Matérias Primas
    'iva-compras-materias-primas': {
        title: 'Plano Financeiro',
        subtitle: '5.3.2. - IVA Compras de Matérias Primas',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Base Tributável', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Taxa IVA', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%', '0,00%'],
            ['Valor IVA', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'fundo': {
        title: 'Plano Financeiro',
        subtitle: '6.1. - Variação de Fundo Maneio',
        headers: ['Descrição', ...generateYearHeaders(null, false)],
        rows: [
            ['Clientes', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Fornecedores', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Estoques', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Fundo de Maneio Líquido', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'variacao-fundo-maneio': {
        title: 'Plano Financeiro',
        subtitle: '6.1. - Variação de Fundo Maneio',
        headers: ['Descrição', ...generateYearHeaders(null, false)],
        rows: [
            ['Clientes', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Fornecedores', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Estoques', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Fundo de Maneio Líquido', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'credito-clientes': {
        title: 'Plano Financeiro',
        subtitle: '6.2. - Crédito concebido a Clientes',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Vendas de Produtos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Vendas de Mercadorias', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Serviços Prestados', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Prazo Médio de Recebimento', '0', '0', '0', '0', '0', '0'],
            ['Crédito a Clientes', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'necessidades-inventario': {
        title: 'Plano Financeiro',
        subtitle: '6.3. - Necessidades de Inventário',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Custo das Mercadorias Vendidas', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Consumo de Matérias Primas', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Duração Média dos Inventários', '0', '0', '0', '0', '0', '0'],
            ['Necessidades de Inventário', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'credito-fornecedores': {
        title: 'Plano Financeiro',
        subtitle: '6.4. - Crédito obtido de Fornecedores de Mercadorias e FSE',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Compras de Mercadorias', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Fornecimentos e Serviços Externos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Prazo Médio de Pagamento', '0', '0', '0', '0', '0', '0'],
            ['Crédito de Fornecedores', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'credito-eoep': {
        title: 'Plano Financeiro',
        subtitle: '6.5. - Crédito concebido/obtido de EOEP',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Recebimentos de EOEP', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Pagamentos a EOEP', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Prazo Médio de Recebimento/Pagamento', '0', '0', '0', '0', '0', '0'],
            ['Crédito Líquido EOEP', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'calculo-iva': {
        title: 'Plano Financeiro',
        subtitle: '6.6. - Cálculo do IVA a pagar ou a receber',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['IVA a Receber (Vendas)', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['IVA a Pagar (Compras)', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Prazo Médio de Recebimento/Pagamento IVA', '0', '0', '0', '0', '0', '0'],
            ['IVA Líquido a Pagar/Receber', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    // Financiamento do Projeto
    'origem-financiamento': {
        title: 'Plano Financeiro',
        subtitle: '7.1. - Origem do financiamento',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Capital Próprio', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Empréstimos Bancários', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Financiamentos de Fornecedores', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Subsídios', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Outras Fontes', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['TOTAL', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'divida-total': {
        title: 'Plano Financeiro',
        subtitle: '7.2.1. - Dívida Total',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Dívida Não Corrente', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Dívida Corrente', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Dívida Total', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'divida-projeto-historica': {
        title: 'Plano Financeiro',
        subtitle: '7.2.2. - Dívida do Projeto vs Dívida Histórica',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Dívida do Projeto', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Dívida Histórica', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Dívida Total', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'financiamentos-projeto': {
        title: 'Plano Financeiro',
        subtitle: '7.3.1. - Financiamentos do Projeto',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Empréstimos Bancários', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Financiamentos de Fornecedores', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Capital Próprio', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Subsídios', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Outras Fontes', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['TOTAL', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'amortizacoes-financiamentos-historicos': {
        title: 'Plano Financeiro',
        subtitle: '7.3.2. - Amortizações de Financiamentos Históricos',
        headers: ['Descrição', ...generateYearHeaders(null, false), 'Total'],
        rows: [
            ['Amortização de Empréstimos Bancários', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Amortização de Financiamentos de Fornecedores', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Amortização de Outras Dívidas', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['TOTAL', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ]
    },
    'tesouraria': {
        title: 'Plano Financeiro',
        subtitle: '8. - Orçamento de Tesouraria',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [
            // RECEBIMENTOS
            ['RECEBIMENTOS', '', '', '', '', '', ''],
            ['Vendas (Produtos e Mercadorias)', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['. do ano anterior', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['. do ano', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Serviços prestados', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['. do ano anterior', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['. do ano', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Trabalhos para a própria entidade', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Outros rendimentos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Estado e Outros Entes Públicos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['. do ano anterior', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['. do ano', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Total de Recebimentos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            // PAGAMENTOS
            ['PAGAMENTOS', '', '', '', '', '', ''],
            ['Compras', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['. do ano anterior', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['. do ano', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Fornecimentos e Serviços Externos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['. do ano anterior', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['. do ano', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Gastos com Pessoal', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Remunerações', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Subsídio de Almoço', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Seguros e outros gastos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Impostos (Diretos e Indiretos)', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Outros gastos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Estado e Outros Entes Públicos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['. do ano anterior', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['. do ano', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Total de Pagamentos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            // SALDO
            ['Saldo de TESOURARIA (Recebimentos - Pagamentos)', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ],
        rowTypes: {
            'RECEBIMENTOS': 'header',
            'PAGAMENTOS': 'header',
            'Vendas (Produtos e Mercadorias)': 'subtotal',
            'Serviços prestados': 'subtotal',
            'Estado e Outros Entes Públicos': 'subtotal',
            'Total de Recebimentos': 'total_recebimentos',
            'Compras': 'subtotal',
            'Fornecimentos e Serviços Externos': 'subtotal',
            'Gastos com Pessoal': 'subtotal',
            'Estado e Outros Entes Públicos': 'subtotal',
            'Total de Pagamentos': 'total_pagamentos',
            'Saldo de TESOURARIA (Recebimentos - Pagamentos)': 'saldo'
        },
        // Define calculation groups
        calculationGroups: {
            'Vendas (Produtos e Mercadorias)': {
                includes: ['. do ano anterior', '. do ano'],
                parentRow: 'Vendas (Produtos e Mercadorias)'
            },
            'Serviços prestados': {
                includes: ['. do ano anterior', '. do ano'],
                parentRow: 'Serviços prestados'
            },
            'Estado e Outros Entes Públicos (Recebimentos)': {
                includes: ['. do ano anterior', '. do ano'],
                parentRow: 'Estado e Outros Entes Públicos',
                isRecebimento: true,
                section: 'recebimentos'
            },
            'Total de Recebimentos': {
                includes: ['Vendas (Produtos e Mercadorias)', 'Serviços prestados', 'Trabalhos para a própria entidade', 'Outros rendimentos', 'Estado e Outros Entes Públicos'],
                section: 'recebimentos'
            },
            'Compras': {
                includes: ['. do ano anterior', '. do ano'],
                parentRow: 'Compras'
            },
            'Fornecimentos e Serviços Externos': {
                includes: ['. do ano anterior', '. do ano'],
                parentRow: 'Fornecimentos e Serviços Externos'
            },
            'Gastos com Pessoal': {
                includes: ['Remunerações', 'Subsídio de Almoço'],
                parentRow: 'Gastos com Pessoal'
            },
            'Estado e Outros Entes Públicos (Pagamentos)': {
                includes: ['. do ano anterior', '. do ano'],
                parentRow: 'Estado e Outros Entes Públicos',
                isPagamento: true,
                section: 'pagamentos'
            },
            'Total de Pagamentos': {
                includes: ['Compras', 'Fornecimentos e Serviços Externos', 'Gastos com Pessoal', 'Seguros e outros gastos', 'Impostos (Diretos e Indiretos)', 'Outros gastos', 'Estado e Outros Entes Públicos'],
                section: 'pagamentos'
            },
            'Saldo de TESOURARIA (Recebimentos - Pagamentos)': {
                formula: 'recebimentos - pagamentos'
            }
        }
    },
    'orcamento-financeiro': {
        title: 'Plano Financeiro',
        subtitle: '9. - Orçamento Financeiro',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [
            // 1. SALDO INICIAL
            ['1. SALDO INICIAL', '', '', '', '', '', ''],
            ['Saldo Inicial', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            // 2. ORIGENS DE FUNDOS
            ['2. ORIGENS DE FUNDOS', '', '', '', '', '', ''],
            ['Saldo Positivo de Tesouraria', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Aumentos de Capital Próprio', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Sócios/Acionistas', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Fornecedores de Investimentos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Desinvestimentos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Empréstimos Bancários de médio e longo prazo', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Juros e rendimentos similares obtidos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Reembolsos de Aplicações de Tesouraria', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Reembolsos de Investimentos Financeiros', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Subsídios', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Total de Origens de Fundos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            // 3. APLICAÇÕES DE FUNDOS
            ['3. APLICAÇÕES DE FUNDOS', '', '', '', '', '', ''],
            ['Saldo Negativo de Tesouraria', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Investimentos em Capital Fixo', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['IVA do Investimento em Capital Fixo', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Aplicações de Tesouraria', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Investimentos Financeiros', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Reembolsos de Empréstimos Bancários', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Juros e gastos similares suportados', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Imposto sobre o rendimento do exercício', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Dividendos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Total de Aplicações de Fundos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            // SALDO FINANCEIRO
            ['Saldo FINANCEIRO (1+2-3)', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ],
        rowTypes: {
            '1. SALDO INICIAL': 'header',
            '2. ORIGENS DE FUNDOS': 'header',
            'Total de Origens de Fundos': 'total_origens',
            '3. APLICAÇÕES DE FUNDOS': 'header',
            'Total de Aplicações de Fundos': 'total_aplicacoes',
            'Saldo FINANCEIRO (1+2-3)': 'saldo_financeiro',
            'Saldo Inicial': 'saldo_inicial'
        },
        calculationGroups: {
            'Total de Origens de Fundos': {
                includes: [
                    'Saldo Positivo de Tesouraria',
                    'Aumentos de Capital Próprio',
                    'Sócios/Acionistas',
                    'Fornecedores de Investimentos',
                    'Desinvestimentos',
                    'Empréstimos Bancários de médio e longo prazo',
                    'Juros e rendimentos similares obtidos',
                    'Reembolsos de Aplicações de Tesouraria',
                    'Reembolsos de Investimentos Financeiros',
                    'Subsídios'
                ],
                section: 'origens'
            },
            'Total de Aplicações de Fundos': {
                includes: [
                    'Saldo Negativo de Tesouraria',
                    'Investimentos em Capital Fixo',
                    'IVA do Investimento em Capital Fixo',
                    'Aplicações de Tesouraria',
                    'Investimentos Financeiros',
                    'Reembolsos de Empréstimos Bancários',
                    'Juros e gastos similares suportados',
                    'Imposto sobre o rendimento do exercício',
                    'Dividendos'
                ],
                section: 'aplicacoes'
            },
            'Saldo FINANCEIRO (1+2-3)': {
                formula: 'saldo_inicial + total_origens - total_aplicacoes'
            },
            'Saldo Inicial': {
                formula: 'saldo_financeiro_anterior'
            }
        }
    },
    'balanco': {
        title: 'Plano Financeiro',
        subtitle: '10. - Balanço Patrimonial',
        headers: ['Conta', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [
            // ATIVO
            ['ATIVO', '', '', '', '', '', ''],
            ['Ativos não correntes', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Ativos fixos tangíveis', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Ativos intangíveis', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Propriedades de investimento', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Investimentos financeiros', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Outros ativos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Ativos correntes', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Inventários', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Clientes', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Estado e Outros Entes Públicos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Outros créditos a receber', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Aplicações', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Caixa e depósitos bancários', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Diferimentos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Total do Ativo', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            // CAPITAL PRÓPRIO
            ['CAPITAL PRÓPRIO', '', '', '', '', '', ''],
            ['Capital realizado', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Subsídios', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Reservas', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Resultados transitados', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Resultado líquido do período', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Total do Capital Próprio', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            // PASSIVO
            ['PASSIVO', '', '', '', '', '', ''],
            ['Passivo não corrente', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Financiamentos obtidos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Financiamentos obtidos - Fornecedores', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Outras dívidas a pagar', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Passivo corrente', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Financiamentos obtidos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Sócios/Acionistas', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Fornecedores', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['EOEP', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Outras dívidas a pagar', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Diferimentos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Total do Passivo', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Total do Capital Próprio e Passivo', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Controlo (Ativo = Capital Próprio + Passivo)', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ],
        rowTypes: {
            'ATIVO': 'header',
            'Ativos não correntes': 'subtotal',
            'Ativos correntes': 'subtotal',
            'Total do Ativo': 'total_ativo',
            'CAPITAL PRÓPRIO': 'header',
            'Total do Capital Próprio': 'total_capital_proprio',
            'PASSIVO': 'header',
            'Passivo não corrente': 'subtotal',
            'Passivo corrente': 'subtotal',
            'Total do Passivo': 'total_passivo',
            'Total do Capital Próprio e Passivo': 'total_capital_passivo',
            'Controlo (Ativo = Capital Próprio + Passivo)': 'controle'
        },
        calculationGroups: {
            'Ativos não correntes': {
                includes: [
                    'Ativos fixos tangíveis',
                    'Ativos intangíveis',
                    'Propriedades de investimento',
                    'Investimentos financeiros',
                    'Outros ativos'
                ],
                section: 'ativo'
            },
            'Ativos correntes': {
                includes: [
                    'Inventários',
                    'Clientes',
                    'Estado e Outros Entes Públicos',
                    'Outros créditos a receber',
                    'Aplicações',
                    'Caixa e depósitos bancários',
                    'Diferimentos'
                ],
                section: 'ativo'
            },
            'Total do Ativo': {
                includes: ['Ativos não correntes', 'Ativos correntes']
            },
            'Total do Capital Próprio': {
                includes: [
                    'Capital realizado',
                    'Subsídios',
                    'Reservas',
                    'Resultados transitados',
                    'Resultado líquido do período'
                ]
            },
            'Passivo não corrente': {
                includes: [
                    'Financiamentos obtidos',
                    'Financiamentos obtidos - Fornecedores',
                    'Outras dívidas a pagar'
                ],
                section: 'passivo_nao_corrente',
                startRow: 'Passivo não corrente',
                endRow: 'Outras dívidas a pagar'
            },
            'Passivo corrente': {
                includes: [
                    'Financiamentos obtidos',
                    'Sócios/Acionistas',
                    'Fornecedores',
                    'EOEP',
                    'Outras dívidas a pagar',
                    'Diferimentos'
                ],
                section: 'passivo_corrente',
                startRow: 'Passivo corrente',
                endRow: 'Diferimentos'
            },
            'Total do Passivo': {
                includes: ['Passivo não corrente', 'Passivo corrente']
            },
            'Total do Capital Próprio e Passivo': {
                includes: ['Total do Capital Próprio', 'Total do Passivo']
            },
            'Controlo (Ativo = Capital Próprio + Passivo)': {
                formula: 'ativo - (capital_proprio + passivo)'
            }
        }
    },
    'resultados': {
        title: 'Plano Financeiro',
        subtitle: '11. - Demonstração dos Resultados',
        headers: ['Descrição', 'Ano 0', ...generateYearHeaders(null, false)],
        rows: [
            // RENDIMENTOS
            ['RENDIMENTOS', '', '', '', '', '', ''],
            ['Vendas', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Produtos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Mercadorias', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Serviços prestados', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Variação nos inventários de produção', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Trabalhos para a própria entidade', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Outros rendimentos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['TOTAL dos Rendimentos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            // GASTOS
            ['GASTOS', '', '', '', '', '', ''],
            ['Custo das mercadorias vendidas e das matérias consumidas', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Fornecimentos e Serviços Externos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Gastos com o Pessoal', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Remunerações', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Encargos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Impostos (Diretos e Indiretos)', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Imparidade de inventários (perdas / reversões)', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Imparidade de dívidas a receber (perdas / reversões)', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Provisões (aumentos / reduções)', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Imparidade de invest. não depreciáveis / amortiz. (perdas / reversões)', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Outros gastos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['TOTAL dos Gastos de Exploração', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            // RESULTADOS
            ['RESULTADO antes de depreciações e gastos de financiamento (EBITDA)', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Gastos/Reversões de depreciação e de amortização', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Imparidade de invest. depreciáveis / amortiz. (perdas / reversões)', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['RESULTADO Operacional (EBIT)', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Juros e Rendimentos similares obtidos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Juros e Gastos similares suportados', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['RESULTADO antes de Impostos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Resultados acumulados', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Imposto sobre o rendimento do período', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['RESULTADO Líquido do Período', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['Dividendos', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00'],
            ['RESULTADO Líquido Retido', '0,00', '0,00', '0,00', '0,00', '0,00', '0,00']
        ],
        rowTypes: {
            'RENDIMENTOS': 'header',
            'Vendas': 'subtotal',
            'Gastos com o Pessoal': 'subtotal',
            'TOTAL dos Rendimentos': 'total_rendimentos',
            'GASTOS': 'header',
            'TOTAL dos Gastos de Exploração': 'total_gastos',
            'RESULTADO antes de depreciações e gastos de financiamento (EBITDA)': 'ebitda',
            'RESULTADO Operacional (EBIT)': 'ebit',
            'RESULTADO antes de Impostos': 'resultado_antes_impostos',
            'RESULTADO Líquido do Período': 'resultado_liquido',
            'RESULTADO Líquido Retido': 'resultado_liquido_retido',
            'Resultados acumulados': 'resultados_acumulados'
        },
        calculationGroups: {
            'Vendas': {
                includes: ['Produtos', 'Mercadorias', 'Serviços prestados'],
                parentRow: 'Vendas'
            },
            'TOTAL dos Rendimentos': {
                includes: ['Vendas', 'Variação nos inventários de produção', 'Trabalhos para a própria entidade', 'Outros rendimentos']
            },
            'Gastos com o Pessoal': {
                includes: ['Remunerações', 'Encargos'],
                parentRow: 'Gastos com o Pessoal'
            },
            'TOTAL dos Gastos de Exploração': {
                includes: [
                    'Custo das mercadorias vendidas e das matérias consumidas',
                    'Fornecimentos e Serviços Externos',
                    'Gastos com o Pessoal',
                    'Impostos (Diretos e Indiretos)',
                    'Imparidade de inventários (perdas / reversões)',
                    'Imparidade de dívidas a receber (perdas / reversões)',
                    'Provisões (aumentos / reduções)',
                    'Imparidade de invest. não depreciáveis / amortiz. (perdas / reversões)',
                    'Outros gastos'
                ]
            },
            'RESULTADO antes de depreciações e gastos de financiamento (EBITDA)': {
                formula: 'rendimentos - gastos_exploracao'
            },
            'RESULTADO Operacional (EBIT)': {
                formula: 'ebitda - depreciacoes - imparidade_depreciaveis'
            },
            'RESULTADO antes de Impostos': {
                formula: 'ebit + juros_obtidos - juros_suportados'
            },
            'Resultados acumulados': {
                formula: 'resultado_antes_impostos'
            },
            'RESULTADO Líquido do Período': {
                formula: 'resultado_antes_impostos - imposto_rendimento'
            },
            'RESULTADO Líquido Retido': {
                formula: 'resultado_liquido - dividendos'
            }
        }
    },
    'estrategico': {
        title: 'Plano Estratégico',
        subtitle: 'Enquadramento Estratégico',
        headers: ['Item', 'Descrição', 'Status', 'Responsável', 'Prazo'],
        rows: [
            ['Objetivo 1', 'Descrição do objetivo estratégico', 'Em andamento', 'Equipe A', '2024'],
            ['Objetivo 2', 'Descrição do objetivo estratégico', 'Planejado', 'Equipe B', '2025'],
            ['Objetivo 3', 'Descrição do objetivo estratégico', 'Concluído', 'Equipe C', '2023']
        ]
    },
    'swot': {
        title: 'Plano Estratégico',
        subtitle: 'SWOT Estratégica + Matriz Cruzada',
        headers: ['Categoria', 'Item', 'Impacto', 'Prioridade'],
        rows: [
            ['Forças', 'Força 1', 'Alto', 'Alta'],
            ['Forças', 'Força 2', 'Médio', 'Média'],
            ['Fraquezas', 'Fraqueza 1', 'Alto', 'Alta'],
            ['Oportunidades', 'Oportunidade 1', 'Alto', 'Alta'],
            ['Ameaças', 'Ameaça 1', 'Médio', 'Média']
        ]
    }
};

// Function to parse percentage or number from cell
function parseCellValue(value) {
    if (!value) return 0;
    // Remove currency symbols, spaces, and percentage signs
    let cleaned = value.toString().replace(/[€\s%]/g, '');
    // Handle Portuguese number format: 1.234,56 -> 1234.56
    // First, remove thousand separators (dots)
    cleaned = cleaned.replace(/\./g, '');
    // Then replace comma with dot for decimal
    cleaned = cleaned.replace(',', '.');
    const num = parseFloat(cleaned);
    return isNaN(num) ? 0 : num;
}

// Function to format number as percentage
function formatPercentage(value) {
    return value.toFixed(2) + '%';
}

// Function to format number with 4 decimals
function formatDecimal(value) {
    return value.toFixed(4);
}

// Function to format number as currency
function formatCurrency(value) {
    if (value === 0) return '0,00';
    return value.toLocaleString('pt-PT', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// Function to calculate Inflation Index
function calculateInflationIndex(inflationRate, previousIndex) {
    return (1 + inflationRate / 100) * previousIndex;
}

// Function to get cell value by row name and column index
function getCellValue(rowName, colIndex) {
    const table = document.querySelector('.spreadsheet-table');
    if (!table) return 0;
    
    const rows = table.querySelectorAll('tbody tr');
    for (let row of rows) {
        const firstCell = row.querySelector('td:first-child');
        if (firstCell && firstCell.textContent.trim() === rowName) {
            const cell = row.querySelector(`td[data-col="${colIndex}"]`);
            if (cell) {
                return parseCellValue(cell.textContent);
            }
        }
    }
    return 0;
}

// Function to set cell value by row name and column index
function setCellValue(rowName, colIndex, value, format = null) {
    const table = document.querySelector('.spreadsheet-table');
    if (!table) return;
    
    const rows = table.querySelectorAll('tbody tr');
    for (let row of rows) {
        const firstCell = row.querySelector('td:first-child');
        if (firstCell && firstCell.textContent.trim() === rowName) {
            const cell = row.querySelector(`td[data-col="${colIndex}"]`);
            if (cell && cell.classList.contains('calculated')) {
                let formattedValue = value;
                if (format === 'percentage') {
                    formattedValue = formatPercentage(value);
                } else if (format === 'decimal') {
                    formattedValue = formatDecimal(value);
                } else {
                    formattedValue = value.toString();
                }
                cell.textContent = formattedValue;
            }
        }
    }
}

// Function to recalculate all formulas
function recalculateFormulas() {
    // Calculate Inflation Index for each year
    // Formula: Índice de Inflação (n) = (1 + Taxa de Inflação (n)) × Índice de Inflação (n-1)
    // Column 1 = 2022 (Inicial), Columns 2-6 = 2023-2027
    const initialIndex = getCellValue('Índice de Inflação', 1); // Column 1: 2022 (Inicial)
    let previousIndex = initialIndex;
    
    // Calculate for each year dynamically based on project config
    const numAnos = projectConfig.numAnos || 5;
    for (let year = 2; year <= numAnos + 1; year++) {
        const inflationRate = getCellValue('Taxa de Inflação', year);
        const calculatedIndex = calculateInflationIndex(inflationRate, previousIndex);
        setCellValue('Índice de Inflação', year, calculatedIndex, 'decimal');
        previousIndex = calculatedIndex;
    }
    
    // Calculate Reserva de Segurança de Tesouraria (RST)
    // RST represents minimum cash needed to face delays in receipts
    // Default: 1.5 months of average monthly revenue
    // Try to get rendimentos from current sheet or call backend
    calculateRST();
}

// Function to calculate RST (Reserva de Segurança de Tesouraria)
async function calculateRST() {
    try {
        // Try to get rendimentos data from backend
        const response = await fetch('/api/spreadsheet/rendimentos');
        if (response.ok) {
            const rendimentosData = await response.json();
            // Calculate RST based on rendimentos
            const rstResponse = await fetch('/api/spreadsheet/pressupostos/calculate-rst', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ rendimentos: rendimentosData })
            });
            
            if (rstResponse.ok) {
                const rstData = await rstResponse.json();
                // Update RST cells
                Object.keys(rstData.rst_values).forEach(year => {
                    const colIndex = parseInt(year.replace('Ano ', '')) + 1; // Convert "Ano 1" to column index 2
                    setCellValue('Reservas de Segurança de Tesouraria (RST)', colIndex, rstData.rst_values[year], 'decimal');
                });
            }
        }
    } catch (error) {
        // If backend not available, use default calculation
        // RST can be manually entered or calculated client-side if needed
        console.log('RST calculation: Backend not available, using manual entry');
    }
}

// Function to calculate investment subtotals and totals
// Function to update depreciation summary from all equipment sheets
function updateDepreciationSummary() {
    const data = spreadsheetData['depreciacoes'];
    if (!data) return;
    
    // Mapping of equipment sheet keys to depreciation summary row names
    const equipmentMapping = {
        // Ativos Fixos Tangíveis
        'depreciacoes-edificios': 'Edifícios e outras construções',
        'depreciacoes-equipamento-basico': 'Equipamento básico',
        'depreciacoes-equipamento-transporte': 'Equipamento transporte',
        'depreciacoes-equipamento-administrativo': 'Equipamento administrativo',
        'depreciacoes-equipamentos-biologicos': 'Equipamentos biológicos',
        'depreciacoes-outros-tangiveis': 'Outros ativos fixos tangíveis',
        // Ativos Intangíveis
        'depreciacoes-goodwill': 'Goodwill',
        'depreciacoes-projetos-desenvolvimento': 'Projetos de desenvolvimento',
        'depreciacoes-programas-computador': 'Programas de computador',
        'depreciacoes-propriedade-industrial': 'Propriedade industrial',
        'depreciacoes-outros-intangiveis': 'Outros ativos intangíveis'
    };
    
    // Initialize totals for each row and column
    const totals = {};
    Object.values(equipmentMapping).forEach(rowName => {
        totals[rowName] = {};
    });
    
    // Calculate totals from all equipment sheets
    Object.keys(equipmentMapping).forEach(sheetKey => {
        const equipmentData = spreadsheetData[sheetKey];
        if (!equipmentData || !equipmentData.rows) return;
        
        const rowName = equipmentMapping[sheetKey];
        const numAnos = projectConfig.numAnos || 5;
        
        // Sum all equipment values for this category
        equipmentData.rows.forEach(row => {
            if (Array.isArray(row) && row.length > 1) {
                // row[0] = equipment name, row[1] = Ano 0, row[2+] = years
                for (let col = 1; col <= numAnos + 1; col++) {
                    const value = parseCellValue(row[col] || '0,00');
                    if (!totals[rowName][col]) {
                        totals[rowName][col] = 0;
                    }
                    totals[rowName][col] += value;
                }
            }
        });
    });
    
    // Update depreciation summary rows
    const numAnos = projectConfig.numAnos || 5;
    data.rows.forEach((row, rowIndex) => {
        const rowName = row[0];
        if (equipmentMapping && Object.values(equipmentMapping).includes(rowName)) {
            // Update this row with calculated totals
            row[1] = formatCurrency(totals[rowName][1] || 0); // Ano 0
            for (let i = 1; i <= numAnos; i++) {
                row[i + 1] = formatCurrency(totals[rowName][i + 1] || 0);
            }
        }
    });
    
    // Recalculate totals if we're currently viewing the depreciation summary
    const currentSheet = document.getElementById('equipment-actions')?.getAttribute('data-current-sheet');
    if (currentSheet === 'depreciacoes' || currentSheet === 'depreciacoes-resumo') {
        // Use setTimeout to ensure DOM is ready
        setTimeout(() => {
            calculateDepreciationTotals();
            if (document.getElementById('chart-toggle')?.checked) {
                createDepreciationChart();
            }
        }, 50);
    }
}

// Function to calculate depreciation subtotals and totals
function calculateDepreciationTotals() {
    const table = document.querySelector('.spreadsheet-table');
    if (!table) return;
    
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    const data = spreadsheetData['depreciacoes'];
    if (!data || !data.subtotalGroups) return;
    
    // Helper function to find row index by name
    function findRowIndex(rowName) {
        for (let i = 0; i < rows.length; i++) {
            const firstCell = rows[i].querySelector('td:first-child');
            if (firstCell && firstCell.textContent.trim() === rowName) {
                return i;
            }
        }
        return -1;
    }
    
    // Calculate subtotals
    Object.keys(data.subtotalGroups).forEach(subtotalName => {
        const group = data.subtotalGroups[subtotalName];
        const subtotalRowIndex = findRowIndex(subtotalName);
        if (subtotalRowIndex === -1) return;
        
        const subtotalRow = rows[subtotalRowIndex];
        
        // Calculate for each column (Ano 0 = col 1, etc.)
        const numAnos = projectConfig.numAnos || 5;
        const totalCols = numAnos + 1; // Ano 0 + numAnos
        for (let col = 1; col <= totalCols; col++) {
            let sum = 0;
            
            if (group.start && group.end) {
                // Sum rows between start and end (inclusive)
                const startIndex = findRowIndex(group.start);
                const endIndex = findRowIndex(group.end);
                
                if (startIndex !== -1 && endIndex !== -1) {
                    for (let i = startIndex; i <= endIndex; i++) {
                        const row = rows[i];
                        const firstCell = row.querySelector('td:first-child');
                        const rowName = firstCell ? firstCell.textContent.trim() : '';
                        
                        // Skip if it's the subtotal row itself
                        if (rowName === subtotalName) continue;
                        
                        const cell = row.querySelector(`td[data-col="${col}"]`);
                        if (cell && !cell.classList.contains('calculated')) {
                            sum += parseCellValue(cell.textContent);
                        }
                    }
                }
            } else if (group.includes) {
                // Sum specific rows
                group.includes.forEach(includedRow => {
                    const rowIndex = findRowIndex(includedRow);
                    if (rowIndex !== -1) {
                        const row = rows[rowIndex];
                        const cell = row.querySelector(`td[data-col="${col}"]`);
                        if (cell && !cell.classList.contains('calculated')) {
                            sum += parseCellValue(cell.textContent);
                        }
                    }
                });
            }
            
            // Update subtotal cell
            const cell = subtotalRow.querySelector(`td[data-col="${col}"]`);
            if (cell) {
                cell.textContent = formatCurrency(sum);
            }
        }
    });
}

// Function to create depreciation chart
function createDepreciationChart() {
    const chartContainer = document.getElementById('chart-container');
    if (!chartContainer) return;
    
    const table = document.querySelector('.spreadsheet-table');
    if (!table) return;
    
    const data = spreadsheetData['depreciacoes'];
    if (!data) return;
    
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    const numAnos = projectConfig.numAnos || 5;
    const primeiroAno = projectConfig.primeiroAno || 2022;
    
    // Get data for chart (skip headers and totals)
    const chartData = [];
    const labels = ['Ano 0'];
    for (let i = 1; i <= numAnos; i++) {
        labels.push((primeiroAno + i).toString());
    }
    
    // Extract data rows (skip section headers and subtotals)
    rows.forEach(row => {
        const firstCell = row.querySelector('td:first-child');
        if (!firstCell) return;
        
        const rowName = firstCell.textContent.trim();
        if (data.rowTypes && (data.rowTypes[rowName] === 'header' || data.rowTypes[rowName] === 'subtotal' || data.rowTypes[rowName] === 'total')) {
            return;
        }
        
        const values = [];
        for (let col = 1; col <= numAnos + 1; col++) {
            const cell = row.querySelector(`td[data-col="${col}"]`);
            if (cell) {
                values.push(parseCellValue(cell.textContent));
            }
        }
        
        if (values.length > 0 && values.some(v => v > 0)) {
            chartData.push({
                label: rowName,
                data: values
            });
        }
    });
    
    // Clear previous chart
    chartContainer.innerHTML = '';
    
    if (chartData.length === 0) {
        chartContainer.innerHTML = '<p class="text-gray-500 text-center py-8">Sem dados para exibir no gráfico</p>';
        return;
    }
    
    // Create simple bar chart using Chart.js if available, otherwise use a simple visualization
    if (typeof Chart !== 'undefined') {
        const ctx = document.createElement('canvas');
        chartContainer.appendChild(ctx);
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: chartData.map((item, index) => ({
                    label: item.label,
                    data: item.data,
                    backgroundColor: `hsl(${(index * 360) / chartData.length}, 70%, 50%)`,
                    borderColor: `hsl(${(index * 360) / chartData.length}, 70%, 40%)`,
                    borderWidth: 1
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    } else {
        // Fallback: simple HTML table visualization
        let html = '<div class="overflow-x-auto"><table class="min-w-full text-sm"><thead><tr><th class="text-left p-2">Categoria</th>';
        labels.forEach(label => {
            html += `<th class="text-right p-2">${label}</th>`;
        });
        html += '</tr></thead><tbody>';
        
        chartData.forEach(item => {
            html += `<tr><td class="p-2">${item.label}</td>`;
            item.data.forEach(value => {
                html += `<td class="text-right p-2">${formatCurrency(value)}</td>`;
            });
            html += '</tr>';
        });
        
        html += '</tbody></table></div>';
        chartContainer.innerHTML = html;
    }
}

// Function to update investment summary from all equipment sheets
function updateInvestmentSummary() {
    const data = spreadsheetData['investimento'];
    if (!data) return;
    
    // Mapping of equipment sheet keys to investment summary row names
    const equipmentMapping = {
        // Ativos Tangíveis
        'ativos-tangiveis-terrenos': 'Terrenos e recursos naturais',
        'ativos-tangiveis-edificios': 'Edifícios e outras construções',
        'ativos-tangiveis-equipamento-basico': 'Equipamento básico',
        'ativos-tangiveis-equipamento-transporte': 'Equipamento transporte',
        'ativos-tangiveis-equipamento-administrativo': 'Equipamento administrativo',
        'ativos-tangiveis-equipamentos-biologicos': 'Equipamentos biológicos',
        // Ativos Intangíveis
        'ativos-intangiveis-goodwill': 'Goodwill',
        'ativos-intangiveis-projetos-desenvolvimento': 'Projetos de desenvolvimento',
        'ativos-intangiveis-programas-computador': 'Programas de computador',
        'ativos-intangiveis-propriedade-industrial': 'Propriedade industrial',
        'ativos-intangiveis-outros': 'Outros ativos intangíveis'
    };
    
    // Initialize totals for each row and column
    const totals = {};
    Object.values(equipmentMapping).forEach(rowName => {
        totals[rowName] = {};
    });
    
    // Calculate totals from all equipment sheets
    Object.keys(equipmentMapping).forEach(sheetKey => {
        const equipmentData = spreadsheetData[sheetKey];
        if (!equipmentData || !equipmentData.rows) return;
        
        const rowName = equipmentMapping[sheetKey];
        const numAnos = projectConfig.numAnos || 5;
        
        // Sum all equipment values for this category
        equipmentData.rows.forEach(row => {
            if (Array.isArray(row) && row.length > 1) {
                // row[0] = equipment name, row[1] = Ano 0, row[2+] = years
                for (let col = 1; col <= numAnos + 1; col++) {
                    const value = parseCellValue(row[col] || '0,00');
                    if (!totals[rowName][col]) {
                        totals[rowName][col] = 0;
                    }
                    totals[rowName][col] += value;
                }
            }
        });
    });
    
    // Update investment summary rows
    const numAnos = projectConfig.numAnos || 5;
    data.rows.forEach((row, rowIndex) => {
        const rowName = row[0];
        if (equipmentMapping && Object.values(equipmentMapping).includes(rowName)) {
            // Update this row with calculated totals
            row[1] = formatCurrency(totals[rowName][1] || 0); // Ano 0
            for (let i = 1; i <= numAnos; i++) {
                row[i + 1] = formatCurrency(totals[rowName][i + 1] || 0);
            }
        }
    });
    
    // Recalculate totals if we're currently viewing the investment summary
    const currentSheet = document.getElementById('equipment-actions')?.getAttribute('data-current-sheet');
    if (currentSheet === 'investimento' || currentSheet === 'investimento-resumo') {
        // Use setTimeout to ensure DOM is ready
        setTimeout(() => {
            calculateInvestmentTotals();
            if (document.getElementById('chart-toggle')?.checked) {
                createInvestmentChart();
            }
        }, 50);
    }
}

function calculateInvestmentTotals() {
    const table = document.querySelector('.spreadsheet-table');
    if (!table) return;
    
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    const data = spreadsheetData['investimento'];
    if (!data || !data.subtotalGroups) return;
    
    // Helper function to find row index by name
    function findRowIndex(rowName) {
        for (let i = 0; i < rows.length; i++) {
            const firstCell = rows[i].querySelector('td:first-child');
            if (firstCell && firstCell.textContent.trim() === rowName) {
                return i;
            }
        }
        return -1;
    }
    
    // Calculate subtotals
    Object.keys(data.subtotalGroups).forEach(subtotalName => {
        const group = data.subtotalGroups[subtotalName];
        const subtotalRowIndex = findRowIndex(subtotalName);
        if (subtotalRowIndex === -1) return;
        
        const subtotalRow = rows[subtotalRowIndex];
        
        // Calculate for each column (Ano 0 = col 1, etc.)
        const numAnos = projectConfig.numAnos || 5;
        const totalCols = numAnos + 1; // Ano 0 + numAnos
        for (let col = 1; col <= totalCols; col++) {
            let sum = 0;
            
            if (group.start && group.end) {
                // Sum rows between start and end (inclusive)
                const startIndex = findRowIndex(group.start);
                const endIndex = findRowIndex(group.end);
                
                if (startIndex !== -1 && endIndex !== -1) {
                    for (let i = startIndex; i <= endIndex; i++) {
                        const row = rows[i];
                        const firstCell = row.querySelector('td:first-child');
                        const rowName = firstCell ? firstCell.textContent.trim() : '';
                        
                        // Skip if it's the subtotal row itself
                        if (rowName === subtotalName) continue;
                        
                        const cell = row.querySelector(`td[data-col="${col}"]`);
                        if (cell && !cell.classList.contains('calculated')) {
                            sum += parseCellValue(cell.textContent);
                        }
                    }
                }
            } else if (group.includes) {
                // Sum specific rows
                group.includes.forEach(includedRow => {
                    const rowIndex = findRowIndex(includedRow);
                    if (rowIndex !== -1) {
                        const row = rows[rowIndex];
                        const cell = row.querySelector(`td[data-col="${col}"]`);
                        if (cell && !cell.classList.contains('calculated')) {
                            sum += parseCellValue(cell.textContent);
                        }
                    }
                });
            }
            
            // Update subtotal cell
            const cell = subtotalRow.querySelector(`td[data-col="${col}"]`);
            if (cell) {
                cell.textContent = formatCurrency(sum);
            }
        }
    });
}

// Function to calculate tesouraria totals
function calculateTesourariaTotals() {
    const table = document.querySelector('.spreadsheet-table');
    if (!table) return;
    
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    const data = spreadsheetData['tesouraria'];
    if (!data || !data.calculationGroups) return;
    
    // Helper function to find row index by name (with optional section context)
    function findRowIndex(rowName, inRecebimentos = null) {
        let currentSection = null;
        for (let i = 0; i < rows.length; i++) {
            const firstCell = rows[i].querySelector('td:first-child');
            if (!firstCell) continue;
            const currentRowName = firstCell.textContent.trim();
            
            // Check if we're in recebimentos or pagamentos section
            if (currentRowName === 'RECEBIMENTOS') {
                currentSection = true;
            } else if (currentRowName === 'PAGAMENTOS') {
                currentSection = false;
            }
            
            if (currentRowName === rowName) {
                // For "Estado e Outros Entes Públicos", check context
                if (rowName === 'Estado e Outros Entes Públicos' && inRecebimentos !== null) {
                    if (inRecebimentos === currentSection) {
                        return i;
                    }
                } else {
                    // For other rows, return first match or match in correct section
                    if (rowName !== 'Estado e Outros Entes Públicos' || inRecebimentos === null || inRecebimentos === currentSection) {
                        return i;
                    }
                }
            }
        }
        return -1;
    }
    
    // Helper function to get cell value
    function getCellValue(rowIndex, colIndex) {
        const row = rows[rowIndex];
        if (!row) return 0;
        const cell = row.querySelector(`td[data-col="${colIndex}"]`);
        if (!cell || cell.classList.contains('calculated')) return 0;
        return parseCellValue(cell.textContent);
    }
    
    // Helper function to set cell value
    function setCellValue(rowIndex, colIndex, value) {
        const row = rows[rowIndex];
        if (!row) return;
        const cell = row.querySelector(`td[data-col="${colIndex}"]`);
        if (cell) {
            cell.textContent = formatCurrency(value);
        }
    }
    
    // Calculate for each column (Ano 0 = col 1, 2022 = col 2, etc.)
    for (let col = 1; col <= 6; col++) {
        // Calculate subtotals with subcategories
        Object.keys(data.calculationGroups).forEach(groupName => {
            const group = data.calculationGroups[groupName];
            
            if (group.includes && group.parentRow) {
                // This is a subtotal row (e.g., "Vendas (Produtos e Mercadorias)")
                const inRecebimentos = group.section === 'recebimentos' ? true : (group.section === 'pagamentos' ? false : null);
                const parentRowIndex = findRowIndex(group.parentRow, inRecebimentos);
                if (parentRowIndex === -1) return;
                
                let sum = 0;
                // Find all subcategory rows that belong to this parent
                for (let i = parentRowIndex + 1; i < rows.length; i++) {
                    const firstCell = rows[i].querySelector('td:first-child');
                    if (!firstCell) continue;
                    const rowName = firstCell.textContent.trim();
                    
                    // Stop if we hit another main category (not starting with '.')
                    if (!rowName.startsWith('.') && rowName !== '') {
                        break;
                    }
                    
                    // Check if this is one of the included subcategories
                    if (group.includes.includes(rowName)) {
                        sum += getCellValue(i, col);
                    }
                }
                
                setCellValue(parentRowIndex, col, sum);
            } else if (group.includes && !group.parentRow && groupName !== 'Saldo de TESOURARIA (Recebimentos - Pagamentos)') {
                // This is a total row (Total de Recebimentos or Total de Pagamentos)
                const totalRowIndex = findRowIndex(groupName);
                if (totalRowIndex === -1) return;
                
                let sum = 0;
                let inRecebimentos = groupName === 'Total de Recebimentos';
                
                group.includes.forEach(includedRow => {
                    // For "Estado e Outros Entes Públicos", use context from group section
                    if (includedRow === 'Estado e Outros Entes Públicos') {
                        const rowIndex = findRowIndex(includedRow, inRecebimentos);
                        if (rowIndex !== -1) {
                            sum += getCellValue(rowIndex, col);
                        }
                    } else {
                        const rowIndex = findRowIndex(includedRow, inRecebimentos);
                        if (rowIndex !== -1) {
                            sum += getCellValue(rowIndex, col);
                        }
                    }
                });
                
                setCellValue(totalRowIndex, col, sum);
            } else if (group.formula === 'recebimentos - pagamentos') {
                // Calculate Saldo
                const saldoRowIndex = findRowIndex(groupName);
                const recebimentosRowIndex = findRowIndex('Total de Recebimentos');
                const pagamentosRowIndex = findRowIndex('Total de Pagamentos');
                
                if (saldoRowIndex !== -1 && recebimentosRowIndex !== -1 && pagamentosRowIndex !== -1) {
                    const recebimentos = getCellValue(recebimentosRowIndex, col);
                    const pagamentos = getCellValue(pagamentosRowIndex, col);
                    const saldo = recebimentos - pagamentos;
                    setCellValue(saldoRowIndex, col, saldo);
                }
            }
        });
    }
}

// Function to calculate orcamento financeiro totals
function calculateOrcamentoFinanceiroTotals() {
    const table = document.querySelector('.spreadsheet-table');
    if (!table) return;
    
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    const data = spreadsheetData['orcamento-financeiro'];
    if (!data || !data.calculationGroups) return;
    
    // Helper function to find row index by name
    function findRowIndex(rowName) {
        for (let i = 0; i < rows.length; i++) {
            const firstCell = rows[i].querySelector('td:first-child');
            if (firstCell && firstCell.textContent.trim() === rowName) {
                return i;
            }
        }
        return -1;
    }
    
    // Helper function to get cell value
    function getCellValue(rowIndex, colIndex) {
        const row = rows[rowIndex];
        if (!row) return 0;
        const cell = row.querySelector(`td[data-col="${colIndex}"]`);
        if (!cell || cell.classList.contains('calculated')) return 0;
        return parseCellValue(cell.textContent);
    }
    
    // Helper function to set cell value
    function setCellValue(rowIndex, colIndex, value) {
        const row = rows[rowIndex];
        if (!row) return;
        const cell = row.querySelector(`td[data-col="${colIndex}"]`);
        if (cell) {
            cell.textContent = formatCurrency(value);
        }
    }
    
    // Calculate for each column (Ano 0 = col 1, 2022 = col 2, etc.)
    // Need to calculate in order: Saldo Inicial -> Totals -> Saldo FINANCEIRO
    for (let col = 1; col <= 6; col++) {
        // Step 1: Calculate Saldo Inicial (from previous year's Saldo FINANCEIRO)
        if (col > 1) {
            const saldoInicialRowIndex = findRowIndex('Saldo Inicial');
            const saldoFinanceiroRowIndex = findRowIndex('Saldo FINANCEIRO (1+2-3)');
            
            if (saldoInicialRowIndex !== -1 && saldoFinanceiroRowIndex !== -1) {
                const previousCol = col - 1;
                const saldoFinanceiroAnterior = getCellValue(saldoFinanceiroRowIndex, previousCol);
                setCellValue(saldoInicialRowIndex, col, saldoFinanceiroAnterior);
            }
        }
        
        // Step 2: Calculate totals (Total de Origens de Fundos and Total de Aplicações de Fundos)
        Object.keys(data.calculationGroups).forEach(groupName => {
            const group = data.calculationGroups[groupName];
            
            if (group.includes && !group.formula) {
                // This is a total row (Total de Origens de Fundos or Total de Aplicações de Fundos)
                const totalRowIndex = findRowIndex(groupName);
                if (totalRowIndex === -1) return;
                
                let sum = 0;
                group.includes.forEach(includedRow => {
                    const rowIndex = findRowIndex(includedRow);
                    if (rowIndex !== -1) {
                        sum += getCellValue(rowIndex, col);
                    }
                });
                
                setCellValue(totalRowIndex, col, sum);
            }
        });
        
        // Step 3: Calculate Saldo FINANCEIRO (Saldo Inicial + Total Origens - Total Aplicações)
        const saldoRowIndex = findRowIndex('Saldo FINANCEIRO (1+2-3)');
        const saldoInicialRowIndex = findRowIndex('Saldo Inicial');
        const totalOrigensRowIndex = findRowIndex('Total de Origens de Fundos');
        const totalAplicacoesRowIndex = findRowIndex('Total de Aplicações de Fundos');
        
        if (saldoRowIndex !== -1 && saldoInicialRowIndex !== -1 && totalOrigensRowIndex !== -1 && totalAplicacoesRowIndex !== -1) {
            const saldoInicial = getCellValue(saldoInicialRowIndex, col);
            const totalOrigens = getCellValue(totalOrigensRowIndex, col);
            const totalAplicacoes = getCellValue(totalAplicacoesRowIndex, col);
            const saldoFinanceiro = saldoInicial + totalOrigens - totalAplicacoes;
            setCellValue(saldoRowIndex, col, saldoFinanceiro);
        }
    }
}

// Function to calculate balanco totals
function calculateBalancoTotals() {
    const table = document.querySelector('.spreadsheet-table');
    if (!table) return;
    
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    const data = spreadsheetData['balanco'];
    if (!data || !data.calculationGroups) return;
    
    // Helper function to find row index by name (with section context for duplicates)
    function findRowIndex(rowName, section = null) {
        let currentSection = null;
        for (let i = 0; i < rows.length; i++) {
            const firstCell = rows[i].querySelector('td:first-child');
            if (!firstCell) continue;
            const currentRowName = firstCell.textContent.trim();
            
            // Track current section
            if (currentRowName === 'Passivo não corrente') {
                currentSection = 'passivo_nao_corrente';
            } else if (currentRowName === 'Passivo corrente') {
                currentSection = 'passivo_corrente';
            }
            
            if (currentRowName === rowName) {
                // For duplicate row names, check section
                if ((rowName === 'Financiamentos obtidos' || rowName === 'Outras dívidas a pagar') && section !== null) {
                    if (section === currentSection) {
                        return i;
                    }
                } else {
                    return i;
                }
            }
        }
        return -1;
    }
    
    // Helper function to get cell value
    function getCellValue(rowIndex, colIndex) {
        const row = rows[rowIndex];
        if (!row) return 0;
        const cell = row.querySelector(`td[data-col="${colIndex}"]`);
        if (!cell || cell.classList.contains('calculated')) return 0;
        return parseCellValue(cell.textContent);
    }
    
    // Helper function to set cell value
    function setCellValue(rowIndex, colIndex, value) {
        const row = rows[rowIndex];
        if (!row) return;
        const cell = row.querySelector(`td[data-col="${colIndex}"]`);
        if (cell) {
            cell.textContent = formatCurrency(value);
        }
    }
    
    // Calculate for each column (Ano 0 = col 1, 2022 = col 2, etc.)
    for (let col = 1; col <= 6; col++) {
        // Calculate subtotals and totals
        Object.keys(data.calculationGroups).forEach(groupName => {
            const group = data.calculationGroups[groupName];
            
            if (group.includes && !group.formula) {
                // This is a subtotal or total row
                const groupRowIndex = findRowIndex(groupName);
                if (groupRowIndex === -1) return;
                
                let sum = 0;
                
                // If group has startRow and endRow, sum rows between them
                if (group.startRow && group.endRow) {
                    const startIndex = findRowIndex(group.startRow, group.section);
                    const endIndex = findRowIndex(group.endRow, group.section);
                    
                    if (startIndex !== -1 && endIndex !== -1) {
                        for (let i = startIndex + 1; i <= endIndex; i++) {
                            const firstCell = rows[i].querySelector('td:first-child');
                            const rowName = firstCell ? firstCell.textContent.trim() : '';
                            
                            // Skip if it's the subtotal row itself or empty rows
                            if (rowName === groupName || rowName === '') continue;
                            
                            // Only sum rows that are in the includes list
                            if (group.includes.includes(rowName)) {
                                sum += getCellValue(i, col);
                            }
                        }
                    }
                } else {
                    // Sum all included rows (use section context for duplicates)
                    group.includes.forEach(includedRow => {
                        const section = group.section || null;
                        const rowIndex = findRowIndex(includedRow, section);
                        if (rowIndex !== -1) {
                            sum += getCellValue(rowIndex, col);
                        }
                    });
                }
                
                setCellValue(groupRowIndex, col, sum);
            } else if (group.formula === 'ativo - (capital_proprio + passivo)') {
                // Calculate Controlo
                const controleRowIndex = findRowIndex(groupName);
                const totalAtivoRowIndex = findRowIndex('Total do Ativo');
                const totalCapitalProprioRowIndex = findRowIndex('Total do Capital Próprio');
                const totalPassivoRowIndex = findRowIndex('Total do Passivo');
                
                if (controleRowIndex !== -1 && totalAtivoRowIndex !== -1 && totalCapitalProprioRowIndex !== -1 && totalPassivoRowIndex !== -1) {
                    const ativo = getCellValue(totalAtivoRowIndex, col);
                    const capitalProprio = getCellValue(totalCapitalProprioRowIndex, col);
                    const passivo = getCellValue(totalPassivoRowIndex, col);
                    const controle = ativo - (capitalProprio + passivo);
                    setCellValue(controleRowIndex, col, controle);
                }
            }
        });
    }
}

// Function to calculate resultados totals
function calculateResultadosTotals() {
    const table = document.querySelector('.spreadsheet-table');
    if (!table) return;
    
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    const data = spreadsheetData['resultados'];
    if (!data || !data.calculationGroups) return;
    
    // Helper function to find row index by name
    function findRowIndex(rowName) {
        for (let i = 0; i < rows.length; i++) {
            const firstCell = rows[i].querySelector('td:first-child');
            if (firstCell && firstCell.textContent.trim() === rowName) {
                return i;
            }
        }
        return -1;
    }
    
    // Helper function to get cell value
    function getCellValue(rowIndex, colIndex) {
        const row = rows[rowIndex];
        if (!row) return 0;
        const cell = row.querySelector(`td[data-col="${colIndex}"]`);
        if (!cell || cell.classList.contains('calculated')) return 0;
        return parseCellValue(cell.textContent);
    }
    
    // Helper function to set cell value
    function setCellValue(rowIndex, colIndex, value) {
        const row = rows[rowIndex];
        if (!row) return;
        const cell = row.querySelector(`td[data-col="${colIndex}"]`);
        if (cell) {
            cell.textContent = formatCurrency(value);
        }
    }
    
    // Calculate for each column (Ano 0 = col 1, 2022 = col 2, etc.)
    for (let col = 1; col <= 6; col++) {
        // Calculate subtotals and totals
        Object.keys(data.calculationGroups).forEach(groupName => {
            const group = data.calculationGroups[groupName];
            
            if (group.includes && group.parentRow) {
                // This is a subtotal row (e.g., "Vendas", "Gastos com o Pessoal")
                const parentRowIndex = findRowIndex(group.parentRow);
                if (parentRowIndex === -1) return;
                
                let sum = 0;
                // Find all subcategory rows that belong to this parent
                for (let i = parentRowIndex + 1; i < rows.length; i++) {
                    const firstCell = rows[i].querySelector('td:first-child');
                    if (!firstCell) continue;
                    const rowName = firstCell.textContent.trim();
                    
                    // Stop if we hit another main category or header
                    if (rowName === '' || rowName === 'RENDIMENTOS' || rowName === 'GASTOS' || rowName === 'RESULTADOS') {
                        break;
                    }
                    
                    // Stop if we hit another subtotal or total row
                    if (rowName === 'TOTAL dos Rendimentos' || rowName === 'TOTAL dos Gastos de Exploração' || 
                        rowName.startsWith('RESULTADO') || rowName === 'Gastos com o Pessoal') {
                        if (!group.includes.includes(rowName) && rowName !== group.parentRow) {
                            break;
                        }
                    }
                    
                    // Check if this is one of the included subcategories
                    if (group.includes.includes(rowName)) {
                        sum += getCellValue(i, col);
                    }
                }
                
                setCellValue(parentRowIndex, col, sum);
            } else if (group.includes && !group.formula) {
                // This is a total row (TOTAL dos Rendimentos, TOTAL dos Gastos de Exploração)
                const totalRowIndex = findRowIndex(groupName);
                if (totalRowIndex === -1) return;
                
                let sum = 0;
                group.includes.forEach(includedRow => {
                    const rowIndex = findRowIndex(includedRow);
                    if (rowIndex !== -1) {
                        sum += getCellValue(rowIndex, col);
                    }
                });
                
                setCellValue(totalRowIndex, col, sum);
            } else if (group.formula) {
                // Calculate formulas
                const formulaRowIndex = findRowIndex(groupName);
                if (formulaRowIndex === -1) return;
                
                let result = 0;
                
                if (group.formula === 'rendimentos - gastos_exploracao') {
                    // EBITDA
                    const rendimentos = getCellValue(findRowIndex('TOTAL dos Rendimentos'), col);
                    const gastos = getCellValue(findRowIndex('TOTAL dos Gastos de Exploração'), col);
                    result = rendimentos - gastos;
                } else if (group.formula === 'ebitda - depreciacoes - imparidade_depreciaveis') {
                    // EBIT
                    const ebitda = getCellValue(findRowIndex('RESULTADO antes de depreciações e gastos de financiamento (EBITDA)'), col);
                    const depreciacoes = getCellValue(findRowIndex('Gastos/Reversões de depreciação e de amortização'), col);
                    const imparidade = getCellValue(findRowIndex('Imparidade de invest. depreciáveis / amortiz. (perdas / reversões)'), col);
                    result = ebitda - depreciacoes - imparidade;
                } else if (group.formula === 'ebit + juros_obtidos - juros_suportados') {
                    // Resultado antes de Impostos
                    const ebit = getCellValue(findRowIndex('RESULTADO Operacional (EBIT)'), col);
                    const jurosObtidos = getCellValue(findRowIndex('Juros e Rendimentos similares obtidos'), col);
                    const jurosSuportados = getCellValue(findRowIndex('Juros e Gastos similares suportados'), col);
                    result = ebit + jurosObtidos - jurosSuportados;
                } else if (group.formula === 'resultado_antes_impostos') {
                    // Resultados acumulados
                    const resultadoAntes = getCellValue(findRowIndex('RESULTADO antes de Impostos'), col);
                    result = resultadoAntes;
                } else if (group.formula === 'resultado_antes_impostos - imposto_rendimento') {
                    // Resultado Líquido do Período
                    const resultadoAntes = getCellValue(findRowIndex('RESULTADO antes de Impostos'), col);
                    const imposto = getCellValue(findRowIndex('Imposto sobre o rendimento do período'), col);
                    result = resultadoAntes - imposto;
                } else if (group.formula === 'resultado_liquido - dividendos') {
                    // Resultado Líquido Retido
                    const resultadoLiquido = getCellValue(findRowIndex('RESULTADO Líquido do Período'), col);
                    const dividendos = getCellValue(findRowIndex('Dividendos'), col);
                    result = resultadoLiquido - dividendos;
                }
                
                setCellValue(formulaRowIndex, col, result);
            }
        });
    }
}

// Function to create investment chart
let investmentChart = null;

function createInvestmentChart() {
    const canvas = document.getElementById('investment-chart');
    if (!canvas) return;
    
    const table = document.querySelector('.spreadsheet-table');
    if (!table) return;
    
    // Use investimento data for chart (resumo uses same data)
    const data = spreadsheetData['investimento'];
    if (!data) return;
    
    // Get data from Ano 0 column
    const rows = table.querySelectorAll('tbody tr');
    const labels = [];
    const values = [];
    const colors = [
        '#3B82F6', '#EF4444', '#10B981', '#8B5CF6', '#F59E0B',
        '#06B6D4', '#EC4899', '#84CC16', '#F97316', '#6366F1',
        '#14B8A6', '#A855F7', '#F43F5E', '#22C55E'
    ];
    
    rows.forEach((row, index) => {
        const firstCell = row.querySelector('td:first-child');
        if (!firstCell) return;
        
        const rowName = firstCell.textContent.trim();
        
        // Skip headers, subtotals, and total
        if (data.rowTypes && (data.rowTypes[rowName] === 'header' || data.rowTypes[rowName] === 'subtotal' || data.rowTypes[rowName] === 'total')) {
            return;
        }
        
        // Get value from Ano 0 column (column index 1)
        const cell = row.querySelector('td[data-col="1"]');
        if (cell && !cell.classList.contains('calculated')) {
            const value = parseCellValue(cell.textContent);
            if (value > 0) {
                labels.push(rowName);
                values.push(value);
            }
        }
    });
    
    // Destroy existing chart
    if (investmentChart) {
        investmentChart.destroy();
    }
    
    // Create new chart
    const ctx = canvas.getContext('2d');
    investmentChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: colors.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(2);
                            return `${label}: €${value.toLocaleString('pt-PT', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Function to create spreadsheet table
function createSpreadsheet(dataKey) {
    const data = spreadsheetData[dataKey] || spreadsheetData['pressupostos'];
    const content = document.getElementById('spreadsheet-content');
    
    // Regenerate headers based on current project config (use global projectConfig)
    if (data.headers) {
        // Update headers dynamically based on project config
        // Find base headers (non-year columns)
        const baseHeaders = [];
        let hasAno0 = false;
        let hasTotal = false;
        
        data.headers.forEach(h => {
            if (h === 'Ano 0') {
                hasAno0 = true;
            } else if (h === 'Total') {
                hasTotal = true;
            } else if (!h.match(/\d{4}/) && !h.includes('Inicial')) {
                baseHeaders.push(h);
            }
        });
        
        // Generate year headers (without Ano 0, as it's separate)
        const yearHeaders = generateYearHeaders(null, false, null);
        if (hasAno0) {
            data.headers = [...baseHeaders, 'Ano 0', ...yearHeaders];
        } else if (hasTotal) {
            data.headers = [...baseHeaders, ...yearHeaders, 'Total'];
        } else {
            data.headers = [...baseHeaders, ...yearHeaders];
        }
    }
    
    // Show/hide equipment action buttons
    const equipmentActions = document.getElementById('equipment-actions');
    if (equipmentActions) {
        if (data.isEquipment) {
            equipmentActions.classList.remove('hidden');
            equipmentActions.style.display = 'flex'; // Force display
            // Store current dataKey for equipment operations
            equipmentActions.setAttribute('data-current-sheet', dataKey);
        } else {
            equipmentActions.classList.add('hidden');
            equipmentActions.style.display = 'none'; // Force hide
        }
    } else {
        console.warn('Elemento equipment-actions não encontrado');
    }
    
    // Show/hide chart toggle and container for investimento (only for resumo)
    const chartToggle = document.getElementById('chart-toggle-container');
    const chartContainer = document.getElementById('chart-container');
    
    if (dataKey === 'investimento' || dataKey === 'investimento-resumo') {
        chartToggle.classList.remove('hidden');
        const isChecked = document.getElementById('chart-toggle').checked;
        if (isChecked) {
            chartContainer.classList.remove('hidden');
        } else {
            chartContainer.classList.add('hidden');
        }
    } else if (dataKey === 'depreciacoes' || dataKey === 'depreciacoes-resumo') {
        chartToggle.classList.remove('hidden');
        const isChecked = document.getElementById('chart-toggle').checked;
        if (isChecked) {
            chartContainer.classList.remove('hidden');
        } else {
            chartContainer.classList.add('hidden');
        }
    } else {
        chartToggle.classList.add('hidden');
        chartContainer.classList.add('hidden');
    }
    
    // Row mapping for special handling
    const rowMapping = {
        'Taxa de Inflação': { editable: true, triggers_recalc: true },
        'Índice de Inflação': { 
            editable: [1], // Only initial column (index 1 = primeiroAno) is editable
            calculated: true, 
            formula: 'inflation_index',
            calculated_columns: [] // Will be set dynamically based on numAnos
        },
        'Reservas de Segurança de Tesouraria (RST)': { editable: true, calculated: false }
    };
    
    // Set calculated columns dynamically for Índice de Inflação
    if (rowMapping['Índice de Inflação']) {
        const numAnos = projectConfig.numAnos || 5;
        for (let i = 2; i <= numAnos + 1; i++) {
            rowMapping['Índice de Inflação'].calculated_columns.push(i);
        }
    }
    
    let html = '';
    
    // Add monetary unit info for investimento, tesouraria, orcamento-financeiro, balanco and resultados
    const unidadeMonetaria = projectConfig.unidadeMonetaria || 'EUR';
    if (dataKey === 'investimento' || dataKey === 'tesouraria' || dataKey === 'orcamento-financeiro' || dataKey === 'balanco' || dataKey === 'resultados' || data.isEquipment) {
        html += `<div class="mb-2 text-sm text-gray-600 dark:text-gray-400 px-2">Unidade Monetária: ${unidadeMonetaria}</div>`;
    }
    
    html += '<table class="spreadsheet-table">';
    
    // Header row
    html += '<thead><tr>';
    if (dataKey === 'investimento') {
        html += '<th style="text-align: left; padding-left: 12px;">MAPA DE INVESTIMENTOS</th>';
        data.headers.slice(1).forEach(header => {
            html += `<th>${header}</th>`;
        });
    } else if (data.isEquipment) {
        // Equipment sheets: First column is the equipment type - Investimento
        const equipmentType = data.equipmentType || 'Equipamento';
        html += `<th style="text-align: left; padding-left: 12px; background-color: #E3F2FD;">${equipmentType} - Investimento</th>`;
        data.headers.slice(1).forEach(header => {
            html += `<th style="background-color: #2196F3; color: white;">${header}</th>`;
        });
    } else {
        data.headers.forEach(header => {
            html += `<th>${header}</th>`;
        });
    }
    html += '</tr></thead>';
    
    // Body rows
    html += '<tbody>';
    
    // For equipment sheets, render equipment rows
    if (data.isEquipment) {
        if (!data.rows || data.rows.length === 0) {
            // Empty state - show placeholder row
            const numCols = data.headers.length;
            html += '<tr class="equipment-row empty-row" data-equipment-id="">';
            html += `<td style="background-color: #FFF9C4; padding: 8px; text-align: center; color: #999;">Nenhum equipamento adicionado</td>`;
            for (let i = 1; i < numCols; i++) {
                html += `<td style="background-color: #FFF9C4; padding: 8px;" data-col="${i}"></td>`;
            }
            html += '</tr>';
        } else {
            // Render equipment rows
            data.rows.forEach((row, rowIndex) => {
                const equipmentId = row.equipmentId || `equipment-${rowIndex}`;
                const equipmentName = Array.isArray(row) ? row[0] : row.name || '';
                const equipmentValues = Array.isArray(row) ? row.slice(1) : row.values || [];
                
                html += `<tr class="equipment-row" data-equipment-id="${equipmentId}" data-row-index="${rowIndex}">`;
                // Equipment name column
                html += `<td style="background-color: #E3F2FD; padding: 8px; font-weight: 500;" class="equipment-name-cell">${equipmentName || ''}</td>`;
                // Value columns
                equipmentValues.forEach((value, colIndex) => {
                    html += `<td style="padding: 8px;" data-col="${colIndex + 1}" contenteditable="true" class="editable equipment-value-cell">${value || '0,00'}</td>`;
                });
                html += '</tr>';
            });
        }
    } else {
        // Regular spreadsheet rows
        data.rows.forEach((row, rowIndex) => {
        const rowName = row[0];
        const rowConfig = rowMapping[rowName] || { editable: true };
        const rowType = data.rowTypes && data.rowTypes[rowName];
        
        // Determine row style
        let rowClass = '';
        let rowStyle = '';
        if (rowType === 'header') {
            rowClass = 'font-bold text-gray-800 dark:text-white bg-gray-200 dark:bg-gray-700';
            rowStyle = 'background-color: #e5e7eb;';
        } else if (rowType === 'subtotal') {
            rowClass = 'font-semibold bg-blue-50 dark:bg-blue-900/20';
            rowStyle = 'background-color: #eff6ff;';
        } else if (rowType === 'total' || rowType === 'total_recebimentos' || rowType === 'total_pagamentos' || rowType === 'total_origens' || rowType === 'total_aplicacoes' || rowType === 'total_ativo' || rowType === 'total_capital_proprio' || rowType === 'total_passivo' || rowType === 'total_capital_passivo' || rowType === 'total_rendimentos' || rowType === 'total_gastos') {
            rowClass = 'font-bold bg-yellow-50 dark:bg-yellow-900/20';
            rowStyle = 'background-color: #fefce8;';
        } else if (rowType === 'saldo' || rowType === 'saldo_financeiro' || rowType === 'ebitda' || rowType === 'ebit' || rowType === 'resultado_antes_impostos' || rowType === 'resultado_liquido' || rowType === 'resultado_liquido_retido') {
            rowClass = 'font-bold bg-green-50 dark:bg-green-900/20';
            rowStyle = 'background-color: #f0fdf4;';
        } else if (rowType === 'saldo_inicial') {
            rowClass = 'font-semibold bg-blue-50 dark:bg-blue-900/20';
            rowStyle = 'background-color: #eff6ff;';
        } else if (rowType === 'controle') {
            rowClass = 'font-bold bg-red-50 dark:bg-red-900/20';
            rowStyle = 'background-color: #fef2f2; border-top: 2px dashed #ef4444;';
        } else if (rowName.startsWith('.')) {
            // Subcategory rows - indent them
            rowStyle = 'padding-left: 30px;';
        } else if (dataKey === 'balanco' && rowType !== 'header' && rowType !== 'subtotal' && rowType !== 'total_ativo' && rowType !== 'total_capital_proprio' && rowType !== 'total_passivo' && rowType !== 'total_capital_passivo' && rowType !== 'controle') {
            // Indent subcategories in balanco (items under Ativos não correntes, Ativos correntes, etc.)
            const parentRows = ['Ativos não correntes', 'Ativos correntes', 'Passivo não corrente', 'Passivo corrente'];
            const rowIndex = data.rows.findIndex(r => r[0] === rowName);
            if (rowIndex > 0) {
                const prevRowName = data.rows[rowIndex - 1][0];
                if (parentRows.includes(prevRowName)) {
                    rowStyle = 'padding-left: 20px;';
                }
            }
        } else if (dataKey === 'resultados' && rowType !== 'header' && rowType !== 'subtotal' && rowType !== 'total_rendimentos' && rowType !== 'total_gastos' && rowType !== 'ebitda' && rowType !== 'ebit' && rowType !== 'resultado_antes_impostos' && rowType !== 'resultado_liquido' && rowType !== 'resultado_liquido_retido' && rowType !== 'resultados_acumulados') {
            // Indent subcategories in resultados (items under Vendas, Gastos com o Pessoal)
            const parentRows = ['Vendas', 'Gastos com o Pessoal'];
            const rowIndex = data.rows.findIndex(r => r[0] === rowName);
            if (rowIndex > 0) {
                const prevRowName = data.rows[rowIndex - 1][0];
                if (parentRows.includes(prevRowName)) {
                    rowStyle = 'padding-left: 20px;';
                }
            }
        }
        
        html += `<tr class="${rowClass}" style="${rowStyle}">`;
        
        // Ensure row has correct number of cells based on project config
        const expectedCols = data.headers.length;
        while (row.length < expectedCols) {
            row.push('0,00');
        }
        row = row.slice(0, expectedCols);
        
        row.forEach((cell, colIndex) => {
            if (colIndex === 0) {
                // First column (parameter name) - not editable
                const fontWeight = rowType === 'header' || rowType === 'total' ? 'bold' : (rowType === 'subtotal' ? '600' : '500');
                html += `<td style="font-weight: ${fontWeight}; padding-left: ${rowType === 'header' ? '8px' : '20px'};">${cell || ''}</td>`;
            } else {
                const cellValue = cell || '';
                let cellClass = rowType === 'subtotal' || rowType === 'total' ? 'calculated' : 'editable';
                let cellAttrs = `data-row="${rowIndex}" data-col="${colIndex}"`;
                
                // Check if this cell should be calculated
                let isEditable = true;
                if (rowType === 'subtotal' || rowType === 'total' || rowType === 'total_recebimentos' || rowType === 'total_pagamentos' || rowType === 'total_origens' || rowType === 'total_aplicacoes' || rowType === 'total_ativo' || rowType === 'total_capital_proprio' || rowType === 'total_passivo' || rowType === 'total_capital_passivo' || rowType === 'total_rendimentos' || rowType === 'total_gastos' || rowType === 'saldo' || rowType === 'saldo_financeiro' || rowType === 'controle' || rowType === 'ebitda' || rowType === 'ebit' || rowType === 'resultado_antes_impostos' || rowType === 'resultado_liquido' || rowType === 'resultado_liquido_retido' || rowType === 'resultados_acumulados') {
                    // Subtotal, total, saldo, controle, and resultado rows are calculated
                    cellClass = 'calculated';
                    isEditable = false;
                } else if (rowType === 'saldo_inicial') {
                    // Saldo Inicial: Ano 0 is editable, other years are calculated
                    if (colIndex === 1) {
                        // Ano 0 - editable
                        isEditable = true;
                    } else {
                        // Other years - calculated
                        cellClass = 'calculated';
                        isEditable = false;
                    }
                } else if (rowConfig.calculated) {
                    if (Array.isArray(rowConfig.calculated_columns) && rowConfig.calculated_columns.includes(colIndex)) {
                        cellClass += ' calculated';
                        cellAttrs += ` data-formula="${rowConfig.formula}" data-year="${colIndex - 1}"`;
                        isEditable = false;
                    } else if (Array.isArray(rowConfig.editable) && !rowConfig.editable.includes(colIndex)) {
                        cellClass += ' calculated';
                        isEditable = false;
                    }
                } else if (rowConfig.editable === false) {
                    cellClass += ' calculated';
                    isEditable = false;
                }
                
                if (isEditable) {
                    // Editable cells
                    html += `<td class="${cellClass}" ${cellAttrs} contenteditable="true">${cellValue}</td>`;
                } else {
                    // Calculated cells are not directly editable
                    html += `<td class="${cellClass}" ${cellAttrs}>${cellValue}</td>`;
                }
            }
        });
        html += '</tr>';
        });
    }
    html += '</tbody>';
    
    html += '</table>';
    
    content.innerHTML = html;
    
    // Update title and subtitle
    document.getElementById('spreadsheet-title').textContent = data.title;
    document.getElementById('spreadsheet-subtitle').textContent = data.subtitle;
    
    // Add cell editing functionality
    setupCellEditing();
    
    // Setup equipment row selection and actions
    if (data.isEquipment) {
        try {
            // Clear any pending equipment loads
            if (equipmentLoadTimeout) {
                clearTimeout(equipmentLoadTimeout);
                equipmentLoadTimeout = null;
            }
            
            // Cancel any pending loads for other sheets
            pendingEquipmentLoads.clear();
            
            // Reset selection when changing sheets
            selectedEquipmentRow = null;
            
            setupEquipmentActions(dataKey);
            
            // Load equipment from backend (async, don't wait)
            // Use a small delay to ensure the sheet is fully rendered first
            equipmentLoadTimeout = setTimeout(() => {
                // Double-check we're still on the same sheet
                if (currentEquipmentSheet === dataKey) {
                    loadEquipmentFromBackend(dataKey).catch(err => {
                        console.error('Error loading equipment:', err);
                    });
                }
            }, 100);
        } catch (error) {
            console.error('Error setting up equipment actions:', error);
        }
    } else {
        // Not an equipment sheet, clear any pending loads
        if (equipmentLoadTimeout) {
            clearTimeout(equipmentLoadTimeout);
            equipmentLoadTimeout = null;
        }
        pendingEquipmentLoads.clear();
        selectedEquipmentRow = null;
    }
    
    // Initial calculation
    if (dataKey === 'pressupostos') {
        setTimeout(() => recalculateFormulas(), 100);
    } else if (dataKey === 'investimento' || dataKey === 'investimento-resumo') {
        // Update summary from all equipment sheets first
        updateInvestmentSummary();
        setTimeout(() => {
            calculateInvestmentTotals();
            if (document.getElementById('chart-toggle')?.checked) {
                createInvestmentChart();
            }
        }, 100);
    } else if (dataKey === 'tesouraria') {
        setTimeout(() => {
            calculateTesourariaTotals();
        }, 100);
    } else if (dataKey === 'orcamento-financeiro') {
        setTimeout(() => {
            calculateOrcamentoFinanceiroTotals();
        }, 100);
    } else if (dataKey === 'balanco') {
        setTimeout(() => {
            calculateBalancoTotals();
        }, 100);
    } else if (dataKey === 'resultados') {
        setTimeout(() => {
            calculateResultadosTotals();
        }, 100);
    }
    
    // Scroll to top
    content.scrollTop = 0;
    content.scrollLeft = 0;
}

// Setup cell editing
function setupCellEditing() {
    const cells = document.querySelectorAll('.spreadsheet-table td.editable');
    let currentCell = null;
    
    cells.forEach(cell => {
        cell.addEventListener('click', function() {
            if (currentCell) {
                currentCell.classList.remove('editing');
            }
            this.classList.add('editing');
            currentCell = this;
            this.focus();
        });
        
        cell.addEventListener('blur', function() {
            this.classList.remove('editing');
            
            // Format value if it's an equipment value cell
            if (this.classList.contains('equipment-value-cell')) {
                const value = parseCellValue(this.textContent);
                this.textContent = formatCurrency(value);
                
                // Update data in spreadsheetData
                const row = this.closest('.equipment-row');
                if (row) {
                    const rowIndex = parseInt(row.getAttribute('data-row-index'));
                    const colIndex = parseInt(this.getAttribute('data-col'));
                    const dataKey = document.getElementById('equipment-actions')?.getAttribute('data-current-sheet');
                    if (dataKey && spreadsheetData[dataKey] && spreadsheetData[dataKey].rows[rowIndex]) {
                        spreadsheetData[dataKey].rows[rowIndex][colIndex] = formatCurrency(value);
                        
                        // Auto-save to backend after a short delay (debounce)
                        clearTimeout(window.equipmentAutoSaveTimeout);
                        window.equipmentAutoSaveTimeout = setTimeout(() => {
                            saveEquipmentToBackend(dataKey);
                            // Update investment/depreciation summary in real-time
                            if (dataKey && dataKey.startsWith('depreciacoes-')) {
                                updateDepreciationSummary();
                            } else if (dataKey && !dataKey.startsWith('iva-')) {
                                updateInvestmentSummary();
                            }
                        }, 1000); // Save 1 second after last edit
                    }
                }
                return;
            }
            
            // Check if this is a cell that triggers recalculation
            const row = this.parentElement;
            const rowName = row.querySelector('td:first-child')?.textContent.trim();
            
            // Recalculate if inflation rate or initial inflation index changed
            if (rowName === 'Taxa de Inflação' || rowName === 'Índice de Inflação') {
                recalculateFormulas();
            }
            
            // Recalculate investment totals if investment sheet
            const currentSheet = document.getElementById('spreadsheet-subtitle')?.textContent;
            if (currentSheet && currentSheet.includes('Investimentos')) {
                calculateInvestmentTotals();
                // Update chart if visible
                if (document.getElementById('chart-toggle').checked) {
                    createInvestmentChart();
                }
            }
            
            // Recalculate tesouraria totals if tesouraria sheet
            if (currentSheet && currentSheet.includes('Tesouraria')) {
                calculateTesourariaTotals();
            }
            
            // Recalculate orcamento financeiro totals if orcamento financeiro sheet
            if (currentSheet && currentSheet.includes('Orçamento Financeiro')) {
                calculateOrcamentoFinanceiroTotals();
            }
            
            // Recalculate balanco totals if balanco sheet
            if (currentSheet && currentSheet.includes('Balanço')) {
                calculateBalancoTotals();
            }
            
            // Recalculate resultados totals if resultados sheet
            if (currentSheet && currentSheet.includes('Resultados')) {
                calculateResultadosTotals();
            }
            
            // Send update to backend if needed
            const rowIndex = this.getAttribute('data-row');
            const colIndex = this.getAttribute('data-col');
            if (rowIndex !== null && colIndex !== null) {
                updateBackendCell(rowName, parseInt(colIndex), this.textContent);
            }
        });
        
        cell.addEventListener('input', function() {
            // Real-time validation could go here
        });
        
        cell.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                this.blur();
                // Move to next row
                const row = this.parentElement;
                const nextRow = row.nextElementSibling;
                if (nextRow) {
                    const nextCell = nextRow.querySelector(`td[data-col="${this.getAttribute('data-col')}"]`);
                    if (nextCell && !nextCell.classList.contains('calculated')) {
                        nextCell.click();
                    }
                }
            } else if (e.key === 'Tab') {
                e.preventDefault();
                const col = parseInt(this.getAttribute('data-col'));
                const nextCol = col + 1;
                const nextCell = this.parentElement.querySelector(`td[data-col="${nextCol}"]`);
                if (nextCell && !nextCell.classList.contains('calculated')) {
                    nextCell.click();
                }
            } else if (e.key === 'Escape') {
                this.blur();
            }
        });
    });
}

// Function to update backend
async function updateBackendCell(rowName, colIndex, value) {
    try {
        const response = await fetch('/api/spreadsheet/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                row_name: rowName,
                column_index: colIndex,
                value: value,
                sheet: 'pressupostos'
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            // If backend returns calculated values, update them
            if (data.calculated_values) {
                Object.keys(data.calculated_values).forEach(key => {
                    const [row, col] = key.split('-');
                    setCellValue(row, parseInt(col), data.calculated_values[key]);
                });
            }
        }
    } catch (error) {
        console.log('Backend not available, using client-side calculations only');
    }
}

// Function to load data from backend
async function loadSpreadsheetFromBackend(dataKey) {
    try {
        const response = await fetch(`/api/spreadsheet/${dataKey}`);
        if (response.ok) {
            const data = await response.json();
            return data;
        }
    } catch (error) {
        console.log('Backend not available, using default data');
    }
    return null;
}

// Sidebar item click - show spreadsheet
document.querySelectorAll('[data-tab]').forEach(item => {
    item.addEventListener('click', (e) => {
        e.preventDefault();
        const tabName = item.getAttribute('data-tab');
        
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Hide tabs navigation
        document.querySelector('.mb-6.border-b').style.display = 'none';
        
        // Show spreadsheet area
        const spreadsheetArea = document.getElementById('spreadsheet-area');
        spreadsheetArea.classList.remove('hidden');
        
        // Map tab names to spreadsheet data keys
        const tabMapping = {
            'investimento-resumo': 'investimento',
            'depreciacoes-resumo': 'depreciacoes',
            'rendimentos-resumo': 'rendimentos',
            'ativos-tangiveis-terrenos': 'ativos-tangiveis-terrenos',
            'ativos-tangiveis-edificios': 'ativos-tangiveis-edificios',
            'ativos-tangiveis-equipamento-basico': 'ativos-tangiveis-equipamento-basico',
            'ativos-tangiveis-equipamento-transporte': 'ativos-tangiveis-equipamento-transporte',
            'ativos-tangiveis-equipamento-administrativo': 'ativos-tangiveis-equipamento-administrativo',
            'ativos-tangiveis-equipamentos-biologicos': 'ativos-tangiveis-equipamentos-biologicos',
            'iva-edificios': 'iva-edificios',
            'iva-equipamento-basico': 'iva-equipamento-basico',
            'iva-equipamento-transporte': 'iva-equipamento-transporte',
            'iva-equipamento-administrativo': 'iva-equipamento-administrativo',
            'iva-equipamentos-biologicos': 'iva-equipamentos-biologicos',
            'ativos-intangiveis-goodwill': 'ativos-intangiveis-goodwill',
            'ativos-intangiveis-projetos-desenvolvimento': 'ativos-intangiveis-projetos-desenvolvimento',
            'ativos-intangiveis-programas-computador': 'ativos-intangiveis-programas-computador',
            'ativos-intangiveis-propriedade-industrial': 'ativos-intangiveis-propriedade-industrial',
            'ativos-intangiveis-outros': 'ativos-intangiveis-outros',
            // Depreciações
            'depreciacoes-edificios': 'depreciacoes-edificios',
            'depreciacoes-equipamento-basico': 'depreciacoes-equipamento-basico',
            'depreciacoes-equipamento-transporte': 'depreciacoes-equipamento-transporte',
            'depreciacoes-equipamento-administrativo': 'depreciacoes-equipamento-administrativo',
            'depreciacoes-equipamentos-biologicos': 'depreciacoes-equipamentos-biologicos',
            'depreciacoes-outros-tangiveis': 'depreciacoes-outros-tangiveis',
            'depreciacoes-goodwill': 'depreciacoes-goodwill',
            'depreciacoes-projetos-desenvolvimento': 'depreciacoes-projetos-desenvolvimento',
            'depreciacoes-programas-computador': 'depreciacoes-programas-computador',
            'depreciacoes-propriedade-industrial': 'depreciacoes-propriedade-industrial',
            'depreciacoes-outros-intangiveis': 'depreciacoes-outros-intangiveis',
            // Rendimentos de Exploração
            'rendimentos-resumo-mercados': 'rendimentos-resumo-mercados',
            'vendas-produtos-mercado-1': 'vendas-produtos-mercado-1',
            'vendas-produtos-mercado-2': 'vendas-produtos-mercado-2',
            'vendas-produtos-mercado-3': 'vendas-produtos-mercado-3',
            'prestacao-servicos-mercado-1': 'prestacao-servicos-mercado-1',
            'prestacao-servicos-mercado-2': 'prestacao-servicos-mercado-2',
            'prestacao-servicos-mercado-3': 'prestacao-servicos-mercado-3',
            'vendas-mercados-mercado-1': 'vendas-mercados-mercado-1',
            'vendas-mercados-mercado-2': 'vendas-mercados-mercado-2',
            'vendas-mercados-mercado-3': 'vendas-mercados-mercado-3',
            'outros-rendimentos': 'outros-rendimentos',
            'iva-venda-produtos-mercado-1': 'iva-venda-produtos-mercado-1',
            'iva-venda-produtos-mercado-2': 'iva-venda-produtos-mercado-2',
            'iva-venda-produtos-mercado-3': 'iva-venda-produtos-mercado-3',
            'iva-prestacao-servicos-mercado-1': 'iva-prestacao-servicos-mercado-1',
            'iva-prestacao-servicos-mercado-2': 'iva-prestacao-servicos-mercado-2',
            'iva-prestacao-servicos-mercado-3': 'iva-prestacao-servicos-mercado-3',
            'iva-venda-mercados-mercado-1': 'iva-venda-mercados-mercado-1',
            'iva-venda-mercados-mercado-2': 'iva-venda-mercados-mercado-2',
            'iva-venda-mercados-mercado-3': 'iva-venda-mercados-mercado-3',
            // Gastos de Exploração
            'gastos-resumo': 'custos',
            'custo-mercadorias-mercado-1': 'custo-mercadorias-mercado-1',
            'custo-mercadorias-mercado-2': 'custo-mercadorias-mercado-2',
            'custo-mercadorias-mercado-3': 'custo-mercadorias-mercado-3',
            'consumo-materias-primas': 'consumo-materias-primas',
            'iva-compras-mercadorias-mercado-1': 'iva-compras-mercadorias-mercado-1',
            'iva-compras-mercadorias-mercado-2': 'iva-compras-mercadorias-mercado-2',
            'iva-compras-mercadorias-mercado-3': 'iva-compras-mercadorias-mercado-3',
            'iva-compras-materias-primas': 'iva-compras-materias-primas',
            // Fundo de Maneio
            'variacao-fundo-maneio': 'fundo',
            'credito-clientes': 'credito-clientes',
            'necessidades-inventario': 'necessidades-inventario',
            'credito-fornecedores': 'credito-fornecedores',
            'credito-eoep': 'credito-eoep',
            'calculo-iva': 'calculo-iva',
            // Financiamento do Projeto
            'origem-financiamento': 'origem-financiamento',
            'divida-total': 'divida-total',
            'divida-projeto-historica': 'divida-projeto-historica',
            'financiamentos-projeto': 'financiamentos-projeto',
            'amortizacoes-financiamentos-historicos': 'amortizacoes-financiamentos-historicos'
        };
        
        const dataKey = tabMapping[tabName] || tabName;
        
        // Clear any pending equipment operations when switching tabs
        if (equipmentLoadTimeout) {
            clearTimeout(equipmentLoadTimeout);
            equipmentLoadTimeout = null;
        }
        pendingEquipmentLoads.clear();
        selectedEquipmentRow = null;
        
        // Create spreadsheet based on tab name
        createSpreadsheet(dataKey);
        
        // Update breadcrumb
        const itemText = item.textContent.trim().replace(/^[•\s]+/, '');
        document.getElementById('breadcrumb-current').textContent = itemText;
        
        // Update active sidebar item
        document.querySelectorAll('.sidebar-item').forEach(si => {
            si.classList.remove('bg-primary/10', 'text-primary', 'dark:bg-primary/20');
        });
        item.classList.add('bg-primary/10', 'text-primary', 'dark:bg-primary/20');
    });
});

// Search functionality
const searchInput = document.getElementById('searchInput');
if (searchInput) {
    searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        // Implement search logic here
        console.log('Searching for:', searchTerm);
    });
}

// Mobile search toggle
const mobileSearchBtn = document.getElementById('mobileSearchBtn');
if (mobileSearchBtn) {
    mobileSearchBtn.addEventListener('click', () => {
        // Toggle mobile search bar
        alert('Funcionalidade de busca móvel - em desenvolvimento');
    });
}

// Close dropdowns when clicking outside
document.addEventListener('click', (e) => {
    // Language menu
    if (!e.target.closest('#langBtn') && !e.target.closest('#langMenu')) {
        document.getElementById('langMenu').classList.add('hidden');
    }
    
    // Notifications menu
    if (!e.target.closest('#notifBtn') && !e.target.closest('#notifMenu')) {
        document.getElementById('notifMenu').classList.add('hidden');
    }
    
    // Profile menu
    if (!e.target.closest('img[alt="Profile"]') && !e.target.closest('#profileMenu')) {
        document.getElementById('profileMenu').classList.add('hidden');
    }
});

// Smooth scroll for sidebar
const sidebar = document.getElementById('sidebar');
if (sidebar) {
    sidebar.addEventListener('scroll', () => {
        // Add any scroll effects here
    });
}

// Add loading animation
const style = document.createElement('style');
style.textContent = `
    @keyframes loading {
        0% { width: 0%; }
        100% { width: 100%; }
    }
`;
document.head.appendChild(style);

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + K for search
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        if (searchInput) {
            searchInput.focus();
        }
    }
    
    // Escape to close modals/dropdowns
    if (e.key === 'Escape') {
        document.getElementById('langMenu').classList.add('hidden');
        document.getElementById('notifMenu').classList.add('hidden');
        document.getElementById('profileMenu').classList.add('hidden');
    }
});

// Add intersection observer for animations
const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
};

const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            entry.target.style.opacity = '1';
            entry.target.style.transform = 'translateY(0)';
        }
    });
}, observerOptions);

// Observe all cards for scroll animations
document.querySelectorAll('.card-hover').forEach(card => {
    card.style.opacity = '0';
    card.style.transform = 'translateY(20px)';
    card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
    observer.observe(card);
});

// Chart toggle event (using event delegation)
document.addEventListener('change', (e) => {
    if (e.target && e.target.id === 'chart-toggle') {
        const chartContainer = document.getElementById('chart-container');
        if (e.target.checked) {
            chartContainer.classList.remove('hidden');
            createInvestmentChart();
        } else {
            chartContainer.classList.add('hidden');
        }
    }
});

// Initialize tooltips and other enhancements
document.addEventListener('DOMContentLoaded', () => {
    // Add hover effects to quick action buttons
    document.querySelectorAll('.menu-btn').forEach(btn => {
        btn.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.02)';
        });
        btn.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
    });
    
    // Load project config on page load (async)
    loadProjectConfig().then(() => {
        updateProjectDisplay();
    });
    
    // Novo Projeto Modal
    const btnNovoProjeto = document.getElementById('btn-novo-projeto');
    const modalNovoProjeto = document.getElementById('modal-novo-projeto');
    const btnFecharModal = document.getElementById('btn-fechar-modal');
    const btnCancelarProjeto = document.getElementById('btn-cancelar-projeto');
    const formNovoProjeto = document.getElementById('form-novo-projeto');
    
    // Open modal
    if (btnNovoProjeto) {
        btnNovoProjeto.addEventListener('click', () => {
            modalNovoProjeto.classList.remove('hidden');
        });
    }
    
    // Close modal
    function closeModal() {
        modalNovoProjeto.classList.add('hidden');
        formNovoProjeto.reset();
    }
    
    if (btnFecharModal) {
        btnFecharModal.addEventListener('click', closeModal);
    }
    
    if (btnCancelarProjeto) {
        btnCancelarProjeto.addEventListener('click', closeModal);
    }
    
    // Close modal on outside click
    modalNovoProjeto.addEventListener('click', (e) => {
        if (e.target === modalNovoProjeto) {
            closeModal();
        }
    });
    
    // PIN input validation - only numbers, max 4 digits (for new project form)
    const pinProjetoInput = document.getElementById('pin-projeto');
    if (pinProjetoInput) {
        pinProjetoInput.addEventListener('input', function(e) {
            // Remove any non-digit characters
            this.value = this.value.replace(/\D/g, '');
            // Limit to 4 digits
            if (this.value.length > 4) {
                this.value = this.value.slice(0, 4);
            }
        });
        
        pinProjetoInput.addEventListener('keypress', function(e) {
            // Only allow numbers
            if (!/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter'].includes(e.key)) {
                e.preventDefault();
            }
        });
    }
    
    // Submit form
    if (formNovoProjeto) {
        formNovoProjeto.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nomeProjeto = document.getElementById('nome-projeto').value.trim();
            const primeiroAno = parseInt(document.getElementById('primeiro-ano').value);
            const numAnos = parseInt(document.getElementById('num-anos').value);
            const unidadeMonetaria = document.getElementById('unidade-monetaria').value;
            
            // Get PIN - try multiple ways to ensure we get it
            let pinProjeto = '';
            if (pinProjetoInput) {
                pinProjeto = pinProjetoInput.value.trim();
            } else {
                const pinInputAlt = document.getElementById('pin-projeto');
                if (pinInputAlt) {
                    pinProjeto = pinInputAlt.value.trim();
                }
            }
            
            // Validate all fields
            if (!nomeProjeto) {
                alert('Por favor, preencha o nome do projeto.');
                document.getElementById('nome-projeto').focus();
                return;
            }
            
            if (!primeiroAno || isNaN(primeiroAno)) {
                alert('Por favor, preencha o primeiro ano.');
                document.getElementById('primeiro-ano').focus();
                return;
            }
            
            if (!numAnos || isNaN(numAnos)) {
                alert('Por favor, preencha o número de anos.');
                document.getElementById('num-anos').focus();
                return;
            }
            
            if (!unidadeMonetaria) {
                alert('Por favor, selecione a unidade monetária.');
                document.getElementById('unidade-monetaria').focus();
                return;
            }
            
            if (!pinProjeto) {
                alert('Por favor, preencha o PIN de 4 dígitos.');
                if (pinProjetoInput) {
                    pinProjetoInput.focus();
                } else {
                    const pinInputAlt = document.getElementById('pin-projeto');
                    if (pinInputAlt) pinInputAlt.focus();
                }
                return;
            }
            
            // Validate PIN: must be exactly 4 digits
            if (!/^\d{4}$/.test(pinProjeto)) {
                alert('O PIN deve conter exatamente 4 dígitos numéricos.');
                if (pinProjetoInput) {
                    pinProjetoInput.focus();
                } else {
                    const pinInputAlt = document.getElementById('pin-projeto');
                    if (pinInputAlt) pinInputAlt.focus();
                }
                return;
            }
            
            // Debug log
            console.log('Creating project with data:', {
                nome: nomeProjeto,
                primeiroAno: primeiroAno,
                numAnos: numAnos,
                unidadeMonetaria: unidadeMonetaria,
                pin: pinProjeto
            });
            
            try {
                // Create project via API
                const requestBody = {
                    nome: nomeProjeto,
                    primeiroAno: primeiroAno,
                    numAnos: numAnos,
                    unidadeMonetaria: unidadeMonetaria,
                    pin: pinProjeto
                };
                
                console.log('Sending request:', requestBody);
                
                const response = await fetch('/api/projects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                // Check if response is ok
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage = `Erro HTTP ${response.status}`;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.error || errorMessage;
                    } catch (e) {
                        errorMessage = errorText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // Save to localStorage for quick access
                    const newConfig = {
                        id: result.project.id,
                        nome: result.project.nome,
                        primeiroAno: result.project.primeiroAno,
                        numAnos: result.project.numAnos,
                        unidadeMonetaria: result.project.unidadeMonetaria
                    };
                    saveProjectConfig(newConfig);
                    
                    // Set as current project
                    try {
                        await fetch('/api/projects/current', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                projectId: result.project.id
                            })
                        });
                    } catch (e) {
                        console.warn('Could not set current project:', e);
                        // Continue anyway
                    }
                    
                    // Show success message
                    alert(result.message || `Projeto "${nomeProjeto}" criado com sucesso!`);
                    
                    // Close modal
                    closeModal();
                    
                    // Update page title or show project name
                    updateProjectDisplay();
                    
                    // Reload projects list if we're on the projects tab
                    const tabProjetos = document.getElementById('tab-projetos');
                    if (tabProjetos && tabProjetos.classList.contains('active')) {
                        loadAllProjects();
                    }
                } else {
                    alert(`Erro ao criar projeto: ${result.error || 'Erro desconhecido'}`);
                }
            } catch (error) {
                console.error('Error creating project:', error);
                let errorMessage = 'Erro ao conectar com o servidor.';
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMessage = 'Erro ao conectar com o servidor. Verifique se o backend está rodando na porta 5000.';
                } else {
                    errorMessage = `Erro: ${error.message}`;
                }
                alert(errorMessage);
            }
        });
    }
    
    // Update project display in UI
    function updateProjectDisplay() {
        if (projectConfig && projectConfig.nome) {
            // Update document title
            document.title = `${projectConfig.nome} - Viabiliza+África`;
            
            // You can also update a project name display in the header if needed
            const projectNameDisplay = document.getElementById('project-name-display');
            if (projectNameDisplay) {
                projectNameDisplay.textContent = projectConfig.nome;
            }
        }
    }
    
    // Load and display all projects
    async function loadAllProjects() {
        const container = document.getElementById('projects-list-container');
        if (!container) return;
        
        try {
            const response = await fetch('/api/projects');
            if (!response.ok) {
                throw new Error('Erro ao carregar projetos');
            }
            
            const result = await response.json();
            
            if (result.success && result.projects && result.projects.length > 0) {
                container.innerHTML = result.projects.map(project => {
                    const createdDate = project.createdAt ? new Date(project.createdAt) : new Date();
                    const formattedDate = createdDate.toLocaleDateString('pt-BR', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric'
                    });
                    
                    return `
                        <div class="flex items-center justify-between p-5 bg-gradient-to-r from-blue-50 to-blue-100/50 dark:from-blue-900/20 dark:to-blue-800/10 rounded-xl border border-blue-200 dark:border-blue-800 card-hover">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 gradient-blue rounded-xl flex items-center justify-center shadow-md">
                                    <i class="fas fa-folder text-white"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800 dark:text-white mb-1">${escapeHtml(project.nome)}</h4>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">
                                        <i class="fas fa-calendar mr-1"></i>${project.primeiroAno} • 
                                        <i class="fas fa-clock mr-1 ml-2"></i>${formattedDate} •
                                        <i class="fas fa-coins mr-1 ml-2"></i>${project.unidadeMonetaria}
                                    </p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="px-4 py-2 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 text-sm rounded-full font-medium">
                                    <i class="fas fa-lock mr-1"></i>PIN Protegido
                                </span>
                                <button onclick="selectProject(${project.id})" class="px-4 py-2 bg-primary text-white rounded-lg hover:opacity-90 transition-colors text-sm font-medium">
                                    <i class="fas fa-check mr-1"></i>Selecionar
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500 dark:text-gray-400">
                        <i class="fas fa-folder-open text-4xl mb-4 opacity-50"></i>
                        <p class="text-lg mb-2">Nenhum projeto encontrado</p>
                        <p class="text-sm">Crie seu primeiro projeto para começar!</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error loading projects:', error);
            container.innerHTML = `
                <div class="text-center py-12 text-red-500">
                    <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                    <p class="text-lg mb-2">Erro ao carregar projetos</p>
                    <p class="text-sm">${error.message}</p>
                </div>
            `;
        }
    }
    
    // Function to escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Function to select a project (with PIN verification)
    async function selectProject(projectId) {
        // Get project info to show name in PIN modal
        try {
            const projectResponse = await fetch(`/api/projects/${projectId}`);
            if (projectResponse.ok) {
                const projectResult = await projectResponse.json();
                if (projectResult.success) {
                    // Open PIN modal
                    openProjectWithPin(projectId, projectResult.project.nome);
                }
            }
        } catch (error) {
            console.error('Error loading project:', error);
            alert('Erro ao carregar informações do projeto');
        }
    }
    
    // Make selectProject available globally
    window.selectProject = selectProject;
    
    // Load projects when Projects tab is clicked
    const tabProjetos = document.getElementById('tab-projetos');
    const btnNovoProjetoList = document.getElementById('btn-novo-projeto-list');
    
    if (btnNovoProjetoList) {
        btnNovoProjetoList.addEventListener('click', () => {
            if (btnNovoProjeto) {
                btnNovoProjeto.click();
            }
        });
    }
    
    // Load recent projects for dashboard
    async function loadRecentProjects() {
        const container = document.getElementById('recent-projects-list');
        if (!container) return;
        
        try {
            const response = await fetch('/api/projects');
            if (!response.ok) {
                throw new Error('Erro ao carregar projetos');
            }
            
            const result = await response.json();
            
            if (result.success && result.projects && result.projects.length > 0) {
                // Get only the 3 most recent projects
                const recentProjects = result.projects.slice(0, 3);
                
                container.innerHTML = recentProjects.map((project, index) => {
                    const createdDate = project.createdAt ? new Date(project.createdAt) : new Date();
                    const daysAgo = Math.floor((new Date() - createdDate) / (1000 * 60 * 60 * 24));
                    let timeAgo = '';
                    if (daysAgo === 0) {
                        timeAgo = 'Hoje';
                    } else if (daysAgo === 1) {
                        timeAgo = 'Há 1 dia';
                    } else if (daysAgo < 7) {
                        timeAgo = `Há ${daysAgo} dias`;
                    } else if (daysAgo < 30) {
                        const weeks = Math.floor(daysAgo / 7);
                        timeAgo = weeks === 1 ? 'Há 1 semana' : `Há ${weeks} semanas`;
                    } else {
                        const months = Math.floor(daysAgo / 30);
                        timeAgo = months === 1 ? 'Há 1 mês' : `Há ${months} meses`;
                    }
                    
                    const colors = [
                        'from-blue-50 to-blue-100/50 dark:from-blue-900/20 dark:to-blue-800/10 border-blue-200 dark:border-blue-800',
                        'from-orange-50 to-orange-100/50 dark:from-orange-900/20 dark:to-orange-800/10 border-orange-200 dark:border-orange-800',
                        'from-purple-50 to-purple-100/50 dark:from-purple-900/20 dark:to-purple-800/10 border-purple-200 dark:border-purple-800'
                    ];
                    const icons = ['fa-building', 'fa-chart-pie', 'fa-briefcase'];
                    const colorClass = colors[index % colors.length];
                    const iconClass = icons[index % icons.length];
                    
                    // Escape project name for use in onclick attribute
                    const escapedNome = escapeHtml(project.nome).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    return `
                        <div class="flex items-center justify-between p-5 bg-gradient-to-r ${colorClass} rounded-xl border card-hover cursor-pointer" onclick="openProjectWithPin(${project.id}, '${escapedNome}')">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 gradient-blue rounded-xl flex items-center justify-center shadow-md">
                                    <i class="fas ${iconClass} text-white"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800 dark:text-white mb-1">${escapeHtml(project.nome)}</h4>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">
                                        <i class="fas fa-calendar mr-1"></i>${project.primeiroAno} • 
                                        <i class="fas fa-clock mr-1 ml-2"></i>${timeAgo}
                                    </p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="px-4 py-2 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 text-sm rounded-full font-medium">
                                    <i class="fas fa-lock mr-1"></i>PIN Protegido
                                </span>
                                <button class="p-2 text-gray-400 hover:text-primary transition-colors">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                        <i class="fas fa-folder-open text-4xl mb-4 opacity-50"></i>
                        <p class="text-lg mb-2">Nenhum projeto encontrado</p>
                        <p class="text-sm">Crie seu primeiro projeto para começar!</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error loading recent projects:', error);
            container.innerHTML = `
                <div class="text-center py-8 text-red-500">
                    <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                    <p class="text-lg mb-2">Erro ao carregar projetos</p>
                </div>
            `;
        }
    }
    
    // Function to open project with PIN verification
    async function openProjectWithPin(projectId, projectName) {
        const modalPin = document.getElementById('modal-pin');
        const pinProjectName = document.getElementById('pin-project-name');
        const pinError = document.getElementById('pin-error');
        
        // Set project name
        if (pinProjectName) {
            pinProjectName.textContent = projectName;
        }
        
        // Store project ID for verification
        if (modalPin) {
            modalPin.dataset.projectId = projectId;
        }
        
        // Show modal
        if (modalPin) {
            modalPin.classList.remove('hidden');
        }
        if (pinInput) {
            pinInput.value = '';
        }
        if (pinError) {
            pinError.classList.add('hidden');
        }
        
        // Focus on PIN input
        setTimeout(() => {
            if (pinInput) pinInput.focus();
        }, 100);
    }
    
    // Make openProjectWithPin available globally
    window.openProjectWithPin = openProjectWithPin;
    
    // Setup PIN modal
    const modalPin = document.getElementById('modal-pin');
    const formPin = document.getElementById('form-pin');
    const btnFecharModalPin = document.getElementById('btn-fechar-modal-pin');
    const btnCancelarPin = document.getElementById('btn-cancelar-pin');
    const pinInput = document.getElementById('pin-input');
    const pinError = document.getElementById('pin-error');
    
    function closePinModal() {
        if (modalPin) {
            modalPin.classList.add('hidden');
            if (formPin) formPin.reset();
            if (pinError) pinError.classList.add('hidden');
        }
    }
    
    if (btnFecharModalPin) {
        btnFecharModalPin.addEventListener('click', closePinModal);
    }
    
    if (btnCancelarPin) {
        btnCancelarPin.addEventListener('click', closePinModal);
    }
    
    if (modalPin) {
        modalPin.addEventListener('click', (e) => {
            if (e.target === modalPin) {
                closePinModal();
            }
        });
    }
    
    // PIN input validation
    if (pinInput) {
        pinInput.addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '');
            if (this.value.length > 4) {
                this.value = this.value.slice(0, 4);
            }
            if (pinError) pinError.classList.add('hidden');
        });
        
        pinInput.addEventListener('keypress', function(e) {
            if (!/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter'].includes(e.key)) {
                e.preventDefault();
            }
        });
    }
    
    // Submit PIN form
    if (formPin) {
        formPin.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const projectId = modalPin.dataset.projectId;
            const pin = pinInput.value.trim();
            
            if (!pin || pin.length !== 4) {
                pinError.textContent = 'Por favor, digite um PIN de 4 dígitos.';
                pinError.classList.remove('hidden');
                return;
            }
            
            try {
                const response = await fetch(`/api/projects/${projectId}/verify-pin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ pin: pin })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // PIN correto - selecionar projeto
                    closePinModal();
                    
                    // Set as current project
                    try {
                        await fetch('/api/projects/current', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                projectId: projectId
                            })
                        });
                    } catch (e) {
                        console.warn('Could not set current project:', e);
                    }
                    
                    // Reload project config
                    await loadProjectConfig();
                    updateProjectDisplay();
                    
                    alert(`Projeto "${result.project.nome}" acessado com sucesso!`);
                    
                    // Reload projects lists
                    loadAllProjects();
                    loadRecentProjects();
                } else {
                    // PIN incorreto
                    pinError.textContent = result.error || 'PIN incorreto. Tente novamente.';
                    pinError.classList.remove('hidden');
                    pinInput.value = '';
                    pinInput.focus();
                }
            } catch (error) {
                console.error('Error verifying PIN:', error);
                pinError.textContent = 'Erro ao verificar PIN. Tente novamente.';
                pinError.classList.remove('hidden');
            }
        });
    }
    
    // Load recent projects on page load
    loadRecentProjects();
    
    // Initialize project display
    updateProjectDisplay();
    
    // Equipment Management Functions
    setupEquipmentModal();
    setupEquipmentButtons();
    setupExportExcel();
    setupPrint();
    setupImportModal();
});

// Setup Import Excel Modal
function setupImportModal() {
    const modalImport = document.getElementById('modal-import');
    const btnImportExcel = document.getElementById('btn-import-excel');
    const btnCloseImport = document.getElementById('btn-close-import-modal');
    const btnCancelImport = document.getElementById('btn-cancel-import');
    const btnConfirmImport = document.getElementById('btn-confirm-import');
    const fileInput = document.getElementById('file-input');
    const dropZone = document.getElementById('drop-zone');
    const fileInfo = document.getElementById('file-info');
    const fileName = document.getElementById('file-name');
    const btnRemoveFile = document.getElementById('btn-remove-file');
    const importPreview = document.getElementById('import-preview');
    const previewContent = document.getElementById('preview-content');
    
    let selectedFile = null;
    let importData = null;
    let currentSheetKey = null;
    
    // Open modal
    if (btnImportExcel) {
        btnImportExcel.addEventListener('click', () => {
            // Get current sheet key from active equipment sheet
            if (currentEquipmentSheet) {
                currentSheetKey = currentEquipmentSheet;
            } else {
                // Fallback: try to get from active tab
                const activeSheet = document.querySelector('[data-tab].active');
                if (activeSheet) {
                    const tabName = activeSheet.getAttribute('data-tab');
                    // Map tab names to sheet keys (complete mapping)
                    const sheetKeyMap = {
                        'ativos-tangiveis-terrenos': 'ativos-tangiveis-terrenos',
                        'ativos-tangiveis-edificios': 'ativos-tangiveis-edificios',
                        'ativos-tangiveis-equipamento-basico': 'ativos-tangiveis-equipamento-basico',
                        'ativos-tangiveis-equipamento-transporte': 'ativos-tangiveis-equipamento-transporte',
                        'ativos-tangiveis-equipamento-administrativo': 'ativos-tangiveis-equipamento-administrativo',
                        'ativos-tangiveis-equipamentos-biologicos': 'ativos-tangiveis-equipamentos-biologicos',
                        'ativos-intangiveis-goodwill': 'ativos-intangiveis-goodwill',
                        'ativos-intangiveis-projetos-desenvolvimento': 'ativos-intangiveis-projetos-desenvolvimento',
                        'ativos-intangiveis-programas-computador': 'ativos-intangiveis-programas-computador',
                        'ativos-intangiveis-propriedade-industrial': 'ativos-intangiveis-propriedade-industrial',
                        'ativos-intangiveis-outros': 'ativos-intangiveis-outros'
                    };
                    currentSheetKey = sheetKeyMap[tabName] || 'imported_items';
                } else {
                    currentSheetKey = 'imported_items';
                }
            }
            
            modalImport.classList.remove('hidden');
            resetImportModal();
        });
    }
    
    // Close modal
    function closeModal() {
        modalImport.classList.add('hidden');
        resetImportModal();
    }
    
    function resetImportModal() {
        selectedFile = null;
        importData = null;
        fileInput.value = '';
        fileInfo.classList.add('hidden');
        importPreview.classList.add('hidden');
        btnConfirmImport.disabled = true;
    }
    
    if (btnCloseImport) btnCloseImport.addEventListener('click', closeModal);
    if (btnCancelImport) btnCancelImport.addEventListener('click', closeModal);
    
    if (modalImport) {
        modalImport.addEventListener('click', (e) => {
            if (e.target === modalImport) closeModal();
        });
    }
    
    // File input change
    if (fileInput) {
        fileInput.addEventListener('change', (e) => {
            handleFileSelect(e.target.files[0]);
        });
    }
    
    // Drop zone click
    if (dropZone) {
        dropZone.addEventListener('click', () => {
            fileInput.click();
        });
        
        // Drag and drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-primary', 'bg-primary/5');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-primary', 'bg-primary/5');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-primary', 'bg-primary/5');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });
    }
    
    // Remove file
    if (btnRemoveFile) {
        btnRemoveFile.addEventListener('click', () => {
            resetImportModal();
        });
    }
    
    // Handle file selection
    async function handleFileSelect(file) {
        if (!file) return;
        
        if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
            alert('Por favor, selecione um arquivo Excel (.xlsx ou .xls)');
            return;
        }
        
        selectedFile = file;
        fileName.textContent = file.name;
        fileInfo.classList.remove('hidden');
        btnConfirmImport.disabled = false;
        
        // Preview file contents
        try {
            const formData = new FormData();
            formData.append('file', file);
            
            // Get current project ID
            const projectId = projectConfig?.id;
            if (projectId) {
                formData.append('project_id', projectId);
            }
            if (currentSheetKey) {
                formData.append('sheet_key', currentSheetKey);
            }
            
            const response = await fetch('/api/import/excel', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                importData = result;
                
                // Show preview
                let previewHtml = `<p class="text-xs text-gray-600 dark:text-gray-400 mb-2"><strong>${result.count}</strong> itens encontrados</p>`;
                if (result.preview && result.preview.length > 0) {
                    previewHtml += '<div class="space-y-1">';
                    const currency = projectConfig?.unidadeMonetaria || 'AOA';
                    result.preview.forEach((item, index) => {
                        // Format values with AOA format (comma as decimal separator)
                        const unitPrice = item.unit_price ? item.unit_price.toFixed(2).replace('.', ',') : '0,00';
                        const total = item.total ? item.total.toFixed(2).replace('.', ',') : '0,00';
                        previewHtml += `
                            <div class="text-xs p-1 bg-white dark:bg-gray-600 rounded">
                                ${index + 1}. ${item.description} - ${item.quantity}x ${unitPrice} ${currency} = ${total} ${currency}
                            </div>
                        `;
                    });
                    if (result.count > 5) {
                        previewHtml += `<p class="text-xs text-gray-500 mt-1">... e mais ${result.count - 5} itens</p>`;
                    }
                    previewHtml += '</div>';
                }
                previewContent.innerHTML = previewHtml;
                importPreview.classList.remove('hidden');
            } else {
                alert(`Erro ao processar arquivo: ${result.error || 'Erro desconhecido'}`);
                resetImportModal();
            }
        } catch (error) {
            console.error('Error previewing file:', error);
            alert('Erro ao processar arquivo. Verifique o console para mais detalhes.');
            resetImportModal();
        }
    }
    
    // Confirm import
    if (btnConfirmImport) {
        btnConfirmImport.addEventListener('click', async () => {
            if (!selectedFile || !importData) {
                alert('Por favor, selecione um arquivo primeiro.');
                return;
            }
            
            try {
                btnConfirmImport.disabled = true;
                btnConfirmImport.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Importando...';
                
                const formData = new FormData();
                formData.append('file', selectedFile);
                
                const projectId = projectConfig?.id;
                if (projectId) {
                    formData.append('project_id', projectId);
                }
                if (currentSheetKey) {
                    formData.append('sheet_key', currentSheetKey);
                }
                
                const response = await fetch('/api/import/excel', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const savedCount = result.saved || result.count;
                    const sheetName = result.sheet_name || getSheetDisplayName(currentSheetKey);
                    const currency = result.currency || projectConfig?.unidadeMonetaria || 'AOA';
                    const totalValue = result.total_formatted || '0,00';
                    
                    // Show detailed success message
                    let message = `✅ ${savedCount} itens importados com sucesso!\n\n`;
                    message += `📁 Localização: ${sheetName}\n`;
                    message += `💰 Moeda: ${currency}\n`;
                    message += `💵 Valor Total: ${totalValue} ${currency}\n\n`;
                    message += `Os dados foram salvos e estão disponíveis na aba "${sheetName}".\n`;
                    message += `Recarregue a aba para visualizar os itens importados.`;
                    
                    alert(message);
                    
                    // Reload equipment if on equipment sheet
                    if (currentSheetKey) {
                        // Update currentEquipmentSheet to match
                        if (currentEquipmentSheet !== currentSheetKey) {
                            currentEquipmentSheet = currentSheetKey;
                        }
                        // Reload the spreadsheet to show imported data
                        setTimeout(() => {
                            loadEquipmentFromBackend(currentSheetKey).then(() => {
                                createSpreadsheet(currentSheetKey);
                            }).catch(err => {
                                console.error('Error reloading equipment:', err);
                                // Still recreate spreadsheet even if load fails
                                createSpreadsheet(currentSheetKey);
                            });
                        }, 500);
                    }
                    
                    closeModal();
                } else {
                    alert(`Erro ao importar: ${result.error || 'Erro desconhecido'}`);
                    btnConfirmImport.disabled = false;
                    btnConfirmImport.innerHTML = '<i class="fas fa-file-import mr-2"></i>Importar';
                }
            } catch (error) {
                console.error('Error importing file:', error);
                alert('Erro ao importar arquivo. Verifique o console para mais detalhes.');
                btnConfirmImport.disabled = false;
                btnConfirmImport.innerHTML = '<i class="fas fa-file-import mr-2"></i>Importar';
            }
        });
    }
}

// Helper function to get display name for sheet key
function getSheetDisplayName(sheetKey) {
    const sheetNames = {
        'ativos-tangiveis-terrenos': 'Terrenos e Recursos Naturais',
        'ativos-tangiveis-edificios': 'Edifícios e Outras Construções',
        'ativos-tangiveis-equipamento-basico': 'Equipamento Básico',
        'ativos-tangiveis-equipamento-transporte': 'Equipamento de Transporte',
        'ativos-tangiveis-equipamento-administrativo': 'Equipamento Administrativo',
        'ativos-tangiveis-equipamentos-biologicos': 'Equipamentos Biológicos',
        'ativos-intangiveis-goodwill': 'Goodwill',
        'ativos-intangiveis-projetos-desenvolvimento': 'Projetos de Desenvolvimento',
        'ativos-intangiveis-programas-computador': 'Programas de Computador',
        'ativos-intangiveis-propriedade-industrial': 'Propriedade Industrial',
        'ativos-intangiveis-outros': 'Outros Ativos Intangíveis',
        'imported_items': 'Itens Importados'
    };
    return sheetNames[sheetKey] || sheetKey;
}

// Equipment Management Functions
let selectedEquipmentRow = null;
let currentEquipmentSheet = null;
let equipmentLoadTimeout = null;
let pendingEquipmentLoads = new Set();

function setupEquipmentActions(dataKey) {
    try {
        // Update current sheet FIRST to prevent race conditions
        currentEquipmentSheet = dataKey;
        
        // Reset button states
        const btnEdit = document.getElementById('btn-edit-equipment');
        const btnDelete = document.getElementById('btn-delete-equipment');
        if (btnEdit) btnEdit.disabled = true;
        if (btnDelete) btnDelete.disabled = true;
        selectedEquipmentRow = null;
        
        // Add click handlers to equipment rows
        document.querySelectorAll('.equipment-row').forEach(row => {
            // Skip empty rows
            if (row.classList.contains('empty-row')) return;
            
            row.addEventListener('click', (e) => {
                // Don't select if clicking on editable cell
                if (e.target.classList.contains('equipment-value-cell') && e.target.isContentEditable) {
                    return;
                }
                
                // Remove previous selection
                document.querySelectorAll('.equipment-row').forEach(r => {
                    r.classList.remove('selected');
                    r.style.backgroundColor = '';
                });
                
                // Select current row
                row.classList.add('selected');
                row.style.backgroundColor = '#E3F2FD';
                selectedEquipmentRow = row;
                
                // Enable edit and delete buttons
                if (btnEdit) btnEdit.disabled = false;
                if (btnDelete) btnDelete.disabled = false;
            });
        });
    } catch (error) {
        console.error('Error in setupEquipmentActions:', error);
    }
}

function setupEquipmentModal() {
    const modal = document.getElementById('modal-equipment');
    const form = document.getElementById('form-equipment');
    const btnClose = document.getElementById('btn-close-equipment-modal');
    const btnCancel = document.getElementById('btn-cancel-equipment');
    
    // Close modal
    function closeModal() {
        modal.classList.add('hidden');
        form.reset();
        selectedEquipmentRow = null;
    }
    
    if (btnClose) btnClose.addEventListener('click', closeModal);
    if (btnCancel) btnCancel.addEventListener('click', closeModal);
    
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    
    // Populate years in modal
    function populateYears() {
        const container = document.getElementById('equipment-years-container');
        container.innerHTML = '';
        
        const numAnos = projectConfig.numAnos || 5;
        const primeiroAno = projectConfig.primeiroAno || 2022;
        
        for (let i = 1; i <= numAnos; i++) {
            const year = primeiroAno + i;
            const div = document.createElement('div');
            div.innerHTML = `
                <label for="equipment-year-${year}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    ${year}
                </label>
                <input type="text" id="equipment-year-${year}" name="equipment-year-${year}"
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white"
                    placeholder="0,00" value="0,00">
            `;
            container.appendChild(div);
        }
    }
    
    // Form submit
    if (form) {
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const equipmentName = document.getElementById('equipment-name').value.trim();
            const ano0 = document.getElementById('equipment-ano0').value.trim();
            
            if (!equipmentName) {
                alert('Por favor, preencha a identificação do equipamento.');
                return;
            }
            
            // Get year values
            const numAnos = projectConfig.numAnos || 5;
            const primeiroAno = projectConfig.primeiroAno || 2022;
            const values = [equipmentName, ano0];
            const yearValues = {};
            
            for (let i = 1; i <= numAnos; i++) {
                const year = primeiroAno + i;
                const yearValue = document.getElementById(`equipment-year-${year}`).value.trim() || '0,00';
                values.push(yearValue);
                yearValues[year.toString()] = yearValue;
            }
            
            // Add or update equipment
            const data = spreadsheetData[currentEquipmentSheet];
            if (!data) return;
            
            if (selectedEquipmentRow) {
                // Edit existing
                const rowIndex = parseInt(selectedEquipmentRow.getAttribute('data-row-index'));
                data.rows[rowIndex] = values;
                
                // Get equipment ID from row
                const equipmentId = selectedEquipmentRow.getAttribute('data-equipment-id');
                if (equipmentId && equipmentId.startsWith('equipment-')) {
                    // This is a temporary ID, need to find the real one
                    // For now, we'll update via bulk save
                    saveEquipmentToBackend(currentEquipmentSheet);
                } else if (equipmentId) {
                    // Update existing equipment in backend
                    updateEquipmentInBackend(parseInt(equipmentId), equipmentName, ano0, yearValues);
                }
            } else {
                // Add new
                if (!data.rows) data.rows = [];
                data.rows.push(values);
                
                // Save new equipment to backend
                saveEquipmentToBackend(currentEquipmentSheet);
            }
            
            // Recreate spreadsheet
            createSpreadsheet(currentEquipmentSheet);
            
            // Update investment summary in real-time
            updateInvestmentSummary();
            
            closeModal();
        });
    }
    
    // Store populate function globally
    window.populateEquipmentYears = populateYears;
}

function setupEquipmentButtons() {
    const btnAdd = document.getElementById('btn-add-equipment');
    const btnEdit = document.getElementById('btn-edit-equipment');
    const btnDelete = document.getElementById('btn-delete-equipment');
    
    if (btnAdd) {
        btnAdd.addEventListener('click', () => {
            selectedEquipmentRow = null;
            document.getElementById('modal-equipment-title').textContent = 'Adicionar Equipamento';
            document.getElementById('form-equipment').reset();
            if (window.populateEquipmentYears) {
                window.populateEquipmentYears();
            }
            document.getElementById('modal-equipment').classList.remove('hidden');
        });
    }
    
    if (btnEdit) {
        btnEdit.addEventListener('click', () => {
            if (!selectedEquipmentRow) return;
            
            const rowIndex = parseInt(selectedEquipmentRow.getAttribute('data-row-index'));
            const data = spreadsheetData[currentEquipmentSheet];
            if (!data || !data.rows[rowIndex]) return;
            
            const row = data.rows[rowIndex];
            document.getElementById('modal-equipment-title').textContent = 'Editar Equipamento';
            document.getElementById('equipment-name').value = row[0] || '';
            document.getElementById('equipment-ano0').value = row[1] || '0,00';
            
            // Populate years
            if (window.populateEquipmentYears) {
                window.populateEquipmentYears();
            }
            const numAnos = projectConfig.numAnos || 5;
            const primeiroAno = projectConfig.primeiroAno || 2022;
            
            // Wait a bit for DOM to update
            setTimeout(() => {
                for (let i = 1; i <= numAnos; i++) {
                    const year = primeiroAno + i;
                    const value = row[i + 1] || '0,00';
                    const yearInput = document.getElementById(`equipment-year-${year}`);
                    if (yearInput) {
                        yearInput.value = value;
                    }
                }
            }, 50);
            
            document.getElementById('modal-equipment').classList.remove('hidden');
        });
    }
    
    if (btnDelete) {
        btnDelete.addEventListener('click', () => {
            if (!selectedEquipmentRow) return;
            
            if (!confirm('Tem certeza que deseja excluir este equipamento?')) return;
            
            const rowIndex = parseInt(selectedEquipmentRow.getAttribute('data-row-index'));
            const data = spreadsheetData[currentEquipmentSheet];
            if (!data || !data.rows) return;
            
            const equipmentId = selectedEquipmentRow.getAttribute('data-equipment-id');
            
            data.rows.splice(rowIndex, 1);
            
            if (equipmentId && !equipmentId.startsWith('equipment-') && equipmentId !== '') {
                deleteEquipmentFromBackend(parseInt(equipmentId));
            } else {
                saveEquipmentToBackend(currentEquipmentSheet);
            }
            
            createSpreadsheet(currentEquipmentSheet);
            
            // Update investment/depreciation summary in real-time
            if (currentEquipmentSheet.startsWith('depreciacoes-')) {
                updateDepreciationSummary();
            } else {
                updateInvestmentSummary();
            }
            
            document.getElementById('btn-edit-equipment').disabled = true;
            document.getElementById('btn-delete-equipment').disabled = true;
        });
    }
}

function setupExportExcel() {
    const btnExport = document.getElementById('btn-export-excel');
    if (btnExport) {
        btnExport.addEventListener('click', () => {
            const table = document.querySelector('.spreadsheet-table');
            if (!table) return;
            
            // Create CSV content
            let csv = '';
            const rows = table.querySelectorAll('tr');
            
            rows.forEach(row => {
                const cols = row.querySelectorAll('th, td');
                const rowData = Array.from(cols).map(col => {
                    let text = col.textContent.trim();
                    // Escape quotes and wrap in quotes if contains comma
                    if (text.includes(',') || text.includes('"')) {
                        text = '"' + text.replace(/"/g, '""') + '"';
                    }
                    return text;
                });
                csv += rowData.join(',') + '\n';
            });
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${currentEquipmentSheet || 'spreadsheet'}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    }
}

function setupPrint() {
    const btnPrint = document.getElementById('btn-print');
    if (btnPrint) {
        btnPrint.addEventListener('click', () => {
            window.print();
        });
    }
}

// Backend integration functions for equipment
async function loadEquipmentFromBackend(sheetKey) {
    try {
        // Check if we're still on the same sheet
        if (currentEquipmentSheet !== sheetKey) {
            console.log(`Sheet changed from ${sheetKey} to ${currentEquipmentSheet}, cancelling load`);
            return;
        }
        
        // Mark this load as pending
        pendingEquipmentLoads.add(sheetKey);
        
        if (!projectConfig || !projectConfig.id) {
            console.log('No project ID available, skipping equipment load');
            pendingEquipmentLoads.delete(sheetKey);
            return;
        }
        
        const projectId = projectConfig.id;
        
        const response = await fetch(`/api/equipment/${projectId}/${sheetKey}`);
        
        // Check again if we're still on the same sheet after fetch
        if (currentEquipmentSheet !== sheetKey) {
            console.log(`Sheet changed during fetch, cancelling load`);
            pendingEquipmentLoads.delete(sheetKey);
            return;
        }
        
        if (!response.ok) {
            if (response.status === 404) {
                // No equipment found, clear rows for this sheet
                const data = spreadsheetData[sheetKey];
                if (data && currentEquipmentSheet === sheetKey) {
                    data.rows = [];
                    createSpreadsheet(sheetKey);
                }
                pendingEquipmentLoads.delete(sheetKey);
                return;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        // Final check before applying data
        if (currentEquipmentSheet !== sheetKey) {
            console.log(`Sheet changed before applying data, cancelling`);
            pendingEquipmentLoads.delete(sheetKey);
            return;
        }
        
        if (result.success && result.equipment) {
            const data = spreadsheetData[sheetKey];
            if (!data) {
                pendingEquipmentLoads.delete(sheetKey);
                return;
            }
            
            // Only update if we're still on the same sheet
            if (currentEquipmentSheet === sheetKey) {
                data.rows = result.equipment.map(eq => {
                    const row = [eq.equipmentName, eq.ano0];
                    const numAnos = projectConfig.numAnos || 5;
                    const primeiroAno = projectConfig.primeiroAno || 2022;
                    
                    for (let i = 1; i <= numAnos; i++) {
                        const year = primeiroAno + i;
                        const value = eq.yearValues && eq.yearValues[year.toString()] ? eq.yearValues[year.toString()] : '0,00';
                        row.push(value);
                    }
                    
                    row.equipmentId = eq.id;
                    return row;
                });
                
                // Only recreate spreadsheet if we're still on the same sheet
                if (currentEquipmentSheet === sheetKey) {
                    createSpreadsheet(sheetKey);
                    // Update investment/depreciation summary
                    if (sheetKey.startsWith('depreciacoes-')) {
                        updateDepreciationSummary();
                    } else {
                        updateInvestmentSummary();
                    }
                }
            }
        } else if (result.success && (!result.equipment || result.equipment.length === 0)) {
            // No equipment found, clear rows
            const data = spreadsheetData[sheetKey];
            if (data && currentEquipmentSheet === sheetKey) {
                data.rows = [];
                createSpreadsheet(sheetKey);
                // Update investment/depreciation summary
                if (sheetKey.startsWith('depreciacoes-')) {
                    updateDepreciationSummary();
                } else {
                    updateInvestmentSummary();
                }
            }
        }
        
        pendingEquipmentLoads.delete(sheetKey);
    } catch (error) {
        console.error('Error loading equipment from backend:', error);
        pendingEquipmentLoads.delete(sheetKey);
    }
}

async function saveEquipmentToBackend(sheetKey) {
    try {
        const projectId = projectConfig.id;
        if (!projectId) {
            console.log('No project ID available, skipping equipment save');
            return;
        }
        
        const data = spreadsheetData[sheetKey];
        if (!data || !data.rows) return;
        
        const equipment = data.rows.map(row => {
            const numAnos = projectConfig.numAnos || 5;
            const primeiroAno = projectConfig.primeiroAno || 2022;
            const yearValues = {};
            
            for (let i = 1; i <= numAnos; i++) {
                const year = primeiroAno + i;
                const value = row[i + 1] || '0,00';
                yearValues[year.toString()] = value;
            }
            
            return {
                equipmentName: row[0] || '',
                ano0: row[1] || '0,00',
                yearValues: yearValues
            };
        });
        
        const response = await fetch(`/api/equipment/${projectId}/${sheetKey}/bulk`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ equipment })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        if (result.success && result.equipment && result.equipment.length === data.rows.length) {
            result.equipment.forEach((eq, index) => {
                if (data.rows[index]) {
                    data.rows[index].equipmentId = eq.id;
                }
            });
        }
    } catch (error) {
        console.error('Error saving equipment to backend:', error);
    }
}

async function updateEquipmentInBackend(equipmentId, equipmentName, ano0, yearValues) {
    try {
        const response = await fetch(`/api/equipment/${equipmentId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                equipmentName,
                ano0,
                yearValues
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
    } catch (error) {
        console.error('Error updating equipment in backend:', error);
        saveEquipmentToBackend(currentEquipmentSheet);
    }
}

async function deleteEquipmentFromBackend(equipmentId) {
    try {
        const response = await fetch(`/api/equipment/${equipmentId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
    } catch (error) {
        console.error('Error deleting equipment from backend:', error);
        saveEquipmentToBackend(currentEquipmentSheet);
    }
}
</script>

</body>
</html>